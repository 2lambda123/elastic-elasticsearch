pr: 44264
issues:
  - 41731
  - 41731
  - 21830
  - 44230
area: Infra/Resiliency
type: breaking, bug
summary: Fail node containing ancient closed index
versions:
  - v8.0.0
breaking:
  notable: false
  title: Fail node containing ancient closed index
  anchor: fail_node_containing_ancient_closed_index
  body: >-
    Today we fail the node at startup if it contains an index that is too old to
    becompatible with the current version, unless that index is closed. If the
    indexis closed then the node will start up and this puts us into a bad
    state: theindex cannot be opened and must be reindexed using an earlier
    version, but weoffer no way to get that index into a node running an earlier
    version so thatit can be reindexed. Downgrading the node in-place is
    decidedly unsupported andcannot be expected to work since the node already
    started up and upgraded therest of its metadata. Since #41731 we actively
    reject downgrades to versions â‰¥v7.2.0 too.

    This commit prevents the node from starting in the presence of any too-oldindices (closed or not). In particular, it does not write any upgraded metadatain this situation, increasing the chances an in-place downgrade might besuccessful. We still actively reject the downgrade using #41731, because wewrote the node metadata file before checking the index metadata, but at leastthere is a way to override this check.

    Relates #21830, #44230
