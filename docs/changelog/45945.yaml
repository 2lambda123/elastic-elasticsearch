pr: 45945
issues: []
area: Infra/REST API
type: breaking-java, enhancement
summary: Copy http headers to `ThreadContext` strictly
versions:
  - v8.0.0
breaking:
  notable: false
  title: Copy http headers to `ThreadContext` strictly
  anchor: copy_http_headers_to_threadcontext_strictly
  body: >-
    Previous behavior while copying HTTP headers to the ThreadContext,would
    allow multiple HTTP headers with the same name, handling onlythe first
    occurrence and disregarding the rest of the values. Thiscan be confusing
    when dealing with multiple Headers as it is notobvious which value is read
    and which ones are silently dropped.

    According to RFC-7230, a client must not send multiple header fieldswith the same field name in a HTTP message, unless the entire fieldvalue for this header is defined as a comma separated list or thisspecific header is a well-known exception.

    This commits changes the behavior in order to be more compliant tothe aforementioned RFC by requiring the classes that implementActionPlugin to declare if a header can be multi-valued or not whenregistering this header to be copied over to the ThreadContext inActionPlugin#getRestHeaders.If the header is allowed to be multivalued, then all such headersare read from the HTTP request and their values get concatenated ina comma-separated string.If the header is not allowed to be multivalued, and the HTTPrequest contains multiple such Headers with different values, therequest is rejected with a 400 status.
