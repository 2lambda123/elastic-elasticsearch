pr: 45945
issues: []
area: Infra/REST API
type: breaking-java, enhancement
summary: Copy http headers to `ThreadContext` strictly
versions:
  - v8.0.0
breaking:
  notable: false
  title: Copy http headers to `ThreadContext` strictly
  anchor: copy_http_headers_to_threadcontext_strictly
  body: |-
    Previous behavior while copying HTTP headers to the ThreadContext,
    would allow multiple HTTP headers with the same name, handling only
    the first occurrence and disregarding the rest of the values. This
    can be confusing when dealing with multiple Headers as it is not
    obvious which value is read and which ones are silently dropped.
    According to RFC-7230, a client must not send multiple header fields
    with the same field name in a HTTP message, unless the entire field
    value for this header is defined as a comma separated list or this
    specific header is a well-known exception.
    This commits changes the behavior in order to be more compliant to
    the aforementioned RFC by requiring the classes that implement
    ActionPlugin to declare if a header can be multi-valued or not when
    registering this header to be copied over to the ThreadContext in
    ActionPlugin#getRestHeaders.
    If the header is allowed to be multivalued, then all such headers
    are read from the HTTP request and their values get concatenated in
    a comma-separated string.
    If the header is not allowed to be multivalued, and the HTTP
    request contains multiple such Headers with different values, the
    request is rejected with a 400 status.
