---
"line_13":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup exams

  - do:
        indices.create:
          index: exams
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
            mappings:
              properties:
                grade:
                  type: byte
  - do:
        bulk:
          index: exams
          refresh: true
          body: |
            {"index":{}}
            {"grade": 100, "weight": 2}
            {"index":{}}
            {"grade": 50, "weight": 3}
  - do:
      raw:
        method: POST
        path: "exams/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "avg_grade": { "avg": { "field": "grade" } }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
          "aggregations": {
            "avg_grade": {
              "value": 75.0
            }
          }
        }
---
"line_45":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup exams

  - do:
        indices.create:
          index: exams
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
            mappings:
              properties:
                grade:
                  type: byte
  - do:
        bulk:
          index: exams
          refresh: true
          body: |
            {"index":{}}
            {"grade": 100, "weight": 2}
            {"index":{}}
            {"grade": 50, "weight": 3}
  - do:
      raw:
        method: POST
        path: "exams/_search"
        size: "0"
        filter_path: "aggregations"
        body: |
          {
            "runtime_mappings": {
              "grade.corrected": {
                "type": "double",
                "script": {
                  "source": "emit(Math.min(100, doc['grade'].value * params.correction))",
                  "params": {
                    "correction": 1.2
                  }
                }
              }
            },
            "aggs": {
              "avg_corrected_grade": {
                "avg": {
                  "field": "grade.corrected"
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "avg_corrected_grade": {
              "value": 80.0
            }
          }
        }
---
"line_92":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup exams

  - do:
        indices.create:
          index: exams
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
            mappings:
              properties:
                grade:
                  type: byte
  - do:
        bulk:
          index: exams
          refresh: true
          body: |
            {"index":{}}
            {"grade": 100, "weight": 2}
            {"index":{}}
            {"grade": 50, "weight": 3}
  - do:
      raw:
        method: POST
        path: "exams/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "grade_avg": {
                "avg": {
                  "field": "grade",
                  "missing": 10
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_118":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "metrics_index/_doc/1"
        body: |
          {
            "network.name" : "net-1",
            "latency_histo" : {
                "values" : [0.1, 0.2, 0.3, 0.4, 0.5],
                "counts" : [3, 7, 23, 12, 6]
             }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "metrics_index/_doc/2"
        body: |
          {
            "network.name" : "net-2",
            "latency_histo" : {
                "values" :  [0.1, 0.2, 0.3, 0.4, 0.5],
                "counts" : [8, 17, 8, 7, 6]
             }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "metrics_index/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "avg_latency":
                { "avg": { "field": "latency_histo" }
              }
            }
          }
  - is_false: _shards.failures
