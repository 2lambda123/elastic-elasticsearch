---
"line_24":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup messages

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            {"index":{"_id": "0"}}
            {"message": "trying out Elasticsearch", "context": "foo"}
            {"index":{"_id": "1"}}
            {"message": "some message with the number 1", "context": "bar"}
            {"index":{"_id": "2"}}
            {"message": "some message with the number 2", "context": "bar"}
            {"index":{"_id": "3"}}
            {"message": "some message with the number 3", "context": "bar"}
            {"index":{"_id": "4"}}
            {"message": "some message with the number 4", "context": "bar"}

  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "message_stats": { "string_stats": { "field": "message.keyword" } }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
        
          "aggregations": {
            "message_stats": {
              "count": 5,
              "min_length": 24,
              "max_length": 30,
              "avg_length": 28.8,
              "entropy": 3.94617750050791
            }
          }
        }
---
"line_65":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup messages

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            {"index":{"_id": "0"}}
            {"message": "trying out Elasticsearch", "context": "foo"}
            {"index":{"_id": "1"}}
            {"message": "some message with the number 1", "context": "bar"}
            {"index":{"_id": "2"}}
            {"message": "some message with the number 2", "context": "bar"}
            {"index":{"_id": "3"}}
            {"message": "some message with the number 3", "context": "bar"}
            {"index":{"_id": "4"}}
            {"message": "some message with the number 4", "context": "bar"}

  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "message_stats": {
                "string_stats": {
                  "field": "message.keyword",
                  "show_distribution": true
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
        
          "aggregations": {
            "message_stats": {
              "count": 5,
              "min_length": 24,
              "max_length": 30,
              "avg_length": 28.8,
              "entropy": 3.94617750050791,
              "distribution": {
                " ": 0.1527777777777778,
                "e": 0.14583333333333334,
                "s": 0.09722222222222222,
                "m": 0.08333333333333333,
                "t": 0.0763888888888889,
                "h": 0.0625,
                "a": 0.041666666666666664,
                "i": 0.041666666666666664,
                "r": 0.041666666666666664,
                "g": 0.034722222222222224,
                "n": 0.034722222222222224,
                "o": 0.034722222222222224,
                "u": 0.034722222222222224,
                "b": 0.027777777777777776,
                "w": 0.027777777777777776,
                "c": 0.013888888888888888,
                "E": 0.006944444444444444,
                "l": 0.006944444444444444,
                "1": 0.006944444444444444,
                "2": 0.006944444444444444,
                "3": 0.006944444444444444,
                "4": 0.006944444444444444,
                "y": 0.006944444444444444
              }
            }
          }
        }
---
"line_133":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup messages

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            {"index":{"_id": "0"}}
            {"message": "trying out Elasticsearch", "context": "foo"}
            {"index":{"_id": "1"}}
            {"message": "some message with the number 1", "context": "bar"}
            {"index":{"_id": "2"}}
            {"message": "some message with the number 2", "context": "bar"}
            {"index":{"_id": "3"}}
            {"message": "some message with the number 3", "context": "bar"}
            {"index":{"_id": "4"}}
            {"message": "some message with the number 4", "context": "bar"}

  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        filter_path: "aggregations"
        body: |
          {
            "size": 0,
            "runtime_mappings": {
              "message_and_context": {
                "type": "keyword",
                "script": "\n        emit(doc['message.keyword'].value + ' ' + doc['context.keyword'].value)\n      "
              }
            },
            "aggs": {
              "message_stats": {
                "string_stats": { "field": "message_and_context" }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "message_stats": {
              "count": 5,
              "min_length": 28,
              "max_length": 34,
              "avg_length": 32.8,
              "entropy": 3.9797778402765784
            }
          }
        }
---
"line_178":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup messages

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            {"index":{"_id": "0"}}
            {"message": "trying out Elasticsearch", "context": "foo"}
            {"index":{"_id": "1"}}
            {"message": "some message with the number 1", "context": "bar"}
            {"index":{"_id": "2"}}
            {"message": "some message with the number 2", "context": "bar"}
            {"index":{"_id": "3"}}
            {"message": "some message with the number 3", "context": "bar"}
            {"index":{"_id": "4"}}
            {"message": "some message with the number 4", "context": "bar"}

  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "message_stats": {
                "string_stats": {
                  "field": "message.keyword",
                  "missing": "[empty message]"
                }
              }
            }
          }
  - is_false: _shards.failures
