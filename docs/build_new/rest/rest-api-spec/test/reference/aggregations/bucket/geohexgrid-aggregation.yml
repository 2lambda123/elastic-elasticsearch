---
"geohexgrid-aggregation-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "museums"
        body: |
          {
            "mappings": {
              "properties": {
                "location": {
                  "type": "geo_point"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "museums/_bulk"
        refresh: ""
        body: |
          {"index":{"_id":1}}
          {"location": "POINT (4.912350 52.374081)", "name": "NEMO Science Museum"}
          {"index":{"_id":2}}
          {"location": "POINT (4.901618 52.369219)", "name": "Museum Het Rembrandthuis"}
          {"index":{"_id":3}}
          {"location": "POINT (4.914722 52.371667)", "name": "Nederlands Scheepvaartmuseum"}
          {"index":{"_id":4}}
          {"location": "POINT (4.405200 51.222900)", "name": "Letterenhuis"}
          {"index":{"_id":5}}
          {"location": "POINT (2.336389 48.861111)", "name": "Musée du Louvre"}
          {"index":{"_id":6}}
          {"location": "POINT (2.327000 48.860000)", "name": "Musée d'Orsay"}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "museums/_search"
        size: "0"
        body: |
          {
            "aggregations": {
              "large-grid": {
                "geohex_grid": {
                  "field": "location",
                  "precision": 4
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"_shards": $body._shards,"hits":$body.hits,"timed_out":false,
          "aggregations": {
            "large-grid": {
              "buckets": [
                {
                  "key": "841969dffffffff",
                  "doc_count": 3
                },
                {
                  "key": "841fb47ffffffff",
                  "doc_count": 2
                },
                {
                  "key": "841fa4dffffffff",
                  "doc_count": 1
                }
              ]
            }
          }
        }
  - do:
      raw:
        method: POST
        path: "museums/_search"
        size: "0"
        body: |
          {
            "aggregations": {
              "zoomed-in": {
                "filter": {
                  "geo_bounding_box": {
                    "location": {
                      "top_left": "POINT (4.9 52.4)",
                      "bottom_right": "POINT (5.0 52.3)"
                    }
                  }
                },
                "aggregations": {
                  "zoom1": {
                    "geohex_grid": {
                      "field": "location",
                      "precision": 12
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"_shards": $body._shards,"hits":$body.hits,"timed_out":false,
          "aggregations": {
            "zoomed-in": {
              "doc_count": 3,
              "zoom1": {
                "buckets": [
                  {
                    "key": "8c1969c9b2617ff",
                    "doc_count": 1
                  },
                  {
                    "key": "8c1969526d753ff",
                    "doc_count": 1
                  },
                  {
                    "key": "8c1969526d26dff",
                    "doc_count": 1
                  }
                ]
              }
            }
          }
        }
  - do:
      raw:
        method: POST
        path: "museums/_search"
        size: "0"
        body: |
          {
            "aggregations": {
              "tiles-in-bounds": {
                "geohex_grid": {
                  "field": "location",
                  "precision": 12,
                  "bounds": {
                    "top_left": "POINT (4.9 52.4)",
                    "bottom_right": "POINT (5.0 52.3)"
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"_shards": $body._shards,"hits":$body.hits,"timed_out":false,
          "aggregations": {
            "tiles-in-bounds": {
              "buckets": [
                {
                  "key": "8c1969c9b2617ff",
                  "doc_count": 1
                },
                {
                  "key": "8c1969526d753ff",
                  "doc_count": 1
                },
                {
                  "key": "8c1969526d26dff",
                  "doc_count": 1
                }
              ]
            }
          }
        }
