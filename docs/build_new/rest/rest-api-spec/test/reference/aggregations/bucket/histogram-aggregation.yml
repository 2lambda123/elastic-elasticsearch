---
"histogram-aggregation-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "prices": {
                "histogram": {
                  "field": "price",
                  "interval": 50
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
          "aggregations": {
            "prices": {
              "buckets": [
                {
                  "key": 0.0,
                  "doc_count": 1
                },
                {
                  "key": 50.0,
                  "doc_count": 1
                },
                {
                  "key": 100.0,
                  "doc_count": 0
                },
                {
                  "key": 150.0,
                  "doc_count": 2
                },
                {
                  "key": 200.0,
                  "doc_count": 3
                }
              ]
            }
          }
        }
---
"histogram-aggregation-min-doc-count-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "prices": {
                "histogram": {
                  "field": "price",
                  "interval": 50,
                  "min_doc_count": 1
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
          "aggregations": {
            "prices": {
              "buckets": [
                {
                  "key": 0.0,
                  "doc_count": 1
                },
                {
                  "key": 50.0,
                  "doc_count": 1
                },
                {
                  "key": 150.0,
                  "doc_count": 2
                },
                {
                  "key": 200.0,
                  "doc_count": 3
                }
              ]
            }
          }
        }
---
"histogram-aggregation-extended-bounds-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        body: |
          {
            "query": {
              "constant_score": { "filter": { "range": { "price": { "to": "500" } } } }
            },
            "aggs": {
              "prices": {
                "histogram": {
                  "field": "price",
                  "interval": 50,
                  "extended_bounds": {
                    "min": 0,
                    "max": 500
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"histogram-aggregation-hard-bounds-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        body: |
          {
            "query": {
              "constant_score": { "filter": { "range": { "price": { "to": "500" } } } }
            },
            "aggs": {
              "prices": {
                "histogram": {
                  "field": "price",
                  "interval": 50,
                  "hard_bounds": {
                    "min": 100,
                    "max": 200
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"histogram-aggregation-keyed-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "prices": {
                "histogram": {
                  "field": "price",
                  "interval": 50,
                  "keyed": true
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
          "aggregations": {
            "prices": {
              "buckets": {
                "0.0": {
                  "key": 0.0,
                  "doc_count": 1
                },
                "50.0": {
                  "key": 50.0,
                  "doc_count": 1
                },
                "100.0": {
                  "key": 100.0,
                  "doc_count": 0
                },
                "150.0": {
                  "key": 150.0,
                  "doc_count": 2
                },
                "200.0": {
                  "key": 200.0,
                  "doc_count": 3
                }
              }
            }
          }
        }
---
"histogram-aggregation-missing-value-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "quantity": {
                "histogram": {
                  "field": "quantity",
                  "interval": 10,
                  "missing": 0
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_334":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "metrics_index"
        body: |
          {
            "mappings": {
              "properties": {
                "network": {
                  "properties": {
                    "name": {
                      "type": "keyword"
                    }
                  }
                },
                "latency_histo": {
                   "type": "histogram"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "metrics_index/_doc/1"
        refresh: ""
        body: |
          {
            "network.name" : "net-1",
            "latency_histo" : {
                "values" : [1, 3, 8, 12, 15],
                "counts" : [3, 7, 23, 12, 6]
             }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "metrics_index/_doc/2"
        refresh: ""
        body: |
          {
            "network.name" : "net-2",
            "latency_histo" : {
                "values" : [1, 6, 8, 12, 14],
                "counts" : [8, 17, 8, 7, 6]
             }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "metrics_index/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "latency_buckets": {
                "histogram": {
                  "field": "latency_histo",
                  "interval": 5
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
          "aggregations": {
            "latency_buckets": {
              "buckets": [
                {
                  "key": 0.0,
                  "doc_count": 18
                },
                {
                  "key": 5.0,
                  "doc_count": 48
                },
                {
                  "key": 10.0,
                  "doc_count": 25
                },
                {
                  "key": 15.0,
                  "doc_count": 6
                }
              ]
            }
          }
        }
