---
setup:
  - do:
      raw:
        method: PUT
        path: "network-traffic"
        body: |
          {
              "mappings": {
                  "properties": {
                      "ipv4": { "type": "ip" },
                      "ipv6": { "type": "ip" }
                  }
              }
          }
  - do:
      raw:
        method: POST
        path: "network-traffic/_bulk"
        refresh: ""
        body: |
          {"index":{"_id":0}}
          {"ipv4":"192.168.1.10","ipv6":"2001:db8:a4f8:112a:6001:0:12:7f10"}
          {"index":{"_id":1}}
          {"ipv4":"192.168.1.12","ipv6":"2001:db8:a4f8:112a:6001:0:12:7f12"}
          {"index":{"_id":2}}
          { "ipv4":"192.168.1.33","ipv6":"2001:db8:a4f8:112a:6001:0:12:7f33"}
          {"index":{"_id":3}}
          {"ipv4":"192.168.1.10","ipv6":"2001:db8:a4f8:112a:6001:0:12:7f10"}
          {"index":{"_id":4}}
          {"ipv4":"192.168.2.41","ipv6":"2001:db8:a4f8:112c:6001:0:12:7f41"}
          {"index":{"_id":5}}
          {"ipv4":"192.168.2.10","ipv6":"2001:db8:a4f8:112c:6001:0:12:7f10"}
          {"index":{"_id":6}}
          {"ipv4":"192.168.2.23","ipv6":"2001:db8:a4f8:112c:6001:0:12:7f23"}
          {"index":{"_id":7}}
          {"ipv4":"192.168.3.201","ipv6":"2001:db8:a4f8:114f:6001:0:12:7201"}
          {"index":{"_id":8}}
          {"ipv4":"192.168.3.107","ipv6":"2001:db8:a4f8:114f:6001:0:12:7307"}
---
"ip-prefix-ipv4-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "network-traffic/_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "ipv4-subnets": {
                "ip_prefix": {
                  "field": "ipv4",
                  "prefix_length": 24
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
        
          "aggregations": {
            "ipv4-subnets": {
              "buckets": [
                {
                  "key": "192.168.1.0",
                  "is_ipv6": false,
                  "doc_count": 4,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                },
                {
                  "key": "192.168.2.0",
                  "is_ipv6": false,
                  "doc_count": 3,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                },
                {
                   "key": "192.168.3.0",
                   "is_ipv6": false,
                   "doc_count": 2,
                   "prefix_length": 24,
                   "netmask": "255.255.255.0"
                }
              ]
            }
          }
        }
---
"ip-prefix-ipv6-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "network-traffic/_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "ipv6-subnets": {
                "ip_prefix": {
                  "field": "ipv6",
                  "prefix_length": 64,
                  "is_ipv6": true
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
        
          "aggregations": {
            "ipv6-subnets": {
              "buckets": [
                {
                  "key": "2001:db8:a4f8:112a::",
                  "is_ipv6": true,
                  "doc_count": 4,
                  "prefix_length": 64
                },
                {
                  "key": "2001:db8:a4f8:112c::",
                  "is_ipv6": true,
                  "doc_count": 3,
                  "prefix_length": 64
                },
                {
                  "key": "2001:db8:a4f8:114f::",
                  "is_ipv6": true,
                  "doc_count": 2,
                  "prefix_length": 64
                }
              ]
            }
          }
        }
---
"ip-prefix-keyed-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "network-traffic/_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "ipv4-subnets": {
                "ip_prefix": {
                  "field": "ipv4",
                  "prefix_length": 24,
                  "keyed": true
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
        
          "aggregations": {
            "ipv4-subnets": {
              "buckets": {
                "192.168.1.0": {
                  "is_ipv6": false,
                  "doc_count": 4,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                },
                "192.168.2.0": {
                  "is_ipv6": false,
                  "doc_count": 3,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                },
                "192.168.3.0": {
                  "is_ipv6": false,
                  "doc_count": 2,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                }
              }
            }
          }
        }
---
"ip-prefix-append-prefix-len-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "network-traffic/_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "ipv4-subnets": {
                "ip_prefix": {
                  "field": "ipv4",
                  "prefix_length": 24,
                  "append_prefix_length": true
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
        
          "aggregations": {
            "ipv4-subnets": {
              "buckets": [
                {
                  "key": "192.168.1.0/24",
                  "is_ipv6": false,
                  "doc_count": 4,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                },
                {
                  "key": "192.168.2.0/24",
                  "is_ipv6": false,
                  "doc_count": 3,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                },
                {
                  "key": "192.168.3.0/24",
                  "is_ipv6": false,
                  "doc_count": 2,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                }
              ]
            }
          }
        }
---
"ip-prefix-min-doc-count-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "network-traffic/_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "ipv4-subnets": {
                "ip_prefix": {
                  "field": "ipv4",
                  "prefix_length": 24,
                  "min_doc_count": 3
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
        
          "aggregations": {
            "ipv4-subnets": {
              "buckets": [
                {
                  "key": "192.168.1.0",
                  "is_ipv6": false,
                  "doc_count": 4,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                },
                {
                  "key": "192.168.2.0",
                  "is_ipv6": false,
                  "doc_count": 3,
                  "prefix_length": 24,
                  "netmask": "255.255.255.0"
                }
              ]
            }
          }
        }
