---
"filters-aggregation-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "logs/_bulk"
        refresh: ""
        body: |
          { "index" : { "_id" : 1 } }
          { "body" : "warning: page could not be rendered" }
          { "index" : { "_id" : 2 } }
          { "body" : "authentication error" }
          { "index" : { "_id" : 3 } }
          { "body" : "warning: connection timed out" }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "logs/_search"
        body: |
          {
            "size": 0,
            "aggs" : {
              "messages" : {
                "filters" : {
                  "filters" : {
                    "errors" :   { "match" : { "body" : "error"   }},
                    "warnings" : { "match" : { "body" : "warning" }}
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out": false,
          "_shards": $body._shards,
          "hits": $body.hits,
          "aggregations": {
            "messages": {
              "buckets": {
                "errors": {
                  "doc_count": 1
                },
                "warnings": {
                  "doc_count": 2
                }
              }
            }
          }
        }
  - do:
      raw:
        method: GET
        path: "logs/_search"
        body: |
          {
            "size": 0,
            "aggs" : {
              "messages" : {
                "filters" : {
                  "filters" : [
                    { "match" : { "body" : "error"   }},
                    { "match" : { "body" : "warning" }}
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out": false,
          "_shards": $body._shards,
          "hits": $body.hits,
          "aggregations": {
            "messages": {
              "buckets": [
                {
                  "doc_count": 1
                },
                {
                  "doc_count": 2
                }
              ]
            }
          }
        }
  - do:
      raw:
        method: PUT
        path: "logs/_doc/4"
        refresh: ""
        body: |
          {
            "body": "info: user Bob logged out"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "logs/_search"
        body: |
          {
            "size": 0,
            "aggs" : {
              "messages" : {
                "filters" : {
                  "other_bucket_key": "other_messages",
                  "filters" : {
                    "errors" :   { "match" : { "body" : "error"   }},
                    "warnings" : { "match" : { "body" : "warning" }}
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out": false,
          "_shards": $body._shards,
          "hits": $body.hits,
          "aggregations": {
            "messages": {
              "buckets": {
                "errors": {
                  "doc_count": 1
                },
                "warnings": {
                  "doc_count": 2
                },
                "other_messages": {
                  "doc_count": 1
                }
              }
            }
          }
        }
---
"filters-aggregation-sortable-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "the_filter": {
                "filters": {
                  "keyed": false,
                  "filters": {
                    "t-shirt": { "term": { "type": "t-shirt" } },
                    "hat": { "term": { "type": "hat" } }
                  }
                },
                "aggs": {
                  "avg_price": { "avg": { "field": "price" } },
                  "sort_by_avg_price": {
                    "bucket_sort": { "sort": { "avg_price": "asc" } }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "the_filter": {
              "buckets": [
                {
                  "key": "t-shirt",
                  "doc_count": 3,
                  "avg_price": { "value": 128.33333333333334 }
                },
                {
                  "key": "hat",
                  "doc_count": 3,
                  "avg_price": { "value": 150.0 }
                }
              ]
            }
          }
        }
