---
setup:
# Named setup remote_cluster_and_leader_index

  # Fetch the http host. We use the host of the master because we know there will always be a master.
  - do:
      cluster.state: {}
  - set: { master_node: master }
  - do:
      nodes.info:
        metric: [ http, transport ]
  - set: {nodes.$master.http.publish_address: host}
  - set: {nodes.$master.transport.publish_address: transport_host}

  - do:
      cluster.put_settings:
        body:
          persistent:
            cluster.remote.remote_cluster.seeds: $transport_host

  - do:
      indices.create:
        index: leader_index
        body:
          settings:
            index.number_of_replicas: 0
            index.number_of_shards: 1
            index.soft_deletes.enabled: true

  - do:
      raw:
        method: PUT
        path: "follower_index/_ccr/follow"
        wait_for_active_shards: "1"
        body: |
          {
            "remote_cluster" : "remote_cluster",
            "leader_index" : "leader_index"
          }
---
teardown:
  - do:
      raw:
        method: POST
        path: "follower_index/_ccr/pause_follow"
---
"line_35":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "follower_index/_ccr/stats"
  - is_false: _shards.failures
---
"line_219":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "follower_index/_ccr/stats"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "indices" : [
            {
              "index" : "follower_index",
              "total_global_checkpoint_lag" : 0,
              "shards" : [
                {
                  "remote_cluster" : "remote_cluster",
                  "leader_index" : "leader_index",
                  "follower_index" : "follower_index",
                  "shard_id" : 0,
                  "leader_global_checkpoint" : $body.indices.0.shards.0.leader_global_checkpoint,
                  "leader_max_seq_no" : $body.indices.0.shards.0.leader_max_seq_no,
                  "follower_global_checkpoint" : $body.indices.0.shards.0.follower_global_checkpoint,
                  "follower_max_seq_no" : $body.indices.0.shards.0.follower_max_seq_no,
                  "last_requested_seq_no" : $body.indices.0.shards.0.last_requested_seq_no,
                  "outstanding_read_requests" : $body.indices.0.shards.0.outstanding_read_requests,
                  "outstanding_write_requests" : $body.indices.0.shards.0.outstanding_write_requests,
                  "write_buffer_operation_count" : $body.indices.0.shards.0.write_buffer_operation_count,
                  "follower_mapping_version" : $body.indices.0.shards.0.follower_mapping_version,
                  "follower_settings_version" : $body.indices.0.shards.0.follower_settings_version,
                  "follower_aliases_version" : $body.indices.0.shards.0.follower_aliases_version,
                  "total_read_time_millis" : $body.indices.0.shards.0.total_read_time_millis,
                  "total_read_remote_exec_time_millis" : $body.indices.0.shards.0.total_read_remote_exec_time_millis,
                  "successful_read_requests" : $body.indices.0.shards.0.successful_read_requests,
                  "failed_read_requests" : $body.indices.0.shards.0.failed_read_requests,
                  "operations_read" : $body.indices.0.shards.0.operations_read,
                  "bytes_read" : $body.indices.0.shards.0.bytes_read,
                  "total_write_time_millis" : $body.indices.0.shards.0.total_write_time_millis,
                  "write_buffer_size_in_bytes" : $body.indices.0.shards.0.write_buffer_size_in_bytes,
                  "successful_write_requests" : $body.indices.0.shards.0.successful_write_requests,
                  "failed_write_requests" : $body.indices.0.shards.0.failed_write_requests,
                  "operations_written" : $body.indices.0.shards.0.operations_written,
                  "read_exceptions" : [ ],
                  "time_since_last_read_millis" : $body.indices.0.shards.0.time_since_last_read_millis
                }
              ]
            }
          ]
        }
