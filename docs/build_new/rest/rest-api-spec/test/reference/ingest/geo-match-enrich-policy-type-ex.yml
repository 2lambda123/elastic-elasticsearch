---
"line_17":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "postal_codes"
        body: |
          {
            "mappings": {
              "properties": {
                "location": {
                  "type": "geo_shape"
                },
                "postal_code": {
                  "type": "keyword"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "postal_codes/_doc/1"
        refresh: "wait_for"
        body: |
          {
            "location": {
              "type": "envelope",
              "coordinates": [ [ 13.0, 53.0 ], [ 14.0, 52.0 ] ]
            },
            "postal_code": "96598"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "_enrich/policy/postal_policy"
        body: |
          {
            "geo_match": {
              "indices": "postal_codes",
              "match_field": "location",
              "enrich_fields": [ "location", "postal_code" ]
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "_enrich/policy/postal_policy/_execute"
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "_ingest/pipeline/postal_lookup"
        body: |
          {
            "processors": [
              {
                "enrich": {
                  "description": "Add 'geo_data' based on 'geo_location'",
                  "policy_name": "postal_policy",
                  "field": "geo_location",
                  "target_field": "geo_data",
                  "shape_relation": "INTERSECTS"
                }
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "users/_doc/0"
        pipeline: "postal_lookup"
        body: |
          {
            "first_name": "Mardy",
            "last_name": "Brown",
            "geo_location": "POINT (13.5 52.5)"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "users/_doc/0"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "found": true,
          "_index": "users",
          "_id": "0",
          "_version": 1,
          "_seq_no" : $body._seq_no,
          "_primary_term": 1,
          "_source": {
            "geo_data": {
              "location": {
                "type": "envelope",
                "coordinates": [[13.0, 53.0], [14.0, 52.0]]
              },
              "postal_code": "96598"
            },
            "first_name": "Mardy",
            "last_name": "Brown",
            "geo_location": "POINT (13.5 52.5)"
          }
        }
  - do:
      raw:
        method: DELETE
        path: "_ingest/pipeline/postal_lookup"
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "_enrich/policy/postal_policy"
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "postal_codes"
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "users"
  - is_false: _shards.failures
