---
setup:
  - do:
      raw:
        method: POST
        path: "_security/user/king"
        body: |
          {
            "password" : "security-test-password",
            "roles": []
          }
  - do:
      raw:
        method: POST
        path: "_security/user/june"
        body: |
          {
            "password" : "security-test-password",
            "roles": []
          }
  - do:
      raw:
        method: POST
        path: "_security/api_key/grant"
        body: |
          {
            "grant_type": "password",
            "username" : "king",
            "password" : "security-test-password",
            "api_key" : {
              "name": "king-key-no-expire"
            }
          }
  - do:
      raw:
        method: DELETE
        path: "_security/api_key"
        body: |
          {
            "name" : "king-key-no-expire"
          }
  - do:
      raw:
        method: POST
        path: "_security/api_key/grant"
        body: |
          {
            "grant_type": "password",
            "username" : "king",
            "password" : "security-test-password",
            "api_key" : {
              "name": "king-key-10",
              "expiration": "10d"
            }
          }
  - do:
      raw:
        method: POST
        path: "_security/api_key/grant"
        body: |
          {
            "grant_type": "password",
            "username" : "king",
            "password" : "security-test-password",
            "api_key" : {
              "name": "king-key-100",
              "expiration": "100d"
            }
          }
  - do:
      raw:
        method: POST
        path: "_security/api_key/grant"
        body: |
          {
            "grant_type": "password",
            "username" : "june",
            "password" : "security-test-password",
            "api_key" : {
              "name": "june-key-no-expire"
            }
          }
  - do:
      raw:
        method: POST
        path: "_security/api_key/grant"
        body: |
          {
            "grant_type": "password",
            "username" : "june",
            "password" : "security-test-password",
            "api_key" : {
              "name": "june-key-10",
              "expiration": "10d"
            }
          }
  - do:
      raw:
        method: POST
        path: "_security/api_key/grant"
        body: |
          {
            "grant_type": "password",
            "username" : "june",
            "password" : "security-test-password",
            "api_key" : {
              "name": "june-key-100",
              "expiration": "100d"
            }
          }
  - do:
      raw:
        method: DELETE
        path: "_security/api_key"
        body: |
          {
            "name" : "june-key-100"
          }
---
teardown:
  - do:
      raw:
        method: DELETE
        path: "_security/user/king"
  - do:
      raw:
        method: DELETE
        path: "_security/user/june"
  - do:
      raw:
        method: DELETE
        path: "_security/api_key"
        body: |
          {
            "name" : "king-key-no-expire"
          }
  - do:
      raw:
        method: DELETE
        path: "_security/api_key"
        body: |
          {
            "name" : "king-key-10"
          }
  - do:
      raw:
        method: DELETE
        path: "_security/api_key"
        body: |
          {
            "name" : "king-key-100"
          }
  - do:
      raw:
        method: DELETE
        path: "_security/api_key"
        body: |
          {
            "name" : "june-key-no-expire"
          }
  - do:
      raw:
        method: DELETE
        path: "_security/api_key"
        body: |
          {
            "name" : "june-key-10"
          }
---
"line_290":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_security/_query/api_key"
  - is_false: _shards.failures
---
"line_368":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "_security/api_key"
        body: |
          {
            "name": "application-key-1",
            "metadata": { "application": "my-application"}
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "id": "$body.id",
          "name": "application-key-1",
          "api_key": "$body.api_key",
          "encoded": "$body.encoded"
        }
  - do:
      raw:
        method: GET
        path: "_security/_query/api_key"
        with_limited_by: "true"
        body: |
          {
            "query": {
              "ids": {
                "values": [
                  "$body.id"
                ]
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "_security/_query/api_key"
        body: |
          {
            "query": {
              "term": {
                "name": {
                  "value": "application-key-1"
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_608":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "_security/_query/api_key"
        body: |
          {
            "size": 0,
            "query": {
              "bool": {
                "must": {
                  "term": {
                    "invalidated": false
                  }
                },
                "should": [
                  {
                    "range": { "expiration": { "gte": "now" } }
                  },
                  {
                    "bool": { "must_not": { "exists": { "field": "expiration" } } }
                  }
                ],
                "minimum_should_match": 1
              }
            },
            "aggs": {
              "keys_by_username": {
                "composite": {
                  "sources": [ { "usernames": { "terms": { "field": "username" } } } ]
                },
                "aggs": {
                  "expires_soon": {
                    "filter": {
                      "range": { "expiration": { "lte": "now+30d/d" } }
                    },
                    "aggs": {
                      "key_names": { "terms": { "field": "name" } }
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "total" : 4,
          "count" : 0,
          "api_keys" : [ ],
          "aggregations" : {
            "keys_by_username" : {
              "after_key" : {
                "usernames" : "king"
              },
              "buckets" : [
                {
                  "key" : {
                    "usernames" : "june"
                  },
                  "doc_count" : 2,
                  "expires_soon" : {
                    "doc_count" : 1,
                    "key_names" : {
                      "doc_count_error_upper_bound" : 0,
                      "sum_other_doc_count" : 0,
                      "buckets" : [
                        {
                          "key" : "june-key-10",
                          "doc_count" : 1
                        }
                      ]
                    }
                  }
                },
                {
                  "key" : {
                    "usernames" : "king"
                  },
                  "doc_count" : 2,
                  "expires_soon" : {
                    "doc_count" : 1,
                    "key_names" : {
                      "doc_count_error_upper_bound" : 0,
                      "sum_other_doc_count" : 0,
                      "buckets" : [
                        {
                          "key" : "king-key-10",
                          "doc_count" : 1
                        }
                      ]
                    }
                  }
                }
              ]
            }
          }
        }
---
"line_724":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "_security/_query/api_key"
        body: |
          {
            "size": 0,
            "query": {
              "bool": {
                "filter": {
                  "term": {
                    "invalidated": true
                  }
                }
              }
            },
            "aggs": {
              "invalidated_keys": {
                "composite": {
                  "sources": [
                    { "username": { "terms": { "field": "username" } } },
                    { "key_name": { "terms": { "field": "name" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "total" : 2,
          "count" : 0,
          "api_keys" : [ ],
          "aggregations" : {
            "invalidated_keys" : {
              "after_key" : {
                "username" : "king",
                "key_name" : "king-key-no-expire"
              },
              "buckets" : [
                {
                  "key" : {
                    "username" : "june",
                    "key_name" : "june-key-100"
                  },
                  "doc_count" : 1
                },
                {
                  "key" : {
                    "username" : "king",
                    "key_name" : "king-key-no-expire"
                  },
                  "doc_count" : 1
                }
              ]
            }
          }
        }
