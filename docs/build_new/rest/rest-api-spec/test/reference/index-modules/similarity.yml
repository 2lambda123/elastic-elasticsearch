---
"line_22":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "index"
        body: |
          {
            "settings": {
              "index": {
                "similarity": {
                  "my_similarity": {
                    "type": "DFR",
                    "basic_model": "g",
                    "after_effect": "l",
                    "normalization": "h2",
                    "normalization.h2.c": "3.0"
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_mapping"
        body: |
          {
            "properties" : {
              "title" : { "type" : "text", "similarity" : "my_similarity" }
            }
          }
  - is_false: _shards.failures
---
"line_192":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "index"
        body: |
          {
            "settings": {
              "number_of_shards": 1,
              "similarity": {
                "scripted_tfidf": {
                  "type": "scripted",
                  "script": {
                    "source": "double tf = Math.sqrt(doc.freq); double idf = Math.log((field.docCount+1.0)/(term.docFreq+1.0)) + 1.0; double norm = 1/Math.sqrt(doc.length); return query.boost * tf * idf * norm;"
                  }
                }
              }
            },
            "mappings": {
              "properties": {
                "field": {
                  "type": "text",
                  "similarity": "scripted_tfidf"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_doc/1"
        body: |
          {
            "field": "foo bar foo"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_doc/2"
        body: |
          {
            "field": "bar baz"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "index/_refresh"
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "index/_search"
        explain: "true"
        body: |
          {
            "query": {
              "query_string": {
                "query": "foo^1.7",
                "default_field": "field"
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out": false,
          "_shards": {
            "total": 1,
            "successful": 1,
            "skipped": 0,
            "failed": 0
          },
          "hits": {
            "total": {
                "value": 1,
                "relation": "eq"
            },
            "max_score": 1.9508477,
            "hits": [
              {
                "_shard": "[index][0]",
                "_node": "$body.hits.hits.0._node",
                "_index": "index",
                "_id": "1",
                "_score": 1.9508477,
                "_source": {
                  "field": "foo bar foo"
                },
                "_explanation": {
                  "value": 1.9508477,
                  "description": "weight(field:foo in 0) [PerFieldSimilarity], result of:",
                  "details": [
                    {
                      "value": 1.9508477,
                      "description": "score from ScriptedSimilarity(weightScript=[null], script=[Script{type=inline, lang='painless', idOrCode='double tf = Math.sqrt(doc.freq); double idf = Math.log((field.docCount+1.0)/(term.docFreq+1.0)) + 1.0; double norm = 1/Math.sqrt(doc.length); return query.boost * tf * idf * norm;', options={}, params={}}]) computed from:",
                      "details": [
                        {
                          "value": 1.0,
                          "description": "weight",
                          "details": []
                        },
                        {
                          "value": 1.7,
                          "description": "query.boost",
                          "details": []
                        },
                        {
                          "value": 2,
                          "description": "field.docCount",
                          "details": []
                        },
                        {
                          "value": 4,
                          "description": "field.sumDocFreq",
                          "details": []
                        },
                        {
                          "value": 5,
                          "description": "field.sumTotalTermFreq",
                          "details": []
                        },
                        {
                          "value": 1,
                          "description": "term.docFreq",
                          "details": []
                        },
                        {
                          "value": 2,
                          "description": "term.totalTermFreq",
                          "details": []
                        },
                        {
                          "value": 2.0,
                          "description": "doc.freq",
                          "details": []
                        },
                        {
                          "value": 3,
                          "description": "doc.length",
                          "details": []
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          }
        }
---
"line_357":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "index"
        body: |
          {
            "settings": {
              "number_of_shards": 1,
              "similarity": {
                "scripted_tfidf": {
                  "type": "scripted",
                  "weight_script": {
                    "source": "double idf = Math.log((field.docCount+1.0)/(term.docFreq+1.0)) + 1.0; return query.boost * idf;"
                  },
                  "script": {
                    "source": "double tf = Math.sqrt(doc.freq); double norm = 1/Math.sqrt(doc.length); return weight * tf * norm;"
                  }
                }
              }
            },
            "mappings": {
              "properties": {
                "field": {
                  "type": "text",
                  "similarity": "scripted_tfidf"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_doc/1"
        body: |
          {
            "field": "foo bar foo"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_doc/2"
        body: |
          {
            "field": "bar baz"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "index/_refresh"
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "index/_search"
        explain: "true"
        body: |
          {
            "query": {
              "query_string": {
                "query": "foo^1.7",
                "default_field": "field"
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out": false,
          "_shards": {
            "total": 1,
            "successful": 1,
            "skipped": 0,
            "failed": 0
          },
          "hits": {
            "total": {
                "value": 1,
                "relation": "eq"
            },
            "max_score": 1.9508477,
            "hits": [
              {
                "_shard": "[index][0]",
                "_node": "$body.hits.hits.0._node",
                "_index": "index",
                "_id": "1",
                "_score": 1.9508477,
                "_source": {
                  "field": "foo bar foo"
                },
                "_explanation": {
                  "value": 1.9508477,
                  "description": "weight(field:foo in 0) [PerFieldSimilarity], result of:",
                  "details": [
                    {
                      "value": 1.9508477,
                      "description": "score from ScriptedSimilarity(weightScript=[Script{type=inline, lang='painless', idOrCode='double idf = Math.log((field.docCount+1.0)/(term.docFreq+1.0)) + 1.0; return query.boost * idf;', options={}, params={}}], script=[Script{type=inline, lang='painless', idOrCode='double tf = Math.sqrt(doc.freq); double norm = 1/Math.sqrt(doc.length); return weight * tf * norm;', options={}, params={}}]) computed from:",
                      "details": [
                        {
                          "value": 2.3892908,
                          "description": "weight",
                          "details": []
                        },
                        {
                          "value": 1.7,
                          "description": "query.boost",
                          "details": []
                        },
                        {
                          "value": 2,
                          "description": "field.docCount",
                          "details": []
                        },
                        {
                          "value": 4,
                          "description": "field.sumDocFreq",
                          "details": []
                        },
                        {
                          "value": 5,
                          "description": "field.sumTotalTermFreq",
                          "details": []
                        },
                        {
                          "value": 1,
                          "description": "term.docFreq",
                          "details": []
                        },
                        {
                          "value": 2,
                          "description": "term.totalTermFreq",
                          "details": []
                        },
                        {
                          "value": 2.0,
                          "description": "doc.freq",
                          "details": []
                        },
                        {
                          "value": 3,
                          "description": "doc.length",
                          "details": []
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          }
        }
---
"line_520":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "index"
        body: |
          {
            "settings": {
              "index": {
                "similarity": {
                  "default": {
                    "type": "boolean"
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "index/_close"
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_settings"
        body: |
          {
            "index": {
              "similarity": {
                "default": {
                  "type": "boolean"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "index/_open"
  - is_false: _shards.failures
