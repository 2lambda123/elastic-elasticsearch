---
"line_17":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup messages

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            {"index":{"_id": "0"}}
            {"message": "trying out Elasticsearch", "context": "foo"}
            {"index":{"_id": "1"}}
            {"message": "some message with the number 1", "context": "bar"}
            {"index":{"_id": "2"}}
            {"message": "some message with the number 2", "context": "bar"}
            {"index":{"_id": "3"}}
            {"message": "some message with the number 3", "context": "bar"}
            {"index":{"_id": "4"}}
            {"message": "some message with the number 4", "context": "bar"}

  - do:
      raw:
        method: GET
        path: "my-index-000001/_field_usage_stats"
  - is_false: _shards.failures
---
"line_144":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup messages

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            {"index":{"_id": "0"}}
            {"message": "trying out Elasticsearch", "context": "foo"}
            {"index":{"_id": "1"}}
            {"message": "some message with the number 1", "context": "bar"}
            {"index":{"_id": "2"}}
            {"message": "some message with the number 2", "context": "bar"}
            {"index":{"_id": "3"}}
            {"message": "some message with the number 3", "context": "bar"}
            {"index":{"_id": "4"}}
            {"message": "some message with the number 4", "context": "bar"}

  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        body: |
          {
            "query" : {
              "match" : { "context" : "bar" }
            },
            "aggs": {
              "message_stats": {
                "string_stats": {
                  "field": "message.keyword",
                  "show_distribution": true
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_field_usage_stats"
  - is_false: _shards.failures
  - match:
      $body:
        {
            "_shards": {
                "total": $body.$_path,
                "successful": $body.$_path,
                "failed": $body.$_path
            },
            "my-index-000001": {
                "shards": [
                    {
                        "tracking_id": $body.$_path,
                        "tracking_started_at_millis": $body.$_path,
                        "routing": {
                            "state": $body.$_path,
                            "primary": true,
                            "node": $body.$_path,
                            "relocating_node": null
                        },
                        "stats" : {
                            "all_fields": {
                                "any": $body.$_path,
                                "inverted_index": {
                                    "terms" : $body.$_path,
                                    "postings" : $body.$_path,
                                    "proximity" : $body.$_path,
                                    "positions" : $body.$_path,
                                    "term_frequencies" : $body.$_path,
                                    "offsets" : $body.$_path,
                                    "payloads" : $body.$_path
                                },
                                "stored_fields" : $body.$_path,
                                "doc_values" : $body.$_path,
                                "points" : $body.$_path,
                                "norms" : $body.$_path,
                                "term_vectors" : $body.$_path,
                                "knn_vectors" : $body.$_path
                            },
                            "fields": {
                                "_id": {
                                    "any" : $body.$_path,
                                    "inverted_index": {
                                        "terms" : $body.$_path,
                                        "postings" : $body.$_path,
                                        "proximity" : $body.$_path,
                                        "positions" : $body.$_path,
                                        "term_frequencies" : $body.$_path,
                                        "offsets" : $body.$_path,
                                        "payloads" : $body.$_path
                                    },
                                    "stored_fields" : $body.$_path,
                                    "doc_values" : $body.$_path,
                                    "points" : $body.$_path,
                                    "norms" : $body.$_path,
                                    "term_vectors" : $body.$_path,
                                    "knn_vectors" : $body.$_path
                                },
                                "_source": $body.$_path,
                                "context": $body.$_path,
                                "message.keyword": $body.$_path
                            }
                        }
                    }
                ]
            }
        }
