---
"submit-async-search-date-histogram-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales*/_async_search"
        size: "0"
        wait_for_completion_timeout: "10s"
        keep_on_completion: "true"
        body: |
          {
            "sort": [
              { "date": { "order": "asc" } }
            ],
            "aggs": {
              "sale_date": {
                "date_histogram": {
                  "field": "date",
                  "calendar_interval": "1d"
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "id" : "$body.id",
          "is_partial": $body.is_partial,
          "is_running": $body.is_running,
          "start_time_in_millis" : $body.start_time_in_millis,
          "expiration_time_in_millis" : $body.expiration_time_in_millis,
          "completion_time_in_millis": $body.completion_time_in_millis,
          "response" : {
            "took": $body.response.took,
            "timed_out" : false,
            
            "_shards" : {
              "total": $body.response._shards.total,
              "successful": $body.response._shards.successful,
              "skipped" : 0,
              "failed" : 0
            },
            "hits" : {
              "total" : {
                "value": $body.response.hits.total.value,
                "relation": $body.response.hits.total.relation
              },
              "max_score" : null,
              "hits" : []},"aggregations":  $body.response.aggregations
          }
        }
  - do:
      raw:
        method: GET
        path: "_async_search/${body.id}"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "id" : "$body.id",
          "is_partial" : false,
          "is_running" : false,
          "start_time_in_millis" : $body.start_time_in_millis,
          "expiration_time_in_millis" : $body.expiration_time_in_millis,
          "completion_time_in_millis" : $body.completion_time_in_millis,
          "response" : {
            "took": $body.response.took,
            "timed_out" : false,
            
            "_shards" : {
              "total": $body.response._shards.total,
              "successful": $body.response._shards.successful,
              "skipped" : 0,
              "failed" : 0
            },
            "hits" : {
              "total" : {
                "value": $body.response.hits.total.value,
                "relation" : "eq"
              },
              "max_score" : null,
              "hits" : [ ]
            },
            "aggregations" : {
              "sale_date" :  {
                "buckets": $body.response.aggregations.sale_date.buckets
              }
            }
          }
        }
  - do:
      raw:
        method: GET
        path: "_async_search/status/${body.id}"
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "_async_search/${body.id}"
  - is_false: _shards.failures
