---
setup:
  - do:
      raw:
        method: PUT
        path: "my_locations"
        body: |
          {
            "mappings": {
              "properties": {
                "location": {
                  "type": "geo_point"
                }
              }
            }
          }
  - do:
      raw:
        method: PUT
        path: "my_locations/_doc/1"
        refresh: ""
        body: |
          {
            "location" : "POINT(4.912350 52.374081)",
            "city": "Amsterdam",
            "name": "NEMO Science Museum"
          }
  - do:
      raw:
        method: PUT
        path: "my_locations/_doc/2"
        refresh: ""
        body: |
          {
            "location" : "POINT(4.405200 51.222900)",
            "city": "Antwerp",
            "name": "Letterenhuis"
          }
  - do:
      raw:
        method: PUT
        path: "my_locations/_doc/3"
        refresh: ""
        body: |
          {
            "location" : "POINT(2.336389 48.861111)",
            "city": "Paris",
            "name": "Musée du Louvre"
          }
---
"line_62":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "my_locations/_search"
        body: |
          {
            "size" : 0,
            "aggs" : {
               "grouped" : {
                  "geohash_grid" : {
                     "field" : "location",
                     "precision" : 2
                  }
               }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 3,
              "relation" : "eq"
            },
            "max_score" : null,
            "hits" : [ ]
          },
          "aggregations" : {
            "grouped" : {
              "buckets" : [
                {
                  "key" : "u1",
                  "doc_count" : 2
                },
                {
                  "key" : "u0",
                  "doc_count" : 1
                }
              ]
            }
          }
        }
---
"line_119":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "my_locations/_search"
        body: |
          {
            "query": {
              "geo_grid" :{
                "location" : {
                  "geohash" : "u0"
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : 1.0,
            "hits" : [
              {
                "_index" : "my_locations",
                "_id" : "3",
                "_score" : 1.0,
                "_source" : {
                  "location" : "POINT(2.336389 48.861111)",
                  "city" : "Paris",
                  "name" : "Musée du Louvre"
                }
              }
            ]
          }
        }
---
"line_174":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "my_locations/_search"
        body: |
          {
            "size" : 0,
            "aggs" : {
               "grouped" : {
                  "geotile_grid" : {
                     "field" : "location",
                     "precision" : 6
                  }
               }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 3,
              "relation" : "eq"
            },
            "max_score" : null,
            "hits" : [ ]
          },
          "aggregations" : {
            "grouped" : {
              "buckets" : [
                {
                  "key" : "6/32/21",
                  "doc_count" : 2
                },
                {
                  "key" : "6/32/22",
                  "doc_count" : 1
                }
              ]
            }
          }
        }
        
---
"line_232":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "my_locations/_search"
        body: |
          {
            "query": {
              "geo_grid" :{
                "location" : {
                  "geotile" : "6/32/22"
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : 1.0,
            "hits" : [
              {
                "_index" : "my_locations",
                "_id" : "3",
                "_score" : 1.0,
                "_source" : {
                  "location" : "POINT(2.336389 48.861111)",
                  "city" : "Paris",
                  "name" : "Musée du Louvre"
                }
              }
            ]
          }
        }
---
"line_287":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "my_locations/_search"
        body: |
          {
            "size" : 0,
            "aggs" : {
               "grouped" : {
                  "geohex_grid" : {
                     "field" : "location",
                     "precision" : 1
                  }
               }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 3,
              "relation" : "eq"
            },
            "max_score" : null,
            "hits" : [ ]
          },
          "aggregations" : {
            "grouped" : {
              "buckets" : [
                {
                  "key" : "81197ffffffffff",
                  "doc_count" : 2
                },
                {
                  "key" : "811fbffffffffff",
                  "doc_count" : 1
                }
              ]
            }
          }
        }
        
---
"line_345":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "my_locations/_search"
        body: |
          {
            "query": {
              "geo_grid" :{
                "location" : {
                  "geohex" : "811fbffffffffff"
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took" : $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : 1.0,
            "hits" : [
              {
                "_index" : "my_locations",
                "_id" : "3",
                "_score" : 1.0,
                "_source" : {
                  "location" : "POINT(2.336389 48.861111)",
                  "city" : "Paris",
                  "name" : "Musée du Louvre"
                }
              }
            ]
          }
        }
