---
"line_23":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "obj1": {
                  "type": "nested"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_search"
        body: |
          {
            "query": {
              "nested": {
                "path": "obj1",
                "query": {
                  "bool": {
                    "must": [
                      { "match": { "obj1.name": "blue" } },
                      { "range": { "obj1.count": { "gt": 5 } } }
                    ]
                  }
                },
                "score_mode": "avg"
              }
            }
          }
  - is_false: _shards.failures
---
"line_139":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "drivers"
        body: |
          {
            "mappings": {
              "properties": {
                "driver": {
                  "type": "nested",
                  "properties": {
                    "last_name": {
                      "type": "text"
                    },
                    "vehicle": {
                      "type": "nested",
                      "properties": {
                        "make": {
                          "type": "text"
                        },
                        "model": {
                          "type": "text"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "drivers/_doc/1"
        body: |
          {
            "driver" : {
                  "last_name" : "McQueen",
                  "vehicle" : [
                      {
                          "make" : "Powell Motors",
                          "model" : "Canyonero"
                      },
                      {
                          "make" : "Miller-Meteor",
                          "model" : "Ecto-1"
                      }
                  ]
              }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "drivers/_doc/2"
        refresh: ""
        body: |
          {
            "driver" : {
                  "last_name" : "Hudson",
                  "vehicle" : [
                      {
                          "make" : "Mifune",
                          "model" : "Mach Five"
                      },
                      {
                          "make" : "Miller-Meteor",
                          "model" : "Ecto-1"
                      }
                  ]
              }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "drivers/_search"
        body: |
          {
            "query": {
              "nested": {
                "path": "driver",
                "query": {
                  "nested": {
                    "path": "driver.vehicle",
                    "query": {
                      "bool": {
                        "must": [
                          { "match": { "driver.vehicle.make": "Powell Motors" } },
                          { "match": { "driver.vehicle.model": "Canyonero" } }
                        ]
                      }
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : 3.7349272,
            "hits" : [
              {
                "_index" : "drivers",
                "_id" : "1",
                "_score" : 3.7349272,
                "_source" : {
                  "driver" : {
                    "last_name" : "McQueen",
                    "vehicle" : [
                      {
                        "make" : "Powell Motors",
                        "model" : "Canyonero"
                      },
                      {
                        "make" : "Miller-Meteor",
                        "model" : "Ecto-1"
                      }
                    ]
                  }
                }
              }
            ]
          }
        }
---
"line_298":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index"
        body: |
          {
            "mappings": {
              "properties": {
                "comments": {
                  "type": "nested"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index/_doc/1"
        refresh: ""
        body: |
          {
            "comments": [
              {
                "author": "kimchy"
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index/_doc/2"
        refresh: ""
        body: |
          {
            "comments": [
              {
                "author": "kimchy"
              },
              {
                "author": "nik9000"
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index/_doc/3"
        refresh: ""
        body: |
          {
            "comments": [
              {
                "author": "nik9000"
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index/_search"
        filter_path: "hits.hits"
        body: |
          {
            "query": {
              "nested": {
                "path": "comments",
                "query": {
                  "bool": {
                    "must_not": [
                      {
                        "term": {
                          "comments.author": "nik9000"
                        }
                      }
                    ]
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          
          "hits" : {
            
            "hits" : [
              {
                "_index" : "my-index",
                "_id" : "1",
                "_score" : 0.0,
                "_source" : {
                  "comments" : [
                    {
                      "author" : "kimchy"
                    }
                  ]
                }
              },
              {
                "_index" : "my-index",
                "_id" : "2",
                "_score" : 0.0,
                "_source" : {
                  "comments" : [
                    {
                      "author" : "kimchy"
                    },
                    {
                      "author" : "nik9000"
                    }
                  ]
                }
              }
            ]
          }
        }
  - do:
      raw:
        method: POST
        path: "my-index/_search"
        filter_path: "hits.hits"
        body: |
          {
            "query": {
              "bool": {
                "must_not": [
                  {
                    "nested": {
                      "path": "comments",
                      "query": {
                        "term": {
                          "comments.author": "nik9000"
                        }
                      }
                    }
                  }
                ]
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          
          "hits" : {
            
            "hits" : [
              {
                "_index" : "my-index",
                "_id" : "1",
                "_score" : 0.0,
                "_source" : {
                  "comments" : [
                    {
                      "author" : "kimchy"
                    }
                  ]
                }
              }
            ]
          }
        }
