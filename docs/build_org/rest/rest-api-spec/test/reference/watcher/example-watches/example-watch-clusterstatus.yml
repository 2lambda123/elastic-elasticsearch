---
"line_27":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_watcher/watch/cluster_health_watch"
        body: |
          {
            "trigger" : {
              "schedule" : { "interval" : "10s" }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "_cluster/health"
        pretty: ""
  - is_false: _shards.failures
---
"line_54":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_watcher/watch/cluster_health_watch"
        body: |
          {
            "trigger" : {
              "schedule" : { "interval" : "10s" }
            },
            "input" : {
              "http" : {
                "request" : {
                  "host" : "localhost",
                  "port" : 9200,
                  "path" : "/_cluster/health"
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_76":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_watcher/watch/cluster_health_watch"
        body: |
          {
            "trigger" : {
              "schedule" : { "interval" : "10s" }
            },
            "input" : {
              "http" : {
                "request" : {
                  "host" : "localhost",
                  "port" : 9200,
                  "path" : "/_cluster/health",
                  "auth": {
                    "basic": {
                      "username": "elastic",
                      "password": "x-pack-test-password"
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: ".watcher-history*/_search"
        body: |
          {
            "sort" : [
              { "result.execution_time" : "desc" }
            ]
          }
  - is_false: _shards.failures
---
"line_137":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_watcher/watch/cluster_health_watch"
        body: |
          {
            "trigger" : {
              "schedule" : { "interval" : "10s" }
            },
            "input" : {
              "http" : {
                "request" : {
                 "host" : "localhost",
                 "port" : 9200,
                 "path" : "/_cluster/health"
                }
              }
            },
            "condition" : {
              "compare" : {
                "ctx.payload.status" : { "eq" : "red" }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: ".watcher-history*/_search"
        pretty: ""
        body: |
          {
            "query" : {
              "match" : { "result.condition.met" : true }
            }
          }
  - is_false: _shards.failures
---
"line_193":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_watcher/watch/cluster_health_watch"
        body: |
          {
            "trigger" : {
              "schedule" : { "interval" : "10s" }
            },
            "input" : {
              "http" : {
                "request" : {
                 "host" : "localhost",
                 "port" : 9200,
                 "path" : "/_cluster/health"
                }
              }
            },
            "condition" : {
              "compare" : {
                "ctx.payload.status" : { "eq" : "red" }
              }
            },
            "actions" : {
              "send_email" : {
                "email" : {
                  "to" : "username@example.org",
                  "subject" : "Cluster Status Warning",
                  "body" : "Cluster status is RED"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: ".watcher-history*/_search"
        pretty: ""
        body: |
          {
            "query" : {
              "match" : { "result.condition.met" : true }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "_watcher/watch/cluster_health_watch"
  - is_false: _shards.failures
