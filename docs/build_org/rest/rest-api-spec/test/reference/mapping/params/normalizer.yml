---
"line_18":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "index"
        body: |
          {
            "settings": {
              "analysis": {
                "normalizer": {
                  "my_normalizer": {
                    "type": "custom",
                    "char_filter": [],
                    "filter": ["lowercase", "asciifolding"]
                  }
                }
              }
            },
            "mappings": {
              "properties": {
                "foo": {
                  "type": "keyword",
                  "normalizer": "my_normalizer"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_doc/1"
        body: |
          {
            "foo": "BÀR"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_doc/2"
        body: |
          {
            "foo": "bar"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "index/_doc/3"
        body: |
          {
            "foo": "baz"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "index/_refresh"
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "index/_search"
        body: |
          {
            "query": {
              "term": {
                "foo": "BAR"
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "index/_search"
        body: |
          {
            "query": {
              "match": {
                "foo": "BAR"
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": "$body.took",
          "timed_out": false,
          "_shards": {
            "total": 1,
            "successful": 1,
            "skipped" : 0,
            "failed": 0
          },
          "hits": {
            "total" : {
                "value": 2,
                "relation": "eq"
            },
            "max_score": 0.4700036,
            "hits": [
              {
                "_index": "index",
                "_id": "1",
                "_score": 0.4700036,
                "_source": {
                  "foo": "BÀR"
                }
              },
              {
                "_index": "index",
                "_id": "2",
                "_score": 0.4700036,
                "_source": {
                  "foo": "bar"
                }
              }
            ]
          }
        }
  - do:
      raw:
        method: GET
        path: "index/_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "foo_terms": {
                "terms": {
                  "field": "foo"
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": "$body.took",
          "timed_out": false,
          "_shards": {
            "total": 1,
            "successful": 1,
            "skipped" : 0,
            "failed": 0
          },
          "hits": {
            "total" : {
                "value": 3,
                "relation": "eq"
            },
            "max_score": null,
            "hits": []
          },
          "aggregations": {
            "foo_terms": {
              "doc_count_error_upper_bound": 0,
              "sum_other_doc_count": 0,
              "buckets": [
                {
                  "key": "bar",
                  "doc_count": 2
                },
                {
                  "key": "baz",
                  "doc_count": 1
                }
              ]
            }
          }
        }
