---
"line_17":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "manager": {
                  "properties": {
                    "age":  { "type": "integer" },
                    "name": { "type": "text"  }
                  }
                },
                "employees": {
                  "type": "nested",
                  "properties": {
                    "age":  { "type": "integer" },
                    "name": { "type": "text"  }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/1"
        body: |
          {
            "region": "US",
            "manager": {
              "name": "Alice White",
              "age": 30
            },
            "employees": [
              {
                "name": "John Smith",
                "age": 34
              },
              {
                "name": "Peter Brown",
                "age": 26
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_search"
        body: |
          {
            "query": {
              "match": {
                "manager.name": "Alice White"
              }
            },
            "aggs": {
              "Employees": {
                "nested": {
                  "path": "employees"
                },
                "aggs": {
                  "Employee Ages": {
                    "histogram": {
                      "field": "employees.age",
                      "interval": 5
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
