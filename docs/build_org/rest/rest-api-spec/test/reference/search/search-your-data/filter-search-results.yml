---
setup:
  - do:
      raw:
        method: PUT
        path: "shirts"
        body: |
          {
            "mappings": {
              "properties": {
                "brand": { "type": "keyword"},
                "color": { "type": "keyword"},
                "model": { "type": "keyword"}
              }
            }
          }
  - do:
      raw:
        method: PUT
        path: "shirts/_doc/1"
        refresh: ""
        body: |
          {
            "brand": "gucci",
            "color": "red",
            "model": "slim"
          }
---
"line_58":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "shirts/_search"
        body: |
          {
            "query": {
              "bool": {
                "filter": [
                  { "term": { "color": "red"   }},
                  { "term": { "brand": "gucci" }}
                ]
              }
            }
          }
  - is_false: _shards.failures
---
"line_81":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "shirts/_search"
        body: |
          {
            "query": {
              "bool": {
                "filter": [
                  { "term": { "color": "red"   }},
                  { "term": { "brand": "gucci" }}
                ]
              }
            },
            "aggs": {
              "models": {
                "terms": { "field": "model" }
              }
            }
          }
  - is_false: _shards.failures
---
"line_112":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "shirts/_search"
        body: |
          {
            "query": {
              "bool": {
                "filter": {
                  "term": { "brand": "gucci" }
                }
              }
            },
            "aggs": {
              "colors": {
                "terms": { "field": "color" }
              },
              "color_red": {
                "filter": {
                  "term": { "color": "red" }
                },
                "aggs": {
                  "models": {
                    "terms": { "field": "model" }
                  }
                }
              }
            },
            "post_filter": {
              "term": { "color": "red" }
            }
          }
  - is_false: _shards.failures
---
"line_195":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup my_index

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
            mappings:
              properties:
                "@timestamp":
                  type: date
                http:
                  properties:
                    request:
                      properties:
                        method:
                          type: keyword
                message:
                  type: text
                  fields:
                    keyword:
                      type: keyword
                user:
                  properties:
                    id:
                      type: keyword
                      doc_values: true
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            { "index":{"_id": "0"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "127.0.0.1" }, "user": { "id": "kimchy" } }
            { "index":{"_id": "1"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "2"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "3"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "4"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
  - do:
      raw:
        method: POST
        path: "_search"
        body: |
          {
             "query" : {
                "match" : {
                   "message" : {
                      "operator" : "or",
                      "query" : "the quick brown"
                   }
                }
             },
             "rescore" : {
                "window_size" : 50,
                "query" : {
                   "rescore_query" : {
                      "match_phrase" : {
                         "message" : {
                            "query" : "the quick brown",
                            "slop" : 2
                         }
                      }
                   },
                   "query_weight" : 0.7,
                   "rescore_query_weight" : 1.2
                }
             }
          }
  - is_false: _shards.failures
---
"line_244":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup my_index

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
            mappings:
              properties:
                "@timestamp":
                  type: date
                http:
                  properties:
                    request:
                      properties:
                        method:
                          type: keyword
                message:
                  type: text
                  fields:
                    keyword:
                      type: keyword
                user:
                  properties:
                    id:
                      type: keyword
                      doc_values: true
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            { "index":{"_id": "0"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "127.0.0.1" }, "user": { "id": "kimchy" } }
            { "index":{"_id": "1"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "2"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "3"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "4"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
  - do:
      raw:
        method: POST
        path: "_search"
        body: |
          {
             "query" : {
                "match" : {
                   "message" : {
                      "operator" : "or",
                      "query" : "the quick brown"
                   }
                }
             },
             "rescore" : [ {
                "window_size" : 100,
                "query" : {
                   "rescore_query" : {
                      "match_phrase" : {
                         "message" : {
                            "query" : "the quick brown",
                            "slop" : 2
                         }
                      }
                   },
                   "query_weight" : 0.7,
                   "rescore_query_weight" : 1.2
                }
             }, {
                "window_size" : 10,
                "query" : {
                   "score_mode": "multiply",
                   "rescore_query" : {
                      "function_score" : {
                         "script_score": {
                            "script": {
                              "source": "Math.log10(doc.count.value + 2)"
                            }
                         }
                      }
                   }
                }
             } ]
          }
  - is_false: _shards.failures
