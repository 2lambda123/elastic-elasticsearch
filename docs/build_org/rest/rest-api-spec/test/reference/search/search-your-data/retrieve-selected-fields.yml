---
"line_58":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup my_index

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
            mappings:
              properties:
                "@timestamp":
                  type: date
                http:
                  properties:
                    request:
                      properties:
                        method:
                          type: keyword
                message:
                  type: text
                  fields:
                    keyword:
                      type: keyword
                user:
                  properties:
                    id:
                      type: keyword
                      doc_values: true
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            { "index":{"_id": "0"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "127.0.0.1" }, "user": { "id": "kimchy" } }
            { "index":{"_id": "1"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "2"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "3"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "4"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        filter_path: "hits"
        body: |
          {
            "query": {
              "match": {
                "user.id": "kimchy"
              }
            },
            "fields": [
              "user.id",
              "http.response.*",
              {
                "field": "@timestamp",
                "format": "epoch_millis"
              }
            ],
            "_source": false
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : $body.hits.max_score,
            "hits" : [
              {
                "_index" : "my-index-000001",
                "_id" : "0",
                "_score" : $body.hits.hits.0._score,
                "fields" : {
                  "user.id" : [
                    "kimchy"
                  ],
                  "@timestamp" : [
                    "4098435132000"
                  ],
                  "http.response.bytes": [
                    1070000
                  ],
                  "http.response.status_code": [
                    200
                  ]
                }
              }
            ]
          }
        }
---
"line_159":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "group" : { "type" : "keyword" },
                "user": {
                  "type": "nested",
                  "properties": {
                    "first" : { "type" : "keyword" },
                    "last" : { "type" : "keyword" }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/1"
        refresh: "true"
        body: |
          {
            "group" : "fans",
            "user" : [
              {
                "first" : "John",
                "last" :  "Smith"
              },
              {
                "first" : "Alice",
                "last" :  "White"
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        body: |
          {
            "fields": ["*"],
            "_source": false
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out": false,
          "_shards": {
            "total": 1,
            "successful": 1,
            "skipped": 0,
            "failed": 0
          },
          "hits": {
            "total": {
              "value": 1,
              "relation": "eq"
            },
            "max_score": 1.0,
            "hits": [{
              "_index": "my-index-000001",
              "_id": "1",
              "_score": 1.0,
              "fields": {
                "group" : ["fans"],
                "user": [{
                    "first": ["John"],
                    "last": ["Smith"]
                  },
                  {
                    "first": ["Alice"],
                    "last": ["White"]
                  }
                ]
              }
            }]
          }
        }
  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        body: |
          {
            "fields": ["user.first"],
            "_source": false
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out": false,
          "_shards": {
            "total": 1,
            "successful": 1,
            "skipped": 0,
            "failed": 0
          },
          "hits": {
            "total": {
              "value": 1,
              "relation": "eq"
            },
            "max_score": 1.0,
            "hits": [{
              "_index": "my-index-000001",
              "_id": "1",
              "_score": 1.0,
              "fields": {
                "user": [{
                    "first": ["John"]
                  },
                  {
                    "first": ["Alice"]
                  }
                ]
              }
            }]
          }
        }
---
"line_317":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "enabled": false
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/1"
        refresh: "true"
        body: |
          {
            "user_id": "kimchy",
            "session_data": {
               "object": {
                 "some_field": "some_value"
               }
             }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        body: |
          {
            "fields": [
              "user_id",
              {
                "field": "session_data.object.*",
                "include_unmapped" : true
              }
            ],
            "_source": false
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : $body.hits.max_score,
            "hits" : [
              {
                "_index" : "my-index-000001",
                "_id" : "1",
                "_score" : $body.hits.hits.0._score,
                "fields" : {
                  "session_data.object.some_field": [
                    "some_value"
                  ]
                }
              }
            ]
          }
        }
---
"line_408":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "my-small" : { "type" : "keyword", "ignore_above": 2 },
                "my-large" : { "type" : "keyword" }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/1"
        refresh: "true"
        body: |
          {
            "my-small": ["ok", "bad"],
            "my-large": "ok content"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        body: |
          {
            "fields": ["my-*"],
            "_source": false
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : $body.hits.max_score,
            "hits" : [
              {
                "_index" : "my-index-000001",
                "_id" : "1",
                "_score" : $body.hits.hits.0._score,
                "_ignored" : [ "my-small"],
                "fields" : {
                  "my-large": [
                    "ok content"
                  ],
                  "my-small": [
                    "ok"
                  ]
                },
                "ignored_field_values" : {
                  "my-small": [
                    "bad"
                  ]
                }
              }
            ]
          }
        }
---
"line_496":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "_source": false,
            "query": {
              "match": {
                "user.id": "kimchy"
              }
            }
          }
  - is_false: _shards.failures
---
"line_513":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "_source": "obj.*",
            "query": {
              "match": {
                "user.id": "kimchy"
              }
            }
          }
  - is_false: _shards.failures
---
"line_530":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "_source": [ "obj1.*", "obj2.*" ],
            "query": {
              "match": {
                "user.id": "kimchy"
              }
            }
          }
  - is_false: _shards.failures
---
"line_556":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "_source": {
              "includes": [ "obj1.*", "obj2.*" ],
              "excludes": [ "*.description" ]
            },
            "query": {
              "term": {
                "user.id": "kimchy"
              }
            }
          }
  - is_false: _shards.failures
---
"line_620":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup my_index

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
            mappings:
              properties:
                "@timestamp":
                  type: date
                http:
                  properties:
                    request:
                      properties:
                        method:
                          type: keyword
                message:
                  type: text
                  fields:
                    keyword:
                      type: keyword
                user:
                  properties:
                    id:
                      type: keyword
                      doc_values: true
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            { "index":{"_id": "0"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "127.0.0.1" }, "user": { "id": "kimchy" } }
            { "index":{"_id": "1"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "2"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "3"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "4"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
  - do:
      raw:
        method: GET
        path: "my-index-000001/_search"
        body: |
          {
            "query": {
              "match": {
                "user.id": "kimchy"
              }
            },
            "docvalue_fields": [
              "user.id",
              "http.response.*",
              {
                "field": "date",
                "format": "epoch_millis"
              }
            ]
          }
  - is_false: _shards.failures
---
"line_670":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "stored_fields" : ["user", "postDate"],
            "query" : {
              "term" : { "user" : "kimchy" }
            }
          }
  - is_false: _shards.failures
---
"line_686":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "stored_fields" : [],
            "query" : {
              "term" : { "user" : "kimchy" }
            }
          }
  - is_false: _shards.failures
---
"line_714":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "stored_fields": "_none_",
            "query" : {
              "term" : { "user" : "kimchy" }
            }
          }
  - is_false: _shards.failures
---
"line_734":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "query": {
              "match_all": {}
            },
            "script_fields": {
              "test1": {
                "script": {
                  "lang": "painless",
                  "source": "doc['price'].value * 2"
                }
              },
              "test2": {
                "script": {
                  "lang": "painless",
                  "source": "doc['price'].value * params.factor",
                  "params": {
                    "factor": 2.0
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_770":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup my_index

  - do:
        indices.create:
          index: my-index-000001
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 1
            mappings:
              properties:
                "@timestamp":
                  type: date
                http:
                  properties:
                    request:
                      properties:
                        method:
                          type: keyword
                message:
                  type: text
                  fields:
                    keyword:
                      type: keyword
                user:
                  properties:
                    id:
                      type: keyword
                      doc_values: true
  - do:
        bulk:
          index: my-index-000001
          refresh: true
          body: |
            { "index":{"_id": "0"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "127.0.0.1" }, "user": { "id": "kimchy" } }
            { "index":{"_id": "1"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "2"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "3"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
            { "index":{"_id": "4"} }
            { "@timestamp": "2099-11-15T14:12:12", "http": { "request": { "method": "get" }, "response": { "bytes": 1070000, "status_code": 200 }, "version": "1.1" }, "message": "GET /search HTTP/1.1 200 1070000", "source": { "ip": "10.42.42.42" }, "user": { "id": "elkbee" } }
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "query": {
              "match_all": {}
            },
            "script_fields": {
              "test1": {
                "script": "params['_source']['message']"
              }
            }
          }
  - is_false: _shards.failures
