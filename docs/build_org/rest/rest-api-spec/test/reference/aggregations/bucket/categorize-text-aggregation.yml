---
"line_158":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup categorize_text

  - do:
        indices.create:
          index: log-messages
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 0
            mappings:
              properties:
                time:
                  type: date
                message:
                  type: text

  - do:
        bulk:
          index: log-messages
          refresh: true
          body: |
            {"index": {"_id":"1"}}
            {"time":"2016-02-07T00:01:00+0000", "message": "2016-02-07T00:00:00+0000 Node 3 shutting down"}
            {"index": {"_id":"2"}}
            {"time":"2016-02-07T00:02:00+0000", "message": "2016-02-07T00:00:00+0000 Node 5 starting up"}
            {"index": {"_id":"3"}}
            {"time":"2016-02-07T00:03:00+0000", "message": "2016-02-07T00:00:00+0000 Node 4 shutting down"}
            {"index": {"_id":"4"}}
            {"time":"2016-02-08T00:01:00+0000", "message": "2016-02-08T00:00:00+0000 Node 5 shutting down"}
            {"index": {"_id":"5"}}
            {"time":"2016-02-08T00:02:00+0000", "message": "2016-02-08T00:00:00+0000 User foo_325 logging on"}
            {"index": {"_id":"6"}}
            {"time":"2016-02-08T00:04:00+0000", "message": "2016-02-08T00:00:00+0000 User foo_864 logged off"}

  - do:
      raw:
        method: POST
        path: "log-messages/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "categories": {
                "categorize_text": {
                  "field": "message"
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations" : {
            "categories" : {
              "buckets" : [
                {
                  "doc_count" : 3,
                  "key" : "Node shutting down",
                  "regex" : ".*?Node.+?shutting.+?down.*?",
                  "max_matching_length" : 49
                },
                {
                  "doc_count" : 1,
                  "key" : "Node starting up",
                  "regex" : ".*?Node.+?starting.+?up.*?",
                  "max_matching_length" : 47
                },
                {
                  "doc_count" : 1,
                  "key" : "User foo_325 logging on",
                  "regex" : ".*?User.+?foo_325.+?logging.+?on.*?",
                  "max_matching_length" : 52
                },
                {
                  "doc_count" : 1,
                  "key" : "User foo_864 logged off",
                  "regex" : ".*?User.+?foo_864.+?logged.+?off.*?",
                  "max_matching_length" : 52
                }
              ]
            }
          }
        }
---
"line_213":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup categorize_text

  - do:
        indices.create:
          index: log-messages
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 0
            mappings:
              properties:
                time:
                  type: date
                message:
                  type: text

  - do:
        bulk:
          index: log-messages
          refresh: true
          body: |
            {"index": {"_id":"1"}}
            {"time":"2016-02-07T00:01:00+0000", "message": "2016-02-07T00:00:00+0000 Node 3 shutting down"}
            {"index": {"_id":"2"}}
            {"time":"2016-02-07T00:02:00+0000", "message": "2016-02-07T00:00:00+0000 Node 5 starting up"}
            {"index": {"_id":"3"}}
            {"time":"2016-02-07T00:03:00+0000", "message": "2016-02-07T00:00:00+0000 Node 4 shutting down"}
            {"index": {"_id":"4"}}
            {"time":"2016-02-08T00:01:00+0000", "message": "2016-02-08T00:00:00+0000 Node 5 shutting down"}
            {"index": {"_id":"5"}}
            {"time":"2016-02-08T00:02:00+0000", "message": "2016-02-08T00:00:00+0000 User foo_325 logging on"}
            {"index": {"_id":"6"}}
            {"time":"2016-02-08T00:04:00+0000", "message": "2016-02-08T00:00:00+0000 User foo_864 logged off"}

  - do:
      raw:
        method: POST
        path: "log-messages/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "categories": {
                "categorize_text": {
                  "field": "message",
                  "categorization_filters": ["\\w+\\_\\d{3}"]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations" : {
            "categories" : {
              "buckets" : [
                {
                  "doc_count" : 3,
                  "key" : "Node shutting down",
                  "regex" : ".*?Node.+?shutting.+?down.*?",
                  "max_matching_length" : 49
                },
                {
                  "doc_count" : 1,
                  "key" : "Node starting up",
                  "regex" : ".*?Node.+?starting.+?up.*?",
                  "max_matching_length" : 47
                },
                {
                  "doc_count" : 1,
                  "key" : "User logged off",
                  "regex" : ".*?User.+?logged.+?off.*?",
                  "max_matching_length" : 52
                },
                {
                  "doc_count" : 1,
                  "key" : "User logging on",
                  "regex" : ".*?User.+?logging.+?on.*?",
                  "max_matching_length" : 52
                }
              ]
            }
          }
        }
---
"line_282":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup categorize_text

  - do:
        indices.create:
          index: log-messages
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 0
            mappings:
              properties:
                time:
                  type: date
                message:
                  type: text

  - do:
        bulk:
          index: log-messages
          refresh: true
          body: |
            {"index": {"_id":"1"}}
            {"time":"2016-02-07T00:01:00+0000", "message": "2016-02-07T00:00:00+0000 Node 3 shutting down"}
            {"index": {"_id":"2"}}
            {"time":"2016-02-07T00:02:00+0000", "message": "2016-02-07T00:00:00+0000 Node 5 starting up"}
            {"index": {"_id":"3"}}
            {"time":"2016-02-07T00:03:00+0000", "message": "2016-02-07T00:00:00+0000 Node 4 shutting down"}
            {"index": {"_id":"4"}}
            {"time":"2016-02-08T00:01:00+0000", "message": "2016-02-08T00:00:00+0000 Node 5 shutting down"}
            {"index": {"_id":"5"}}
            {"time":"2016-02-08T00:02:00+0000", "message": "2016-02-08T00:00:00+0000 User foo_325 logging on"}
            {"index": {"_id":"6"}}
            {"time":"2016-02-08T00:04:00+0000", "message": "2016-02-08T00:00:00+0000 User foo_864 logged off"}

  - do:
      raw:
        method: POST
        path: "log-messages/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "categories": {
                "categorize_text": {
                  "field": "message",
                  "categorization_filters": ["\\w+\\_\\d{3}"],
                  "similarity_threshold": 11
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations" : {
            "categories" : {
              "buckets" : [
                {
                  "doc_count" : 4,
                  "key" : "Node",
                  "regex" : ".*?Node.*?",
                  "max_matching_length" : 49
                },
                {
                  "doc_count" : 2,
                  "key" : "User",
                  "regex" : ".*?User.*?",
                  "max_matching_length" : 52
                }
              ]
            }
          }
        }
---
"line_334":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup categorize_text

  - do:
        indices.create:
          index: log-messages
          body:
            settings:
              number_of_shards: 1
              number_of_replicas: 0
            mappings:
              properties:
                time:
                  type: date
                message:
                  type: text

  - do:
        bulk:
          index: log-messages
          refresh: true
          body: |
            {"index": {"_id":"1"}}
            {"time":"2016-02-07T00:01:00+0000", "message": "2016-02-07T00:00:00+0000 Node 3 shutting down"}
            {"index": {"_id":"2"}}
            {"time":"2016-02-07T00:02:00+0000", "message": "2016-02-07T00:00:00+0000 Node 5 starting up"}
            {"index": {"_id":"3"}}
            {"time":"2016-02-07T00:03:00+0000", "message": "2016-02-07T00:00:00+0000 Node 4 shutting down"}
            {"index": {"_id":"4"}}
            {"time":"2016-02-08T00:01:00+0000", "message": "2016-02-08T00:00:00+0000 Node 5 shutting down"}
            {"index": {"_id":"5"}}
            {"time":"2016-02-08T00:02:00+0000", "message": "2016-02-08T00:00:00+0000 User foo_325 logging on"}
            {"index": {"_id":"6"}}
            {"time":"2016-02-08T00:04:00+0000", "message": "2016-02-08T00:00:00+0000 User foo_864 logged off"}

  - do:
      raw:
        method: POST
        path: "log-messages/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "daily": {
                "date_histogram": {
                  "field": "time",
                  "fixed_interval": "1d"
                },
                "aggs": {
                  "categories": {
                    "categorize_text": {
                      "field": "message",
                      "categorization_filters": ["\\w+\\_\\d{3}"]
                    },
                    "aggs": {
                      "hit": {
                        "top_hits": {
                          "size": 1,
                          "sort": ["time"],
                          "_source": "message"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations" : {
            "daily" : {
              "buckets" : [
                {
                  "key_as_string" : "2016-02-07T00:00:00.000Z",
                  "key" : 1454803200000,
                  "doc_count" : 3,
                  "categories" : {
                    "buckets" : [
                      {
                        "doc_count" : 2,
                        "key" : "Node shutting down",
                        "regex" : ".*?Node.+?shutting.+?down.*?",
                        "max_matching_length" : 49,
                        "hit" : {
                          "hits" : {
                            "total" : {
                              "value" : 2,
                              "relation" : "eq"
                            },
                            "max_score" : null,
                            "hits" : [
                              {
                                "_index" : "log-messages",
                                "_id" : "1",
                                "_score" : null,
                                "_source" : {
                                  "message" : "2016-02-07T00:00:00+0000 Node 3 shutting down"
                                },
                                "sort" : [
                                  1454803260000
                                ]
                              }
                            ]
                          }
                        }
                      },
                      {
                        "doc_count" : 1,
                        "key" : "Node starting up",
                        "regex" : ".*?Node.+?starting.+?up.*?",
                        "max_matching_length" : 47,
                        "hit" : {
                          "hits" : {
                            "total" : {
                              "value" : 1,
                              "relation" : "eq"
                            },
                            "max_score" : null,
                            "hits" : [
                              {
                                "_index" : "log-messages",
                                "_id" : "2",
                                "_score" : null,
                                "_source" : {
                                  "message" : "2016-02-07T00:00:00+0000 Node 5 starting up"
                                },
                                "sort" : [
                                  1454803320000
                                ]
                              }
                            ]
                          }
                        }
                      }
                    ]
                  }
                },
                {
                  "key_as_string" : "2016-02-08T00:00:00.000Z",
                  "key" : 1454889600000,
                  "doc_count" : 3,
                  "categories" : {
                    "buckets" : [
                      {
                        "doc_count" : 1,
                        "key" : "Node shutting down",
                        "regex" : ".*?Node.+?shutting.+?down.*?",
                        "max_matching_length" : 49,
                        "hit" : {
                          "hits" : {
                            "total" : {
                              "value" : 1,
                              "relation" : "eq"
                            },
                            "max_score" : null,
                            "hits" : [
                              {
                                "_index" : "log-messages",
                                "_id" : "4",
                                "_score" : null,
                                "_source" : {
                                  "message" : "2016-02-08T00:00:00+0000 Node 5 shutting down"
                                },
                                "sort" : [
                                  1454889660000
                                ]
                              }
                            ]
                          }
                        }
                      },
                      {
                        "doc_count" : 1,
                        "key" : "User logged off",
                        "regex" : ".*?User.+?logged.+?off.*?",
                        "max_matching_length" : 52,
                        "hit" : {
                          "hits" : {
                            "total" : {
                              "value" : 1,
                              "relation" : "eq"
                            },
                            "max_score" : null,
                            "hits" : [
                              {
                                "_index" : "log-messages",
                                "_id" : "6",
                                "_score" : null,
                                "_source" : {
                                  "message" : "2016-02-08T00:00:00+0000 User foo_864 logged off"
                                },
                                "sort" : [
                                  1454889840000
                                ]
                              }
                            ]
                          }
                        }
                      },
                      {
                        "doc_count" : 1,
                        "key" : "User logging on",
                        "regex" : ".*?User.+?logging.+?on.*?",
                        "max_matching_length" : 52,
                        "hit" : {
                          "hits" : {
                            "total" : {
                              "value" : 1,
                              "relation" : "eq"
                            },
                            "max_score" : null,
                            "hits" : [
                              {
                                "_index" : "log-messages",
                                "_id" : "5",
                                "_score" : null,
                                "_source" : {
                                  "message" : "2016-02-08T00:00:00+0000 User foo_325 logging on"
                                },
                                "sort" : [
                                  1454889720000
                                ]
                              }
                            ]
                          }
                        }
                      }
                    ]
                  }
                }
              ]
            }
          }
        }
