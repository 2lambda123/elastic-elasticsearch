---
"line_52":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "top_tags": {
                "terms": {
                  "field": "type",
                  "size": 3
                },
                "aggs": {
                  "top_sales_hits": {
                    "top_hits": {
                      "sort": [
                        {
                          "date": {
                            "order": "desc"
                          }
                        }
                      ],
                      "_source": {
                        "includes": [ "date", "price" ]
                      },
                      "size": 1
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
          "aggregations": {
            "top_tags": {
               "doc_count_error_upper_bound": 0,
               "sum_other_doc_count": 0,
               "buckets": [
                  {
                     "key": "hat",
                     "doc_count": 3,
                     "top_sales_hits": {
                        "hits": {
                           "total" : {
                               "value": 3,
                               "relation": "eq"
                           },
                           "max_score": null,
                           "hits": [
                              {
                                 "_index": "sales",
                                 "_id": "$body.aggregations.top_tags.buckets.0.top_sales_hits.hits.hits.0._id",
                                 "_source": {
                                    "date": "2015/03/01 00:00:00",
                                    "price": 200
                                 },
                                 "sort": [
                                    1425168000000
                                 ],
                                 "_score": null
                              }
                           ]
                        }
                     }
                  },
                  {
                     "key": "t-shirt",
                     "doc_count": 3,
                     "top_sales_hits": {
                        "hits": {
                           "total" : {
                               "value": 3,
                               "relation": "eq"
                           },
                           "max_score": null,
                           "hits": [
                              {
                                 "_index": "sales",
                                 "_id": "$body.aggregations.top_tags.buckets.1.top_sales_hits.hits.hits.0._id",
                                 "_source": {
                                    "date": "2015/03/01 00:00:00",
                                    "price": 175
                                 },
                                 "sort": [
                                    1425168000000
                                 ],
                                 "_score": null
                              }
                           ]
                        }
                     }
                  },
                  {
                     "key": "bag",
                     "doc_count": 1,
                     "top_sales_hits": {
                        "hits": {
                           "total" : {
                               "value": 1,
                               "relation": "eq"
                           },
                           "max_score": null,
                           "hits": [
                              {
                                 "_index": "sales",
                                 "_id": "$body.aggregations.top_tags.buckets.2.top_sales_hits.hits.hits.0._id",
                                 "_source": {
                                    "date": "2015/01/01 00:00:00",
                                    "price": 150
                                 },
                                 "sort": [
                                    1420070400000
                                 ],
                                 "_score": null
                              }
                           ]
                        }
                     }
                  }
               ]
            }
          }
        }
---
"line_201":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        body: |
          {
            "query": {
              "match": {
                "body": "elections"
              }
            },
            "aggs": {
              "top_sites": {
                "terms": {
                  "field": "domain",
                  "order": {
                    "top_hit": "desc"
                  }
                },
                "aggs": {
                  "top_tags_hits": {
                    "top_hits": {}
                  },
                  "top_hit" : {
                    "max": {
                      "script": {
                        "source": "_score"
                      }
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_254":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "sales"
        body: |
          {
            "mappings": {
              "properties": {
                "tags": { "type": "keyword" },
                "comments": {
                  "type": "nested",
                  "properties": {
                    "username": { "type": "keyword" },
                    "comment": { "type": "text" }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "sales/_doc/1"
        refresh: ""
        body: |
          {
            "tags": [ "car", "auto" ],
            "comments": [
              { "username": "baddriver007", "comment": "This car could have better brakes" },
              { "username": "dr_who", "comment": "Where's the autopilot? Can't find it" },
              { "username": "ilovemotorbikes", "comment": "This car has two extra wheels" }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "sales/_search"
        filter_path: "aggregations.by_sale.by_user.buckets"
        body: |
          {
            "query": {
              "term": { "tags": "car" }
            },
            "aggs": {
              "by_sale": {
                "nested": {
                  "path": "comments"
                },
                "aggs": {
                  "by_user": {
                    "terms": {
                      "field": "comments.username",
                      "size": 1
                    },
                    "aggs": {
                      "by_nested": {
                        "top_hits": {}
                      }
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          
          "aggregations": {
            "by_sale": {
              "by_user": {
                "buckets": [
                  {
                    "key": "baddriver007",
                    "doc_count": 1,
                    "by_nested": {
                      "hits": {
                        "total" : {
                           "value": 1,
                           "relation": "eq"
                        },
                        "max_score": 0.3616575,
                        "hits": [
                          {
                            "_index": "sales",
                            "_id": "1",
                            "_nested": {
                              "field": "comments",
                              "offset": 0
                            },
                            "_score": 0.3616575,
                            "_source": {
                              "comment": "This car could have better brakes",
                              "username": "baddriver007"
                            }
                          }
                        ]
                      }
                    }
                  }
                  
                ]
              }
            }
          }
        }
---
"line_427":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup sales

  - do:
        indices.create:
          index: sales
          body:
            settings:
              number_of_shards: 2
              number_of_replicas: 1
            mappings:
              properties:
                type:
                  type: keyword
  - do:
        bulk:
          index: sales
          refresh: true
          body: |
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/01/01 00:00:00", "price": 150, "promoted": true, "rating": 5, "type": "bag"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 50, "promoted": false, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/02/01 00:00:00", "price": 10, "promoted": true, "rating": 4, "type": "t-shirt"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 200, "promoted": true, "rating": 1, "type": "hat"}
            {"index":{}}
            {"date": "2015/03/01 00:00:00", "price": 175, "promoted": false, "rating": 2, "type": "t-shirt"}
  - do:
      raw:
        method: POST
        path: "sales/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "top_tags": {
                "terms": {
                  "field": "type",
                  "size": 3
                },
                "aggs": {
                  "top_sales_hits": {
                    "top_hits": {
                      "sort": [
                        {
                          "date": {
                            "order": "desc"
                          }
                        }
                      ],
                      "_source": {
                        "includes": [ "date", "price" ]
                      },
                      "size": 1
                    }
                  },
                  "having.top_salary": {
                    "bucket_selector": {
                      "buckets_path": {
                        "tp": "top_sales_hits[_source.price]"
                      },
                      "script": "params.tp < 180"
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
