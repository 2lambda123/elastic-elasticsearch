---
"line_53":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
        - always_skip
      reason: example fragment
  - do:
      raw:
        method: GET
        path: "example-index/_search"
        body: |
          {
              "retriever": {
                  "rrf": {
                      "retrievers": [
                          {
                              "standard": {
                                  "query": {
                                      "term": {
                                          "text": "shoes"
                                      }
                                  }
                              }
                          },
                          {
                              "knn": {
                                  "field": "vector",
                                  "query_vector": [1.25, 2, 3.5],
                                  "k": 50,
                                  "num_candidates": 100
                              }
                          }
                      ],
                      "window_size": 50,
                      "rank_constant": 20
                  }
              }
          }
  - is_false: _shards.failures
---
"line_135":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
        - always_skip
      reason: example fragment
  - do:
      raw:
        method: GET
        path: "example-index/_search"
        body: |
          {
              "retriever": {
                  "rrf": {
                      "retrievers": [
                          {
                              "standard": {
                                  "query": {
                                      "term": {
                                          "text": "blue shoes sale"
                                      }
                                  }
                              }
                          },
                          {
                              "standard": {
                                  "query": {
                                      "text_expansion":{
                                          "ml.tokens":{
                                              "model_id":"my_elser_model",
                                              "model_text":"What blue shoes are on sale?"
                                          }
                                      }
                                  }
                              }
                          }
                      ],
                      "window_size": 50,
                      "rank_constant": 20
                  }
              }
          }
  - is_false: _shards.failures
---
"line_205":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "example-index"
        body: |
          {
              "mappings": {
                  "properties": {
                      "text" : {
                          "type" : "text"
                      },
                      "vector": {
                          "type": "dense_vector",
                          "dims": 1,
                          "index": true,
                          "similarity": "l2_norm"
                      },
                      "integer" : {
                          "type" : "integer"
                      }
                  }
              }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "example-index/_doc/1"
        body: |
          {
              "text" : "rrf",
              "vector" : [5],
              "integer": 1
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "example-index/_doc/2"
        body: |
          {
              "text" : "rrf rrf",
              "vector" : [4],
              "integer": 2
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "example-index/_doc/3"
        body: |
          {
              "text" : "rrf rrf rrf",
              "vector" : [3],
              "integer": 1
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "example-index/_doc/4"
        body: |
          {
              "text" : "rrf rrf rrf rrf",
              "integer": 2
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "example-index/_doc/5"
        body: |
          {
              "vector" : [0],
              "integer": 1
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "example-index/_refresh"
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "example-index/_search"
        body: |
          {
              "retriever": {
                  "rrf": {
                      "retrievers": [
                          {
                              "standard": {
                                  "query": {
                                      "term": {
                                          "text": "rrf"
                                      }
                                  }
                              }
                          },
                          {
                              "knn": {
                                  "field": "vector",
                                  "query_vector": [3],
                                  "k": 5,
                                  "num_candidates": 5
                              }
                          }
                      ],
                      "window_size": 5,
                      "rank_constant": 1
                  }
              },
              "size": 3,
              "aggs": {
                  "int_count": {
                      "terms": {
                          "field": "integer"
                      }
                  }
              }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
            "took": $body.$_path,
            "timed_out" : false,
            "_shards" : {
                "total" : 1,
                "successful" : 1,
                "skipped" : 0,
                "failed" : 0
            },
            "hits" : {
                "total" : {
                    "value" : 5,
                    "relation" : "eq"
                },
                "max_score" : null,
                "hits" : [
                    {
                        "_index" : "example-index",
                        "_id" : "3",
                        "_score" : null,
                        "_rank" : 1,
                        "_source" : {
                            "integer" : 1,
                            "vector" : [
                                3
                            ],
                            "text" : "rrf rrf rrf"
                        }
                    },
                    {
                        "_index" : "example-index",
                        "_id" : "2",
                        "_score" : null,
                        "_rank" : 2,
                        "_source" : {
                            "integer" : 2,
                            "vector" : [
                                4
                            ],
                            "text" : "rrf rrf"
                        }
                    },
                    {
                        "_index" : "example-index",
                        "_id" : "4",
                        "_score" : null,
                        "_rank" : 3,
                        "_source" : {
                            "integer" : 2,
                            "text" : "rrf rrf rrf rrf"
                        }
                    }
                ]
            },
            "aggregations" : {
                "int_count" : {
                    "doc_count_error_upper_bound" : 0,
                    "sum_other_doc_count" : 0,
                    "buckets" : [
                        {
                            "key" : 1,
                            "doc_count" : 3
                        },
                        {
                            "key" : 2,
                            "doc_count" : 2
                        }
                    ]
                }
            }
        }
