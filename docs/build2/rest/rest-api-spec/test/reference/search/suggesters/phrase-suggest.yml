---
setup:
  - do:
      raw:
        method: PUT
        path: "test"
        body: |
          {
            "settings": {
              "index": {
                "number_of_shards": 1,
                "analysis": {
                  "analyzer": {
                    "trigram": {
                      "type": "custom",
                      "tokenizer": "standard",
                      "filter": ["lowercase","shingle"]
                    },
                    "reverse": {
                      "type": "custom",
                      "tokenizer": "standard",
                      "filter": ["lowercase","reverse"]
                    }
                  },
                  "filter": {
                    "shingle": {
                      "type": "shingle",
                      "min_shingle_size": 2,
                      "max_shingle_size": 3
                    }
                  }
                }
              }
            },
            "mappings": {
              "properties": {
                "title": {
                  "type": "text",
                  "fields": {
                    "trigram": {
                      "type": "text",
                      "analyzer": "trigram"
                    },
                    "reverse": {
                      "type": "text",
                      "analyzer": "reverse"
                    }
                  }
                }
              }
            }
          }
  - do:
      raw:
        method: POST
        path: "test/_doc"
        refresh: "true"
        body: |
          {"title": "noble warriors"}
  - do:
      raw:
        method: POST
        path: "test/_doc"
        refresh: "true"
        body: |
          {"title": "nobel prize"}
---
"line_80":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "test/_search"
        body: |
          {
            "suggest": {
              "text": "noble prize",
              "simple_phrase": {
                "phrase": {
                  "field": "title.trigram",
                  "size": 1,
                  "gram_size": 3,
                  "direct_generator": [ {
                    "field": "title.trigram",
                    "suggest_mode": "always"
                  } ],
                  "highlight": {
                    "pre_tag": "<em>",
                    "post_tag": "</em>"
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "_shards": "$body._shards",
          "hits": "$body.hits",
          "timed_out": false,
          "took": "$body.took",
          "suggest": {
            "simple_phrase" : [
              {
                "text" : "noble prize",
                "offset" : 0,
                "length" : 11,
                "options" : [ {
                  "text" : "nobel prize",
                  "highlighted": "<em>nobel</em> prize",
                  "score" : 0.48614594
                }]
              }
            ]
          }
        }
---
"line_221":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "test/_search"
        body: |
          {
            "suggest": {
              "text" : "noble prize",
              "simple_phrase" : {
                "phrase" : {
                  "field" :  "title.trigram",
                  "size" :   1,
                  "direct_generator" : [ {
                    "field" :            "title.trigram",
                    "suggest_mode" :     "always",
                    "min_word_length" :  1
                  } ],
                  "collate": {
                    "query": {
                      "source" : {
                        "match": {
                          "{{field_name}}" : "{{suggestion}}"
                        }
                      }
                    },
                    "params": {"field_name" : "title"},
                    "prune": true
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_290":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "test/_search"
        body: |
          {
            "suggest": {
              "text" : "obel prize",
              "simple_phrase" : {
                "phrase" : {
                  "field" : "title.trigram",
                  "size" : 1,
                  "smoothing" : {
                    "laplace" : {
                      "alpha" : 0.7
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_410":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "test/_search"
        body: |
          {
            "suggest": {
              "text" : "obel prize",
              "simple_phrase" : {
                "phrase" : {
                  "field" : "title.trigram",
                  "size" : 1,
                  "direct_generator" : [ {
                    "field" : "title.trigram",
                    "suggest_mode" : "always"
                  }, {
                    "field" : "title.reverse",
                    "suggest_mode" : "always",
                    "pre_filter" : "reverse",
                    "post_filter" : "reverse"
                  } ]
                }
              }
            }
          }
  - is_false: _shards.failures
