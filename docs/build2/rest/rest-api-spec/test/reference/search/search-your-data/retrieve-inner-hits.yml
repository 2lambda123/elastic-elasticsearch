---
"line_90":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "test"
        body: |
          {
            "mappings": {
              "properties": {
                "comments": {
                  "type": "nested"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "test/_doc/1"
        refresh: ""
        body: |
          {
            "title": "Test title",
            "comments": [
              {
                "author": "kimchy",
                "number": 1
              },
              {
                "author": "nik9000",
                "number": 2
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_search"
        body: |
          {
            "query": {
              "nested": {
                "path": "comments",
                "query": {
                  "match": {"comments.number" : 2}
                },
                "inner_hits": {}
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "timed_out": false, "took": $body.took, "_shards": $body._shards,
          "hits": {
            "total" : {
                "value": 1,
                "relation": "eq"
            },
            "max_score": 1.0,
            "hits": [
              {
                "_index": "test",
                "_id": "1",
                "_score": 1.0,
                "_source": $body.hits.hits.0._source,
                "inner_hits": {
                  "comments": {
                    "hits": {
                      "total" : {
                          "value": 1,
                          "relation": "eq"
                      },
                      "max_score": 1.0,
                      "hits": [
                        {
                          "_index": "test",
                          "_id": "1",
                          "_nested": {
                            "field": "comments",
                            "offset": 1
                          },
                          "_score": 1.0,
                          "_source": {
                            "author": "nik9000",
                            "number": 2
                          }
                        }
                      ]
                    }
                  }
                }
              }
            ]
          }
        }
---
"line_212":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "test"
        body: |
          {
            "mappings": {
              "properties": {
                "comments": {
                  "type": "nested"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "test/_doc/1"
        refresh: ""
        body: |
          {
            "title": "Test title",
            "comments": [
              {
                "author": "kimchy",
                "text": "comment text"
              },
              {
                "author": "nik9000",
                "text": "words words words"
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_search"
        body: |
          {
            "query": {
              "nested": {
                "path": "comments",
                "query": {
                  "match": {"comments.text" : "words"}
                },
                "inner_hits": {
                  "_source" : false,
                  "docvalue_fields" : [
                    "comments.text.keyword"
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "timed_out": false, "took": $body.took, "_shards": $body._shards,
          "hits": {
            "total" : {
                "value": 1,
                "relation": "eq"
            },
            "max_score": 1.0444684,
            "hits": [
              {
                "_index": "test",
                "_id": "1",
                "_score": 1.0444684,
                "_source": $body.hits.hits.0._source,
                "inner_hits": {
                  "comments": {
                    "hits": {
                      "total" : {
                        "value": 1,
                        "relation": "eq"
                      },
                      "max_score": 1.0444684,
                      "hits": [
                        {
                          "_index": "test",
                          "_id": "1",
                          "_nested": {
                            "field": "comments",
                            "offset": 1
                          },
                          "_score": 1.0444684,
                          "fields": {
                            "comments.text.keyword": [
                              "words words words"
                            ]
                          }
                        }
                      ]
                    }
                  }
                }
              }
            ]
          }
        }
---
"line_324":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "test"
        body: |
          {
            "mappings": {
              "properties": {
                "comments": {
                  "type": "nested",
                  "properties": {
                    "votes": {
                      "type": "nested"
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "test/_doc/1"
        refresh: ""
        body: |
          {
            "title": "Test title",
            "comments": [
              {
                "author": "kimchy",
                "text": "comment text",
                "votes": []
              },
              {
                "author": "nik9000",
                "text": "words words words",
                "votes": [
                  {"value": 1 , "voter": "kimchy"},
                  {"value": -1, "voter": "other"}
                ]
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_search"
        body: |
          {
            "query": {
              "nested": {
                "path": "comments.votes",
                  "query": {
                    "match": {
                      "comments.votes.voter": "kimchy"
                    }
                  },
                  "inner_hits" : {}
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "timed_out": false, "took": $body.took, "_shards": $body._shards,
          "hits": {
            "total" : {
                "value": 1,
                "relation": "eq"
            },
            "max_score": 0.6931471,
            "hits": [
              {
                "_index": "test",
                "_id": "1",
                "_score": 0.6931471,
                "_source": $body.hits.hits.0._source,
                "inner_hits": {
                  "comments.votes": {
                    "hits": {
                      "total" : {
                          "value": 1,
                          "relation": "eq"
                      },
                      "max_score": 0.6931471,
                      "hits": [
                        {
                          "_index": "test",
                          "_id": "1",
                          "_nested": {
                            "field": "comments",
                            "offset": 1,
                            "_nested": {
                              "field": "votes",
                              "offset": 0
                            }
                          },
                          "_score": 0.6931471,
                          "_source": {
                            "value": 1,
                            "voter": "kimchy"
                          }
                        }
                      ]
                    }
                  }
                }
              }
            ]
          }
        }
---
"line_442":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "test"
        body: |
          {
            "mappings": {
              "properties": {
                "my_join_field": {
                  "type": "join",
                  "relations": {
                    "my_parent": "my_child"
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "test/_doc/1"
        refresh: ""
        body: |
          {
            "number": 1,
            "my_join_field": "my_parent"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "test/_doc/2"
        routing: "1"
        refresh: ""
        body: |
          {
            "number": 1,
            "my_join_field": {
              "name": "my_child",
              "parent": "1"
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_search"
        body: |
          {
            "query": {
              "has_child": {
                "type": "my_child",
                "query": {
                  "match": {
                    "number": 1
                  }
                },
                "inner_hits": {}
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "timed_out": false, "took": $body.took, "_shards": $body._shards,
          "hits": {
            "total": {
              "value": 1,
              "relation": "eq"
            },
            "max_score": 1.0,
            "hits": [
              {
                "_index": "test",
                "_id": "1",
                "_score": 1.0,
                "_source": {
                  "number": 1,
                  "my_join_field": "my_parent"
                },
                "inner_hits": {
                  "my_child": {
                    "hits": {
                      "total": {
                        "value": 1,
                        "relation": "eq"
                      },
                      "max_score": 1.0,
                      "hits": [
                        {
                          "_index": "test",
                          "_id": "2",
                          "_score": 1.0,
                          "_routing": "1",
                          "_source": {
                            "number": 1,
                            "my_join_field": {
                              "name": "my_child",
                              "parent": "1"
                            }
                          }
                        }
                      ]
                    }
                  }
                }
              }
            ]
          }
        }
