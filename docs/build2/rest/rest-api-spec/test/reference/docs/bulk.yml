---
"line_11":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "_bulk"
        body: |
          { "index" : { "_index" : "test", "_id" : "1" } }
          { "field1" : "value1" }
          { "delete" : { "_index" : "test", "_id" : "2" } }
          { "create" : { "_index" : "test", "_id" : "3" } }
          { "field1" : "value3" }
          { "update" : {"_id" : "1", "_index" : "test"} }
          { "doc" : {"field2" : "value2"} }
  - is_false: _shards.failures
---
"line_501":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "_bulk"
        body: |
          { "index" : { "_index" : "test", "_id" : "1" } }
          { "field1" : "value1" }
          { "delete" : { "_index" : "test", "_id" : "2" } }
          { "create" : { "_index" : "test", "_id" : "3" } }
          { "field1" : "value3" }
          { "update" : {"_id" : "1", "_index" : "test"} }
          { "doc" : {"field2" : "value2"} }
  - is_false: _shards.failures
  - match:
      $body:
        {
           "took": $body.took,
           "errors": false,
           "items": [
              {
                 "index": {
                    "_index": "test",
                    "_id": "1",
                    "_version": 1,
                    "result": "created",
                    "_shards": {
                       "total": 2,
                       "successful": 1,
                       "failed": 0
                    },
                    "status": 201,
                    "_seq_no" : $body.items.0.index._seq_no,
                    "_primary_term": 1
                 }
              },
              {
                 "delete": {
                    "_index": "test",
                    "_id": "2",
                    "_version": 1,
                    "result": "not_found",
                    "_shards": {
                       "total": 2,
                       "successful": 1,
                       "failed": 0
                    },
                    "status": 404,
                    "_seq_no" : $body.items.1.delete._seq_no,
                    "_primary_term" : $body.items.1.delete._primary_term
                 }
              },
              {
                 "create": {
                    "_index": "test",
                    "_id": "3",
                    "_version": 1,
                    "result": "created",
                    "_shards": {
                       "total": 2,
                       "successful": 1,
                       "failed": 0
                    },
                    "status": 201,
                    "_seq_no" : $body.items.2.create._seq_no,
                    "_primary_term" : $body.items.2.create._primary_term
                 }
              },
              {
                 "update": {
                    "_index": "test",
                    "_id": "1",
                    "_version": 2,
                    "result": "updated",
                    "_shards": {
                        "total": 2,
                        "successful": 1,
                        "failed": 0
                    },
                    "status": 200,
                    "_seq_no" : $body.items.3.update._seq_no,
                    "_primary_term" : $body.items.3.update._primary_term
                 }
              }
           ]
        }
---
"line_612":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "_bulk"
        body: |
          { "update" : {"_id" : "1", "_index" : "index1", "retry_on_conflict" : 3} }
          { "doc" : {"field" : "value"} }
          { "update" : { "_id" : "0", "_index" : "index1", "retry_on_conflict" : 3} }
          { "script" : { "source": "ctx._source.counter += params.param1", "lang" : "painless", "params" : {"param1" : 1}}, "upsert" : {"counter" : 1}}
          { "update" : {"_id" : "2", "_index" : "index1", "retry_on_conflict" : 3} }
          { "doc" : {"field" : "value"}, "doc_as_upsert" : true }
          { "update" : {"_id" : "3", "_index" : "index1", "_source" : true} }
          { "doc" : {"field" : "value"} }
          { "update" : {"_id" : "4", "_index" : "index1"} }
          { "doc" : {"field" : "value"}, "_source": true}
  - is_false: _shards.failures
---
"line_634":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "_bulk"
        body: |
          { "update": {"_id": "5", "_index": "index1"} }
          { "doc": {"my_field": "foo"} }
          { "update": {"_id": "6", "_index": "index1"} }
          { "doc": {"my_field": "foo"} }
          { "create": {"_id": "7", "_index": "index1"} }
          { "my_field": "foo" }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "errors": true,
          "items": [
            {
              "update": {
                "_index": "index1",
                "_id": "5",
                "status": 404,
                "error": {
                  "type": "document_missing_exception",
                  "reason": "[5]: document missing",
                  "index_uuid": $body.$_path,
                  "shard": "0",
                  "index": "index1"
                }
              }
            },
            {
              "update": {
                "_index": "index1",
                "_id": "6",
                "status": 404,
                "error": {
                  "type": "document_missing_exception",
                  "reason": "[6]: document missing",
                  "index_uuid": $body.$_path,
                  "shard": "0",
                  "index": "index1"
                }
              }
            },
            {
              "create": {
                "_index": "index1",
                "_id": "7",
                "_version": 1,
                "result": "created",
                "_shards": {
                  "total": 2,
                  "successful": 1,
                  "failed": 0
                },
                "_seq_no": $body.items.2.create._seq_no,
                "_primary_term": 1,
                "status": 201
              }
            }
          ]
        }
  - do:
      raw:
        method: POST
        path: "_bulk"
        filter_path: "items.*.error"
        body: |
          { "update": {"_id": "5", "_index": "index1"} }
          { "doc": {"my_field": "baz"} }
          { "update": {"_id": "6", "_index": "index1"} }
          { "doc": {"my_field": "baz"} }
          { "update": {"_id": "7", "_index": "index1"} }
          { "doc": {"my_field": "baz"} }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "items": [
            {
              "update": {
                "error": {
                  "type": "document_missing_exception",
                  "reason": "[5]: document missing",
                  "index_uuid": $body.$_path,
                  "shard": "0",
                  "index": "index1"
                }
              }
            },
            {
              "update": {
                "error": {
                  "type": "document_missing_exception",
                  "reason": "[6]: document missing",
                  "index_uuid": $body.$_path,
                  "shard": "0",
                  "index": "index1"
                }
              }
            }
          ]
        }
---
"line_766":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index/"
        body: |
          {
            "mappings": {
              "dynamic_templates": [
                {
                  "geo_point": {
                       "mapping": {
                          "type" : "geo_point"
                       }
                  }
                }
              ]
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "_bulk"
        body: |
          { "index" : { "_index" : "my_index", "_id" : "1", "dynamic_templates": {"work_location": "geo_point"}} }
          { "field" : "value1", "work_location": "41.12,-71.34", "raw_location": "41.12,-71.34"}
          { "create" : { "_index" : "my_index", "_id" : "2", "dynamic_templates": {"home_location": "geo_point"}} }
          { "field" : "value2", "home_location": "41.12,-71.34"}
  - is_false: _shards.failures
