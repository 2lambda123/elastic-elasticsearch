---
setup:
  - do:
      raw:
        method: PUT
        path: "reports"
        body: |
          {
            "mappings": {
              "properties": {
                "force": {
                  "type": "keyword"
                },
                "crime_type": {
                  "type": "keyword"
                }
              }
            }
          }
  - do:
      raw:
        method: POST
        path: "reports/_bulk"
        refresh: ""
        body: |
          {"index":{"_id":0}}
          {"force": "British Transport Police", "crime_type": "Bicycle theft"}
          {"index":{"_id":1}}
          {"force": "British Transport Police", "crime_type": "Bicycle theft"}
          {"index":{"_id":2}}
          {"force": "British Transport Police", "crime_type": "Bicycle theft"}
          {"index":{"_id":3}}
          {"force": "British Transport Police", "crime_type": "Robbery"}
          {"index":{"_id":4}}
          {"force": "Metropolitan Police Service", "crime_type": "Robbery"}
          {"index":{"_id":5}}
          {"force": "Metropolitan Police Service", "crime_type": "Bicycle theft"}
          {"index":{"_id":6}}
          {"force": "Metropolitan Police Service", "crime_type": "Robbery"}
          {"index":{"_id":7}}
          {"force": "Metropolitan Police Service", "crime_type": "Robbery"}
---
"significantterms-aggregation-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        filter_path: "aggregations"
        body: |
          {
            "query": {
              "terms": { "force": [ "British Transport Police" ] }
            },
            "aggregations": {
              "significant_crime_types": {
                "significant_terms": { "field": "crime_type" }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          
          "aggregations": {
            "significant_crime_types": {
              "doc_count": $body.$_path,
              "bg_count": $body.$_path,
              "buckets": [
                {
                  "key": "Bicycle theft",
                  "doc_count": $body.$_path,
                  "score": $body.$_path,
                  "bg_count": $body.$_path
                }
                      
              ]
            }
          }
        }
---
"significantterms-aggregation-multiset--example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        filter_path: "aggregations"
        body: |
          {
            "aggregations": {
              "forces": {
                "terms": { "field": "force" },
                "aggregations": {
                  "significant_crime_types": {
                    "significant_terms": { "field": "crime_type" }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
         
         "aggregations": {
            "forces": {
                "doc_count_error_upper_bound": $body.$_path,
                "sum_other_doc_count": $body.$_path,
                "buckets": [
                    {
                        "key": $body.$_path,
                        "doc_count": $body.$_path,
                        "significant_crime_types": {
                            "doc_count": $body.$_path,
                            "bg_count": $body.$_path,
                            "buckets": [
                                {
                                    "key": $body.$_path,
                                    "doc_count": $body.$_path,
                                    "score": $body.$_path,
                                    "bg_count": $body.$_path
                                }
                                
                            ]
                        }
                    },
                    {
                        "key": $body.$_path,
                        "doc_count": $body.$_path,
                        "significant_crime_types": {
                            "doc_count": $body.$_path,
                            "bg_count": $body.$_path,
                            "buckets": [
                                {
                                    "key": $body.$_path,
                                    "doc_count": $body.$_path,
                                    "score": $body.$_path,
                                    "bg_count": $body.$_path
                                }
                                
                            ]
                        }
                    }
                ]
            }
          }
        }
---
"significantterms-aggregation-hotspot-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "aggs": {
              "hotspots": {
                "geohash_grid": {
                  "field": "location",
                  "precision": 5
                },
                "aggs": {
                  "significant_crime_types": {
                    "significant_terms": { "field": "crime_type" }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_412":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        size: "0"
        body: |
          {
            "query": {
              "bool": {
                "filter": [
                  {
                    "term": {
                      "event.outcome": "failure"
                    }
                  },
                  {
                    "range": {
                      "@timestamp": {
                        "gte": "2021-02-01",
                        "lt": "2021-02-04"
                      }
                    }
                  },
                  {
                    "term": {
                      "service.name": {
                        "value": "frontend-node"
                      }
                    }
                  }
                ]
              }
            },
            "aggs": {
              "failure_p_value": {
                "significant_terms": {
                  "field": "user_agent.version",
                  "background_filter": {
                    "bool": {
                      "must_not": [
                        {
                          "term": {
                            "event.outcome": "failure"
                          }
                        }
                      ],
                      "filter": [
                        {
                          "range": {
                            "@timestamp": {
                              "gte": "2021-02-01",
                              "lt": "2021-02-04"
                            }
                          }
                        },
                        {
                          "term": {
                            "service.name": {
                              "value": "frontend-node"
                            }
                          }
                        }
                      ]
                    }
                  },
                  "p_value": {"background_is_superset": false, "normalize_above": 1000}
                }
              }
            }
          }
  - is_false: _shards.failures
---
"significantterms-aggregation-min-document-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "aggs": {
              "tags": {
                "significant_terms": {
                  "field": "tag",
                  "min_doc_count": 10
                }
              }
            }
          }
  - is_false: _shards.failures
---
"significantterms-aggregation-custom-background-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "query": {
              "match": {
                "city": "madrid"
              }
            },
            "aggs": {
              "tags": {
                "significant_terms": {
                  "field": "tag",
                  "background_filter": {
                    "term": { "text": "spain" }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"significantterms-aggregation-execution-hint-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "aggs": {
              "tags": {
                "significant_terms": {
                  "field": "tags",
                  "execution_hint": "map"
                }
              }
            }
          }
  - is_false: _shards.failures
