---
setup:
  - do:
      raw:
        method: PUT
        path: "sales"
        body: |
          {
            "mappings": {
              "properties": {
                "product": {
                    "type": "keyword"
                },
                "timestamp": {
                    "type": "date"
                },
                "price": {
                    "type": "long"
                },
                "shop": {
                    "type": "keyword"
                },
                "location": {
                    "type": "geo_point"
                },
                "nested": {
                    "type": "nested",
                    "properties": {
                      "product": {
                          "type": "keyword"
                      },
                      "timestamp": {
                          "type": "date"
                      },
                      "price": {
                          "type": "long"
                      },
                      "shop": {
                          "type": "keyword"
                      }
                    }
                 }
              }
            }
          }
  - do:
      raw:
        method: POST
        path: "sales/_bulk"
        refresh: ""
        body: |
          {"index":{"_id":0}}
          {"product": "mad max", "price": "20", "timestamp": "2017-05-09T14:35"}
          {"index":{"_id":1}}
          {"product": "mad max", "price": "25", "timestamp": "2017-05-09T12:35"}
          {"index":{"_id":2}}
          {"product": "rocky", "price": "10", "timestamp": "2017-05-08T09:10"}
          {"index":{"_id":3}}
          {"product": "mad max", "price": "27", "timestamp": "2017-05-10T07:07"}
          {"index":{"_id":4}}
          {"product": "apocalypse now", "price": "10", "timestamp": "2017-05-11T08:35"}
---
"composite-aggregation-terms-field-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "product": { "terms": { "field": "product" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-terms-runtime-field-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "runtime_mappings": {
              "day_of_week": {
                "type": "keyword",
                "script": "\n        emit(doc['timestamp'].value.dayOfWeekEnum\n          .getDisplayName(TextStyle.FULL, Locale.ROOT))\n      "
              }
            },
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    {
                      "dow": {
                        "terms": { "field": "day_of_week" }
                      }
                    }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "timed_out": false,
          "took": "$body.took",
          "_shards": {
            "total": 1,
            "successful": 1,
            "failed": 0,
            "skipped": 0
          },
          "hits": "$body.hits",
          "aggregations": {
            "my_buckets": {
              "after_key": { "dow": "Wednesday" },
              "buckets": [
                { "key": { "dow": "Monday"    }, "doc_count": 1 },
                { "key": { "dow": "Thursday"  }, "doc_count": 1 },
                { "key": { "dow": "Tuesday"   }, "doc_count": 2 },
                { "key": { "dow": "Wednesday" }, "doc_count": 1 }
              ]
            }
          }
        }
---
"composite-aggregation-histogram-field-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "histo": { "histogram": { "field": "price", "interval": 5 } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-histogram-runtime-field-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "runtime_mappings": {
              "price.discounted": {
                "type": "double",
                "script": "\n        double price = doc['price'].value;\n        if (doc['product'].value == 'mad max') {\n          price *= 0.8;\n        }\n        emit(price);\n      "
              }
            },
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    {
                      "price": {
                        "histogram": {
                          "interval": 5,
                          "field": "price.discounted"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "timed_out": false,
          "took": "$body.took",
          "_shards": {
            "total": 1,
            "successful": 1,
            "failed": 0,
            "skipped": 0
          },
          "hits": "$body.hits",
          "aggregations": {
            "my_buckets": {
              "after_key": { "price": 20.0 },
              "buckets": [
                { "key": { "price": 10.0 }, "doc_count": 2 },
                { "key": { "price": 15.0 }, "doc_count": 1 },
                { "key": { "price": 20.0 }, "doc_count": 2 }
              ]
            }
          }
        }
---
"composite-aggregation-datehistogram-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-datehistogram-format-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    {
                      "date": {
                        "date_histogram": {
                          "field": "timestamp",
                          "calendar_interval": "1d",
                          "format": "yyyy-MM-dd"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-datehistogram-offset-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/1"
        refresh: ""
        body: |
          {
            "date": "2015-10-01T05:30:00Z"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/2"
        refresh: ""
        body: |
          {
            "date": "2015-10-01T06:30:00Z"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_search"
        size: "0"
        body: |
          {
            "aggs": {
              "my_buckets": {
                "composite" : {
                  "sources" : [
                    {
                      "date": {
                        "date_histogram" : {
                          "field": "date",
                          "calendar_interval": "day",
                          "offset": "+6h",
                          "format": "iso8601"
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,"timed_out": false,"_shards": $body._shards,"hits": $body.hits,
          "aggregations": {
            "my_buckets": {
              "after_key": { "date": "2015-10-01T06:00:00.000Z" },
              "buckets": [
                {
                  "key": { "date": "2015-09-30T06:00:00.000Z" },
                  "doc_count": 1
                },
                {
                  "key": { "date": "2015-10-01T06:00:00.000Z" },
                  "doc_count": 1
                }
              ]
            }
          }
        }
---
"composite-aggregation-geotilegrid-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "tile": { "geotile_grid": { "field": "location", "precision": 8 } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-geotilegrid-boundingbox-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    {
                      "tile": {
                        "geotile_grid": {
                          "field": "location",
                          "precision": 22,
                          "bounds": {
                            "top_left": "POINT (4.9 52.4)",
                            "bottom_right": "POINT (5.0 52.3)"
                          }
                        }
                      }
                    }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-mixing-sources-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d" } } },
                    { "product": { "terms": { "field": "product" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-mixing-three-sources-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "shop": { "terms": { "field": "shop" } } },
                    { "product": { "terms": { "field": "product" } } },
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-order-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d", "order": "desc" } } },
                    { "product": { "terms": { "field": "product", "order": "asc" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-missing-bucket-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [{
                    "product_name": {
                      "terms": {
                        "field": "product",
                        "missing_bucket": true,
                        "missing_order": "last"
                      }
                    }
                  }]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-after-key-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        filter_path: "aggregations"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "size": 2,
                  "sources": [
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d" } } },
                    { "product": { "terms": { "field": "product" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          
          "aggregations": {
            "my_buckets": {
              "after_key": {
                "date": 1494288000000,
                "product": "mad max"
              },
              "buckets": [
                {
                  "key": {
                    "date": 1494201600000,
                    "product": "rocky"
                  },
                  "doc_count": 1
                },
                {
                  "key": {
                    "date": 1494288000000,
                    "product": "mad max"
                  },
                  "doc_count": 2
                }
              ]
            }
          }
        }
---
"composite-aggregation-after-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "size": 2,
                  "sources": [
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d", "order": "desc" } } },
                    { "product": { "terms": { "field": "product", "order": "asc" } } }
                  ],
                  "after": { "date": 1494288000000, "product": "mad max" }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_748":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "settings": {
              "index": {
                "sort.field": [ "username", "timestamp" ],
                "sort.order": [ "asc", "desc" ]
              }
            },
            "mappings": {
              "properties": {
                "username": {
                  "type": "keyword",
                  "doc_values": true
                },
                "timestamp": {
                  "type": "date"
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_777":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "user_name": { "terms": { "field": "user_name" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_796":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "user_name": { "terms": { "field": "user_name" } } },
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d", "order": "desc" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_821":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "size": 0,
            "track_total_hits": false,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "user_name": { "terms": { "field": "user_name" } } },
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d", "order": "desc" } } }
                  ]
                }
              }
            }
          }
  - is_false: _shards.failures
---
"composite-aggregation-subaggregations-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        filter_path: "aggregations"
        body: |
          {
            "size": 0,
            "aggs": {
              "my_buckets": {
                "composite": {
                  "sources": [
                    { "date": { "date_histogram": { "field": "timestamp", "calendar_interval": "1d", "order": "desc" } } },
                    { "product": { "terms": { "field": "product" } } }
                  ]
                },
                "aggregations": {
                  "the_avg": {
                    "avg": { "field": "price" }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          
          "aggregations": {
            "my_buckets": {
              "after_key": {
                "date": 1494201600000,
                "product": "rocky"
              },
              "buckets": [
                {
                  "key": {
                    "date": 1494460800000,
                    "product": "apocalypse now"
                  },
                  "doc_count": 1,
                  "the_avg": {
                    "value": 10.0
                  }
                },
                {
                  "key": {
                    "date": 1494374400000,
                    "product": "mad max"
                  },
                  "doc_count": 1,
                  "the_avg": {
                    "value": 27.0
                  }
                },
                {
                  "key": {
                    "date": 1494288000000,
                    "product": "mad max"
                  },
                  "doc_count": 2,
                  "the_avg": {
                    "value": 22.5
                  }
                },
                {
                  "key": {
                    "date": 1494201600000,
                    "product": "rocky"
                  },
                  "doc_count": 1,
                  "the_avg": {
                    "value": 10.0
                  }
                }
              ]
            }
          }
        }
