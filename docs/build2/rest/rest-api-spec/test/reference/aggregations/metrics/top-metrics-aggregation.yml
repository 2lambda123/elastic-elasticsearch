---
"search-aggregations-metrics-top-metrics-simple":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "test/_bulk"
        refresh: ""
        body: |
          {"index": {}}
          {"s": 1, "m": 3.1415}
          {"index": {}}
          {"s": 2, "m": 1.0}
          {"index": {}}
          {"s": 3, "m": 2.71828}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "tm": {
                "top_metrics": {
                  "metrics": {"field": "m"},
                  "sort": {"s": "desc"}
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "tm": {
              "top": [ {"sort": [3], "metrics": {"m": 2.718280076980591 } } ]
            }
          }
        }
---
"search-aggregations-metrics-top-metrics-list-of-metrics":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "test"
        body: |
          {
            "mappings": {
              "properties": {
                "d": {"type": "date"}
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_bulk"
        refresh: ""
        body: |
          {"index": {}}
          {"s": 1, "m": 3.1415, "i": 1, "d": "2020-01-01T00:12:12Z", "t": "cat"}
          {"index": {}}
          {"s": 2, "m": 1.0, "i": 6, "d": "2020-01-02T00:12:12Z", "t": "dog"}
          {"index": {}}
          {"s": 3, "m": 2.71828, "i": -12, "d": "2019-12-31T00:12:12Z", "t": "chicken"}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "tm": {
                "top_metrics": {
                  "metrics": [
                    {"field": "m"},
                    {"field": "i"},
                    {"field": "d"},
                    {"field": "t.keyword"}
                  ],
                  "sort": {"s": "desc"}
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "tm": {
              "top": [ {
                "sort": [3],
                "metrics": {
                  "m": 2.718280076980591,
                  "i": -12,
                  "d": "2019-12-31T00:12:12.000Z",
                  "t.keyword": "chicken"
                }
              } ]
            }
          }
        }
---
"line_154":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index"
        body: |
          {
            "mappings": {
              "properties": {
                "nr":    { "type": "integer" },
                "state":  { "type": "keyword"  }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index/_bulk"
        refresh: ""
        body: |
          {"index": {}}
          {"nr": 1, "state": "started"}
          {"index": {}}
          {"nr": 2, "state": "stopped"}
          {"index": {}}
          {"nr": 3, "state": "N/A"}
          {"index": {}}
          {"nr": 4}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "my_top_metrics": {
                "top_metrics": {
                  "metrics": {
                    "field": "state",
                    "missing": "N/A"},
                  "sort": {"nr": "desc"}
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "my_top_metrics": {
              "top": [
                {
                  "sort": [
                    4
                  ],
                  "metrics": {
                    "state": "N/A"
                  }
                }
              ]
            }
          }
        }
---
"search-aggregations-metrics-top-metrics-size":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "test/_bulk"
        refresh: ""
        body: |
          {"index": {}}
          {"s": 1, "m": 3.1415}
          {"index": {}}
          {"s": 2, "m": 1.0}
          {"index": {}}
          {"s": 3, "m": 2.71828}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "tm": {
                "top_metrics": {
                  "metrics": {"field": "m"},
                  "sort": {"s": "desc"},
                  "size": 3
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "tm": {
              "top": [
                {"sort": [3], "metrics": {"m": 2.718280076980591 } },
                {"sort": [2], "metrics": {"m": 1.0 } },
                {"sort": [1], "metrics": {"m": 3.1414999961853027 } }
              ]
            }
          }
        }
  - do:
      raw:
        method: PUT
        path: "test/_settings"
        body: |
          {
            "top_metrics_max_size": 100
          }
  - is_false: _shards.failures
---
"search-aggregations-metrics-top-metrics-terms":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "node"
        body: |
          {
            "mappings": {
              "properties": {
                "ip": {"type": "ip"},
                "date": {"type": "date"}
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "node/_bulk"
        refresh: ""
        body: |
          {"index": {}}
          {"ip": "192.168.0.1", "date": "2020-01-01T01:01:01", "m": 1}
          {"index": {}}
          {"ip": "192.168.0.1", "date": "2020-01-01T02:01:01", "m": 2}
          {"index": {}}
          {"ip": "192.168.0.2", "date": "2020-01-01T02:01:01", "m": 3}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "node/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "ip": {
                "terms": {
                  "field": "ip"
                },
                "aggs": {
                  "tm": {
                    "top_metrics": {
                      "metrics": {"field": "m"},
                      "sort": {"date": "desc"}
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "ip": {
              "buckets": [
                {
                  "key": "192.168.0.1",
                  "doc_count": 2,
                  "tm": {
                    "top": [ {"sort": ["2020-01-01T02:01:01.000Z"], "metrics": {"m": 2 } } ]
                  }
                },
                {
                  "key": "192.168.0.2",
                  "doc_count": 1,
                  "tm": {
                    "top": [ {"sort": ["2020-01-01T02:01:01.000Z"], "metrics": {"m": 3 } } ]
                  }
                }
              ],
              "doc_count_error_upper_bound": 0,
              "sum_other_doc_count": 0
            }
          }
        }
  - do:
      raw:
        method: POST
        path: "node/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "ip": {
                "terms": {
                  "field": "ip",
                  "order": {"tm.m": "desc"}
                },
                "aggs": {
                  "tm": {
                    "top_metrics": {
                      "metrics": {"field": "m"},
                      "sort": {"date": "desc"}
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "ip": {
              "buckets": [
                {
                  "key": "192.168.0.2",
                  "doc_count": 1,
                  "tm": {
                    "top": [ {"sort": ["2020-01-01T02:01:01.000Z"], "metrics": {"m": 3 } } ]
                  }
                },
                {
                  "key": "192.168.0.1",
                  "doc_count": 2,
                  "tm": {
                    "top": [ {"sort": ["2020-01-01T02:01:01.000Z"], "metrics": {"m": 2 } } ]
                  }
                }
              ],
              "doc_count_error_upper_bound": 0,
              "sum_other_doc_count": 0
            }
          }
        }
---
"search-aggregations-metrics-top-metrics-mixed-sort":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "test/_bulk"
        refresh: ""
        body: |
          {"index": {"_index": "test1"}}
          {"s": 1, "m": 3.1415}
          {"index": {"_index": "test1"}}
          {"s": 2, "m": 1}
          {"index": {"_index": "test2"}}
          {"s": 3.1, "m": 2.71828}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test*/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "tm": {
                "top_metrics": {
                  "metrics": {"field": "m"},
                  "sort": {"s": "asc"}
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "tm": {
              "top": [ {"sort": [3.0999999046325684], "metrics": {"m": 2.718280076980591 } } ]
            }
          }
        }
  - do:
      raw:
        method: POST
        path: "test*/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "tm": {
                "top_metrics": {
                  "metrics": {"field": "m"},
                  "sort": {"s": {"order": "asc", "numeric_type": "double"}}
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "tm": {
              "top": [ {"sort": [1.0], "metrics": {"m": 3.1414999961853027 } } ]
            }
          }
        }
  - do:
      raw:
        method: POST
        path: "test*/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "ip": {
                "terms": {
                  "field": "ip"
                },
                "aggs": {
                  "tm": {
                    "top_metrics": {
                      "metrics": {"field": "m"},
                      "sort": {"s": "desc"},
                      "size": 1
                    }
                  },
                  "having_tm": {
                    "bucket_selector": {
                      "buckets_path": {
                        "top_m": "tm[m]"
                      },
                      "script": "params.top_m < 1000"
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
