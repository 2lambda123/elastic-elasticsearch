---
setup:
  - do:
      raw:
        method: PUT
        path: "statistics/_doc/0"
        body: |
          {"poverty": 24.0, "income": 50000.0}
  - do:
      raw:
        method: PUT
        path: "statistics/_doc/1"
        body: |
          {"poverty": 13.0, "income": 95687.0}
  - do:
      raw:
        method: PUT
        path: "statistics/_doc/2"
        body: |
          {"poverty": 69.0, "income": 7890.0}
  - do:
      raw:
        method: POST
        path: "_refresh"
---
"stats-aggregation-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "statistics": {
                "matrix_stats": {
                  "fields": [ "poverty", "income" ]
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          
          "aggregations": {
            "statistics": {
              "doc_count": $body.$_path,
              "fields": [ {
                  "name": "income",
                  "count": $body.$_path,
                  "mean": $body.$_path,
                  "variance": $body.$_path,
                  "skewness": $body.$_path,
                  "kurtosis": $body.$_path,
                  "covariance": {
                    "income": $body.$_path,
                    "poverty": $body.$_path
                  },
                  "correlation": {
                    "income": $body.$_path,
                    "poverty": $body.$_path
                  }
                }, {
                  "name": "poverty",
                  "count": $body.$_path,
                  "mean": $body.$_path,
                  "variance": $body.$_path,
                  "skewness": $body.$_path,
                  "kurtosis": $body.$_path,
                  "covariance": {
                    "income": $body.$_path,
                    "poverty": $body.$_path
                  },
                  "correlation": {
                    "income": $body.$_path,
                    "poverty": $body.$_path
                  }
                } ]
            }
          }
        }
---
"stats-aggregation-missing-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_search"
        body: |
          {
            "aggs": {
              "matrixstats": {
                "matrix_stats": {
                  "fields": [ "poverty", "income" ],
                  "missing": { "income": 50000 }
                }
              }
            }
          }
  - is_false: _shards.failures
