---
"search-aggregations-metrics-geo-line-simple":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "test"
        body: |
          {
              "mappings": {
                  "properties": {
                      "my_location": { "type": "geo_point" },
                      "group":       { "type": "keyword" },
                      "@timestamp":  { "type": "date" }
                  }
              }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_bulk"
        refresh: ""
        body: |
          {"index":{}}
          {"my_location": {"lat":52.373184, "lon":4.889187}, "@timestamp": "2023-01-02T09:00:00Z"}
          {"index":{}}
          {"my_location": {"lat":52.370159, "lon":4.885057}, "@timestamp": "2023-01-02T10:00:00Z"}
          {"index":{}}
          {"my_location": {"lat":52.369219, "lon":4.901618}, "@timestamp": "2023-01-02T13:00:00Z"}
          {"index":{}}
          {"my_location": {"lat":52.374081, "lon":4.912350}, "@timestamp": "2023-01-02T16:00:00Z"}
          {"index":{}}
          {"my_location": {"lat":52.371667, "lon":4.914722}, "@timestamp": "2023-01-03T12:00:00Z"}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "test/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggs": {
              "line": {
                "geo_line": {
                  "point": {"field": "my_location"},
                  "sort":  {"field": "@timestamp"}
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "line": {
              "type": "Feature",
              "geometry": {
                "type": "LineString",
                "coordinates": [
                    [ 4.889187, 52.373184 ],
                    [ 4.885057, 52.370159 ],
                    [ 4.901618, 52.369219 ],
                    [ 4.912350, 52.374081 ],
                    [ 4.914722, 52.371667 ]
                ]
              },
              "properties": {
                "complete": true
              }
            }
          }
        }
---
"search-aggregations-metrics-geo-line-grouping-setup":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "tour"
        body: |
          {
              "mappings": {
                  "properties": {
                      "city": {
                          "type": "keyword",
                          "time_series_dimension": true
                      },
                      "category":   { "type": "keyword" },
                      "route":      { "type": "long" },
                      "name":       { "type": "keyword" },
                      "location":   { "type": "geo_point" },
                      "@timestamp": { "type": "date" }
                  }
              },
              "settings": {
                  "index": {
                      "mode": "time_series",
                      "routing_path": [ "city" ],
                      "time_series": {
                          "start_time": "2023-01-01T00:00:00Z",
                          "end_time": "2024-01-01T00:00:00Z"
                      }
                  }
              }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "tour/_bulk"
        refresh: ""
        body: |
          {"index":{}}
          {"@timestamp": "2023-01-02T09:00:00Z", "route": 0, "location": "POINT(4.889187 52.373184)", "city": "Amsterdam", "category": "Attraction", "name": "Royal Palace Amsterdam"}
          {"index":{}}
          {"@timestamp": "2023-01-02T10:00:00Z", "route": 1, "location": "POINT(4.885057 52.370159)", "city": "Amsterdam", "category": "Attraction", "name": "The Amsterdam Dungeon"}
          {"index":{}}
          {"@timestamp": "2023-01-02T13:00:00Z", "route": 2, "location": "POINT(4.901618 52.369219)", "city": "Amsterdam", "category": "Museum", "name": "Museum Het Rembrandthuis"}
          {"index":{}}
          {"@timestamp": "2023-01-02T16:00:00Z", "route": 3, "location": "POINT(4.912350 52.374081)", "city": "Amsterdam", "category": "Museum", "name": "NEMO Science Museum"}
          {"index":{}}
          {"@timestamp": "2023-01-03T12:00:00Z", "route": 4, "location": "POINT(4.914722 52.371667)", "city": "Amsterdam", "category": "Museum", "name": "Nederlands Scheepvaartmuseum"}
          {"index":{}}
          {"@timestamp": "2023-01-04T09:00:00Z", "route": 5, "location": "POINT(4.401384 51.220292)", "city": "Antwerp", "category": "Attraction", "name": "Cathedral of Our Lady"}
          {"index":{}}
          {"@timestamp": "2023-01-04T12:00:00Z", "route": 6, "location": "POINT(4.405819 51.221758)", "city": "Antwerp", "category": "Museum", "name": "Snijders&Rockoxhuis"}
          {"index":{}}
          {"@timestamp": "2023-01-04T15:00:00Z", "route": 7, "location": "POINT(4.405200 51.222900)", "city": "Antwerp", "category": "Museum", "name": "Letterenhuis"}
          {"index":{}}
          {"@timestamp": "2023-01-05T10:00:00Z", "route": 8, "location": "POINT(2.336389 48.861111)", "city": "Paris", "category": "Museum", "name": "Musée du Louvre"}
          {"index":{}}
          {"@timestamp": "2023-01-05T14:00:00Z", "route": 9, "location": "POINT(2.327000 48.860000)", "city": "Paris", "category": "Museum", "name": "Musée dOrsay"}
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "tour/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggregations": {
              "path": {
                "terms": {"field": "city"},
                "aggregations": {
                  "museum_tour": {
                    "geo_line": {
                      "point": {"field": "location"},
                      "sort": {"field": "@timestamp"}
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "path": {
              "doc_count_error_upper_bound": 0,
              "sum_other_doc_count": 0,
              "buckets": [
                {
                  "key": "Amsterdam",
                  "doc_count": 5,
                  "museum_tour": {
                    "type": "Feature",
                    "geometry": {
                      "coordinates": [ [ 4.889187, 52.373184 ], [ 4.885057, 52.370159 ], [ 4.901618, 52.369219 ], [ 4.91235, 52.374081 ], [ 4.914722, 52.371667 ] ],
                      "type": "LineString"
                    },
                    "properties": {
                      "complete": true
                    }
                  }
                },
                {
                  "key": "Antwerp",
                  "doc_count": 3,
                  "museum_tour": {
                    "type": "Feature",
                    "geometry": {
                      "coordinates": [ [ 4.401384, 51.220292 ], [ 4.405819, 51.221758 ], [ 4.4052, 51.2229 ] ],
                      "type": "LineString"
                    },
                    "properties": {
                      "complete": true
                    }
                  }
                },
                {
                  "key": "Paris",
                  "doc_count": 2,
                  "museum_tour": {
                    "type": "Feature",
                    "geometry": {
                      "coordinates": [ [ 2.336389, 48.861111 ], [ 2.327, 48.86 ] ],
                      "type": "LineString"
                    },
                    "properties": {
                      "complete": true
                    }
                  }
                }
              ]
            }
          }
        }
  - do:
      raw:
        method: POST
        path: "tour/_search"
        filter_path: "aggregations"
        body: |
          {
            "aggregations": {
              "path": {
                "time_series": {},
                "aggregations": {
                  "museum_tour": {
                    "geo_line": {
                      "point": {"field": "location"}
                    }
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "path": {
              "buckets": {
                "{city=Paris}": {
                  "key": {
                    "city": "Paris"
                  },
                  "doc_count": 2,
                  "museum_tour": {
                    "type": "Feature",
                    "geometry": {
                      "coordinates": [ [ 2.336389, 48.861111 ], [ 2.327, 48.86 ] ],
                      "type": "LineString"
                    },
                    "properties": {
                      "complete": true
                    }
                  }
                },
                "{city=Antwerp}": {
                  "key": {
                    "city": "Antwerp"
                  },
                  "doc_count": 3,
                  "museum_tour": {
                    "type": "Feature",
                    "geometry": {
                      "coordinates": [ [ 4.401384, 51.220292 ], [ 4.405819, 51.221758 ], [ 4.4052, 51.2229 ] ],
                      "type": "LineString"
                    },
                    "properties": {
                      "complete": true
                    }
                  }
                },
                "{city=Amsterdam}": {
                  "key": {
                    "city": "Amsterdam"
                  },
                  "doc_count": 5,
                  "museum_tour": {
                    "type": "Feature",
                    "geometry": {
                      "coordinates": [ [ 4.889187, 52.373184 ], [ 4.885057, 52.370159 ], [ 4.901618, 52.369219 ], [ 4.91235, 52.374081 ], [ 4.914722, 52.371667 ] ],
                      "type": "LineString"
                    },
                    "properties": {
                      "complete": true
                    }
                  }
                }
              }
            }
          }
        }
