---
setup:
  - do:
      raw:
        method: POST
        path: "_ilm/stop"
  - do:
      raw:
        method: PUT
        path: "_template/global-template"
        body: |
          {
            "index_patterns": ["migrate-to-tiers-*"],
            "settings": {
               "index.routing.allocation.require.custom_attribute_name": "hot"
            }
          }
  - do:
      raw:
        method: PUT
        path: "_template/a-legacy-template"
        body: |
          {
            "index_patterns": ["legacy-template-migrate-to-tiers-*"],
            "settings": {
               "index.routing.allocation.require.custom_attribute_name": "hot"
            }
          }
  - do:
      raw:
        method: PUT
        path: "_index_template/a-composable-template"
        body: |
          {
          	"index_patterns": [ "composable-template-migrate-to-tiers-*" ],
          	"data_stream": {},
          	"template" : {
          		"settings": {
          			 "index.routing.allocation.require.custom_attribute_name": "hot"
          		}
          	}
          }
  - do:
      raw:
        method: PUT
        path: "_component_template/a-component-template"
        body: |
          {
          	"template" : {
          		"settings": {
          			 "index.routing.allocation.require.custom_attribute_name": "hot"
          		}
          	}
          }
  - do:
      raw:
        method: PUT
        path: "warm-index-to-migrate-000001"
        body: |
          {
            "settings": {
              "index.routing.allocation.require.custom_attribute_name": "warm"
            }
          }
  - do:
      raw:
        method: PUT
        path: "_ilm/policy/policy_with_allocate_action"
        body: |
          {
            "policy": {
              "phases": {
                "warm": {
                  "actions": {
                    "allocate": {
                      "require": {
                        "custom_attribute_name": "warm"
                      }
                    }
                  }
                },
                "delete": {
                  "min_age": "30d",
                  "actions": {
                    "delete": {}
                  }
                }
              }
            }
          }
---
teardown:
  - do:
      raw:
        method: DELETE
        path: "warm-index-to-migrate-000001"
  - do:
      raw:
        method: DELETE
        path: "_ilm/policy/policy_with_allocate_action"
  - do:
      raw:
        method: DELETE
        path: "_template/a-legacy-template"
  - do:
      raw:
        method: DELETE
        path: "_index_template/a-composable-template"
  - do:
      raw:
        method: DELETE
        path: "_component_template/a-component-template"
  - do:
      raw:
        method: POST
        path: "_ilm/start"
---
"line_154":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "_ilm/migrate_to_data_tiers"
        body: |
          {
            "legacy_template_to_delete": "global-template",
            "node_attribute": "custom_attribute_name"
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "dry_run": false,
          "removed_legacy_template":"global-template",
          "migrated_ilm_policies":["policy_with_allocate_action"],
          "migrated_indices":["warm-index-to-migrate-000001"],
          "migrated_legacy_templates":["a-legacy-template"],
          "migrated_composable_templates":["a-composable-template"],
          "migrated_component_templates":["a-component-template"]
        }
