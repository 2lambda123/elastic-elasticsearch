---
"line_89":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index"
        body: |
          {
            "mappings": {
              "properties": {
                "message": {
                  "type": "wildcard"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "_scripts/painless/_execute"
        body: |
          {
            "script": {
              "source": "\n      String response=dissect('%{clientip} %{ident} %{auth} [%{@timestamp}] \"%{verb} %{request} HTTP/%{httpversion}\" %{response} %{size}').extract(doc[\"message\"].value)?.response;\n        if (response != null) emit(Integer.parseInt(response));\n    "
            },
            "context": "long_field",
            "context_setup": {
              "index": "my-index",
              "document": {
                "message": "247.37.0.0 - - [30/Apr/2020:14:31:22 -0500] \"GET /images/hm_nbg.jpg HTTP/1.0\" 304 0"
              }
            }
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "result" : [
            304
          ]
        }
---
"line_162":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index/"
        body: |
          {
            "mappings": {
              "properties": {
                "@timestamp": {
                  "format": "strict_date_optional_time||epoch_second",
                  "type": "date"
                },
                "message": {
                  "type": "wildcard"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index/_mappings"
        body: |
          {
            "runtime": {
              "http.response": {
                "type": "long",
                "script": "\n        String response=dissect('%{clientip} %{ident} %{auth} [%{@timestamp}] \"%{verb} %{request} HTTP/%{httpversion}\" %{response} %{size}').extract(doc[\"message\"].value)?.response;\n        if (response != null) emit(Integer.parseInt(response));\n      "
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index/_bulk"
        refresh: "true"
        body: |
          {"index":{}}
          {"timestamp":"2020-04-30T14:30:17-05:00","message":"40.135.0.0 - - [30/Apr/2020:14:30:17 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:30:53-05:00","message":"232.0.0.0 - - [30/Apr/2020:14:30:53 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:12-05:00","message":"26.1.0.0 - - [30/Apr/2020:14:31:12 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:19-05:00","message":"247.37.0.0 - - [30/Apr/2020:14:31:19 -0500] \"GET /french/splash_inet.html HTTP/1.0\" 200 3781"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:22-05:00","message":"247.37.0.0 - - [30/Apr/2020:14:31:22 -0500] \"GET /images/hm_nbg.jpg HTTP/1.0\" 304 0"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:27-05:00","message":"252.0.0.0 - - [30/Apr/2020:14:31:27 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:28-05:00","message":"not a valid apache log"}
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index/_search"
        body: |
          {
            "query": {
              "match": {
                "http.response": "304"
              }
            },
            "fields" : ["http.response"]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index/_search"
        filter_path: "hits"
        body: |
          {
            "runtime_mappings": {
              "http.response": {
                "type": "long",
                "script": "\n        String response=dissect('%{clientip} %{ident} %{auth} [%{@timestamp}] \"%{verb} %{request} HTTP/%{httpversion}\" %{response} %{size}').extract(doc[\"message\"].value)?.response;\n        if (response != null) emit(Integer.parseInt(response));\n      "
              }
            },
            "query": {
              "match": {
                "http.response": "304"
              }
            },
            "fields" : ["http.response"]
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : 1.0,
            "hits" : [
              {
                "_index" : "my-index",
                "_id": $body.hits.hits.0._id,
                "_score" : 1.0,
                "_source" : {
                  "timestamp" : "2020-04-30T14:31:22-05:00",
                  "message" : "247.37.0.0 - - [30/Apr/2020:14:31:22 -0500] \"GET /images/hm_nbg.jpg HTTP/1.0\" 304 0"
                },
                "fields" : {
                  "http.response" : [
                    304
                  ]
                }
              }
            ]
          }
        }
