---
"line_29":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index/"
        body: |
          {
            "mappings": {
              "properties": {
                "@timestamp": {
                  "format": "strict_date_optional_time||epoch_second",
                  "type": "date"
                },
                "message": {
                  "type": "wildcard"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index/_bulk"
        refresh: ""
        body: |
          {"index":{}}
          {"timestamp":"2020-04-30T14:30:17-05:00","message":"40.135.0.0 - - [30/Apr/2020:14:30:17 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:30:53-05:00","message":"232.0.0.0 - - [30/Apr/2020:14:30:53 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:12-05:00","message":"26.1.0.0 - - [30/Apr/2020:14:31:12 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:19-05:00","message":"247.37.0.0 - - [30/Apr/2020:14:31:19 -0500] \"GET /french/splash_inet.html HTTP/1.0\" 200 3781"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:22-05:00","message":"247.37.0.0 - - [30/Apr/2020:14:31:22 -0500] \"GET /images/hm_nbg.jpg HTTP/1.0\" 304 0"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:27-05:00","message":"252.0.0.0 - - [30/Apr/2020:14:31:27 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"}
          {"index":{}}
          {"timestamp":"2020-04-30T14:31:28-05:00","message":"not a valid apache log"}
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index/_mappings"
        body: |
          {
            "runtime": {
              "http.clientip": {
                "type": "ip",
                "script": "\n        String clientip=grok('%{COMMONAPACHELOG}').extract(doc[\"message\"].value)?.clientip;\n        if (clientip != null) emit(clientip);\n      "
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index/_search"
        filter_path: "hits"
        body: |
          {
            "query": {
              "match": {
                "http.clientip": "40.135.0.0"
              }
            },
            "fields" : ["http.clientip"]
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : 1.0,
            "hits" : [
              {
                "_index" : "my-index",
                "_id": $body.hits.hits.0._id,
                "_score" : 1.0,
                "_source" : {
                  "timestamp" : "2020-04-30T14:30:17-05:00",
                  "message" : "40.135.0.0 - - [30/Apr/2020:14:30:17 -0500] \"GET /images/hm_bg.jpg HTTP/1.0\" 200 24736"
                },
                "fields" : {
                  "http.clientip" : [
                    "40.135.0.0"
                  ]
                }
              }
            ]
          }
        }
  - do:
      raw:
        method: PUT
        path: "my-index/_mappings"
        body: |
          {
            "runtime": {
              "http.response": {
                "type": "long",
                "script": "\n        String response=dissect('%{clientip} %{ident} %{auth} [%{@timestamp}] \"%{verb} %{request} HTTP/%{httpversion}\" %{response} %{size}').extract(doc[\"message\"].value)?.response;\n        if (response != null) emit(Integer.parseInt(response));\n      "
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index/_search"
        filter_path: "hits"
        body: |
          {
            "query": {
              "match": {
                "http.response": "304"
              }
            },
            "fields" : ["http.response"]
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "hits" : {
            "total" : {
              "value" : 1,
              "relation" : "eq"
            },
            "max_score" : 1.0,
            "hits" : [
              {
                "_index" : "my-index",
                "_id": $body.hits.hits.0._id,
                "_score" : 1.0,
                "_source" : {
                  "timestamp" : "2020-04-30T14:31:22-05:00",
                  "message" : "247.37.0.0 - - [30/Apr/2020:14:31:22 -0500] \"GET /images/hm_nbg.jpg HTTP/1.0\" 304 0"
                },
                "fields" : {
                  "http.response" : [
                    304
                  ]
                }
              }
            ]
          }
        }
---
"line_260":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "my-index/_bulk"
        refresh: ""
        body: |
          {"index":{}}
          {"gc": "[2021-04-27T16:16:34.699+0000][82460][gc,heap,exit]   class space    used 266K, capacity 384K, committed 384K, reserved 1048576K"}
          {"index":{}}
          {"gc": "[2021-03-24T20:27:24.184+0000][90239][gc,heap,exit]   class space    used 15255K, capacity 16726K, committed 16844K, reserved 1048576K"}
          {"index":{}}
          {"gc": "[2021-03-24T20:27:24.184+0000][90239][gc,heap,exit]  Metaspace       used 115409K, capacity 119541K, committed 120248K, reserved 1153024K"}
          {"index":{}}
          {"gc": "[2021-04-19T15:03:21.735+0000][84408][gc,heap,exit]   class space    used 14503K, capacity 15894K, committed 15948K, reserved 1048576K"}
          {"index":{}}
          {"gc": "[2021-04-19T15:03:21.735+0000][84408][gc,heap,exit]  Metaspace       used 107719K, capacity 111775K, committed 112724K, reserved 1146880K"}
          {"index":{}}
          {"gc": "[2021-04-27T16:16:34.699+0000][82460][gc,heap,exit]  class space  used 266K, capacity 367K, committed 384K, reserved 1048576K"}
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index/_search"
        body: |
          {
            "runtime_mappings": {
              "gc_size": {
                "type": "keyword",
                "script": "\n        Map gc=dissect('[%{@timestamp}][%{code}][%{desc}]  %{ident} used %{usize}, capacity %{csize}, committed %{comsize}, reserved %{rsize}').extract(doc[\"gc.keyword\"].value);\n        if (gc != null) emit(\"used\" + ' ' + gc.usize + ', ' + \"capacity\" + ' ' + gc.csize + ', ' + \"committed\" + ' ' + gc.comsize);\n      "
              }
            },
            "size": 1,
            "aggs": {
              "sizes": {
                "terms": {
                  "field": "gc_size",
                  "size": 10
                }
              }
            },
            "fields" : ["gc_size"]
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": "$body.took",
          "timed_out" : false,
          "_shards" : {
            "total" : 1,
            "successful" : 1,
            "skipped" : 0,
            "failed" : 0
          },
          "hits" : {
            "total" : {
              "value" : 6,
              "relation" : "eq"
            },
            "max_score" : 1.0,
            "hits" : [
              {
                "_index" : "my-index",
                "_id": $body.hits.hits.0._id,
                "_score" : 1.0,
                "_source" : {
                  "gc" : "[2021-04-27T16:16:34.699+0000][82460][gc,heap,exit]   class space    used 266K, capacity 384K, committed 384K, reserved 1048576K"
                },
                "fields" : {
                  "gc_size" : [
                    "used 266K, capacity 384K, committed 384K"
                  ]
                }
              }
            ]
          },
          "aggregations" : {
            "sizes" : {
              "doc_count_error_upper_bound" : 0,
              "sum_other_doc_count" : 0,
              "buckets" : [
                {
                  "key" : "used 107719K, capacity 111775K, committed 112724K",
                  "doc_count" : 1
                },
                {
                  "key" : "used 115409K, capacity 119541K, committed 120248K",
                  "doc_count" : 1
                },
                {
                  "key" : "used 14503K, capacity 15894K, committed 15948K",
                  "doc_count" : 1
                },
                {
                  "key" : "used 15255K, capacity 16726K, committed 16844K",
                  "doc_count" : 1
                },
                {
                  "key" : "used 266K, capacity 367K, committed 384K",
                  "doc_count" : 1
                },
                {
                  "key" : "used 266K, capacity 384K, committed 384K",
                  "doc_count" : 1
                }
              ]
            }
          }
        }
