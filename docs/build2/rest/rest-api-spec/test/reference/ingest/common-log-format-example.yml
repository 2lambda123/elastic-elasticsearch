---
"line_95":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "_ingest/pipeline/my-pipeline"
        body: |
          {
          // tag::common-log-pipeline[]
            "processors": [
              {
                "grok": {
                  "description": "Extract fields from 'message'",
                  "field": "message",
                  "patterns": ["%{IPORHOST:source.ip} %{USER:user.id} %{USER:user.name} \\[%{HTTPDATE:@timestamp}\\] \"%{WORD:http.request.method} %{DATA:url.original} HTTP/%{NUMBER:http.version}\" %{NUMBER:http.response.status_code:int} (?:-|%{NUMBER:http.response.body.bytes:int}) %{QS:http.request.referrer} %{QS:user_agent}"]
                }
              },
              {
                "date": {
                  "description": "Format '@timestamp' as 'dd/MMM/yyyy:HH:mm:ss Z'",
                  "field": "@timestamp",
                  "formats": [ "dd/MMM/yyyy:HH:mm:ss Z" ]
                }
              },
              {
                "geoip": {
                  "description": "Add 'source.geo' GeoIP data for 'source.ip'",
                  "field": "source.ip",
                  "target_field": "source.geo"
                }
              },
              {
                "user_agent": {
                  "description": "Extract fields from 'user_agent'",
                  "field": "user_agent"
                }
              }
            ]
          // end::common-log-pipeline[]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "_index_template/my-data-stream-template"
        body: |
          {
            "index_patterns": [ "my-data-stream*" ],
            "data_stream": { },
            "priority": 500
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-data-stream/_doc"
        pipeline: "my-pipeline"
        refresh: "wait_for"
        body: |
          {
            "message": "89.160.20.128 - - [05/May/2099:16:21:15 +0000] \"GET /favicon.ico HTTP/1.1\" 200 3638 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36\""
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-data-stream/_search"
        filter_path: "hits.hits._source"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "hits": {
            "hits": [
              {
                "_source": {
                  "@timestamp": "2099-05-05T16:21:15.000Z",
                  "http": {
                    "request": {
                      "referrer": "\"-\"",
                      "method": "GET"
                    },
                    "response": {
                      "status_code": 200,
                      "body": {
                        "bytes": 3638
                      }
                    },
                    "version": "1.1"
                  },
                  "source": {
                    "ip": "89.160.20.128",
                    "geo": {
                      "continent_name" : "Europe",
                      "country_name" : "Sweden",
                      "country_iso_code" : "SE",
                      "city_name" : "Linköping",
                      "region_iso_code" : "SE-E",
                      "region_name" : "Östergötland County",
                      "location" : {
                        "lon" : 15.6167,
                        "lat" : 58.4167
                      }
                    }
                  },
                  "message": "89.160.20.128 - - [05/May/2099:16:21:15 +0000] \"GET /favicon.ico HTTP/1.1\" 200 3638 \"-\" \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36\"",
                  "url": {
                    "original": "/favicon.ico"
                  },
                  "user": {
                    "name": "-",
                    "id": "-"
                  },
                  "user_agent": {
                    "original": "\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/52.0.2743.116 Safari/537.36\"",
                    "os": {
                      "name": "Mac OS X",
                      "version": "10.11.6",
                      "full": "Mac OS X 10.11.6"
                    },
                    "name": "Chrome",
                    "device": {
                      "name": "Mac"
                    },
                    "version": "52.0.2743.116"
                  }
                }
              }
            ]
          }
        }
  - do:
      raw:
        method: DELETE
        path: "_data_stream/*"
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "_index_template/*"
  - is_false: _shards.failures
