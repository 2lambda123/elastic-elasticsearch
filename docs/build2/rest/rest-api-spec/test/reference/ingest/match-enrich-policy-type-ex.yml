---
"line_20":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "users/_doc/1"
        refresh: "wait_for"
        body: |
          {
            "email": "mardy.brown@asciidocsmith.com",
            "first_name": "Mardy",
            "last_name": "Brown",
            "city": "New Orleans",
            "county": "Orleans",
            "state": "LA",
            "zip": 70116,
            "web": "mardy.asciidocsmith.com"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "_enrich/policy/users-policy"
        body: |
          {
            "match": {
              "indices": "users",
              "match_field": "email",
              "enrich_fields": ["first_name", "last_name", "city", "zip", "state"]
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "_enrich/policy/users-policy/_execute"
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "_ingest/pipeline/user_lookup"
        body: |
          {
            "processors" : [
              {
                "enrich" : {
                  "description": "Add 'user' data based on 'email'",
                  "policy_name": "users-policy",
                  "field" : "email",
                  "target_field": "user",
                  "max_matches": "1"
                }
              }
            ]
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/my_id"
        pipeline: "user_lookup"
        body: |
          {
            "email": "mardy.brown@asciidocsmith.com"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_doc/my_id"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "found": true,
          "_index": "my-index-000001",
          "_id": "my_id",
          "_version": 1,
          "_seq_no" : $body._seq_no,
          "_primary_term": 1,
          "_source": {
            "user": {
              "email": "mardy.brown@asciidocsmith.com",
              "first_name": "Mardy",
              "last_name": "Brown",
              "zip": 70116,
              "city": "New Orleans",
              "state": "LA"
            },
            "email": "mardy.brown@asciidocsmith.com"
          }
        }
  - do:
      raw:
        method: DELETE
        path: "_ingest/pipeline/user_lookup"
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "_enrich/policy/users-policy"
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "my-index-000001"
  - is_false: _shards.failures
  - do:
      raw:
        method: DELETE
        path: "users"
  - is_false: _shards.failures
