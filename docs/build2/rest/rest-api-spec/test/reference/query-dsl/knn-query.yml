---
"line_17":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-image-index"
        body: |
          {
            "mappings": {
              "properties": {
                 "image-vector": {
                  "type": "dense_vector",
                  "dims": 3,
                  "index": true,
                  "similarity": "l2_norm"
                },
                "file-type": {
                  "type": "keyword"
                },
                "title": {
                  "type": "text"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-image-index/_bulk"
        refresh: "true"
        body: |
          { "index": { "_id": "1" } }
          { "image-vector": [1, 5, -20], "file-type": "jpg", "title": "mountain lake" }
          { "index": { "_id": "2" } }
          { "image-vector": [42, 8, -15], "file-type": "png", "title": "frozen lake"}
          { "index": { "_id": "3" } }
          { "image-vector": [15, 11, 23], "file-type": "jpg", "title": "mountain lake lodge" }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-image-index/_search"
        body: |
          {
            "size" : 3,
            "query" : {
              "knn": {
                "field": "image-vector",
                "query_vector": [-5, 9, -12],
                "num_candidates": 10
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-image-index/_search"
        body: |
          {
            "size" : 10,
            "query" : {
              "bool" : {
                "must" : {
                  "knn": {
                    "field": "image-vector",
                    "query_vector": [-5, 9, -12],
                    "num_candidates": 3
                  }
                },
                "filter" : {
                  "term" : { "file-type" : "png" }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-image-index/_search"
        body: |
          {
            "size" : 3,
            "query": {
              "bool": {
                "should": [
                  {
                    "match": {
                      "title": {
                        "query": "mountain lake",
                        "boost": 1
                      }
                    }
                  },
                  {
                    "knn": {
                      "field": "image-vector",
                      "query_vector": [-5, 9, -12],
                      "num_candidates": 10,
                      "boost": 2
                    }
                  }
                ]
              }
            }
          }
  - is_false: _shards.failures
