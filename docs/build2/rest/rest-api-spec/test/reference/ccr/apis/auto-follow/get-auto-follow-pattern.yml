---
setup:
# Named setup remote_cluster

  # Fetch the http host. We use the host of the master because we know there will always be a master.
  - do:
      cluster.state: {}
  - set: { master_node: master }
  - do:
      nodes.info:
        metric: [ http, transport ]
  - set: {nodes.$master.http.publish_address: host}
  - set: {nodes.$master.transport.publish_address: transport_host}

  - do:
      cluster.put_settings:
        body:
          persistent:
            cluster.remote.remote_cluster.seeds: $transport_host

  - do:
      raw:
        method: PUT
        path: "_ccr/auto_follow/my_auto_follow_pattern"
        body: |
          {
            "remote_cluster" : "remote_cluster",
            "leader_index_patterns" :
            [
              "leader_index*"
            ],
            "leader_index_exclusion_patterns":
            [
              "leader_index_001"
            ],
            "follow_index_pattern" : "{{leader_index}}-follower"
          }
---
teardown:
  - do:
      raw:
        method: DELETE
        path: "_ccr/auto_follow/my_auto_follow_pattern"
---
"line_44":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_ccr/auto_follow/"
  - is_false: _shards.failures
---
"line_49":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: GET
        path: "_ccr/auto_follow/my_auto_follow_pattern"
  - is_false: _shards.failures
---
"line_90":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
# Named setup remote_cluster

  # Fetch the http host. We use the host of the master because we know there will always be a master.
  - do:
      cluster.state: {}
  - set: { master_node: master }
  - do:
      nodes.info:
        metric: [ http, transport ]
  - set: {nodes.$master.http.publish_address: host}
  - set: {nodes.$master.transport.publish_address: transport_host}

  - do:
      cluster.put_settings:
        body:
          persistent:
            cluster.remote.remote_cluster.seeds: $transport_host

  - do:
      raw:
        method: GET
        path: "_ccr/auto_follow/my_auto_follow_pattern"
  - is_false: _shards.failures
  - match:
      $body:
        {
          "patterns": [
            {
              "name": "my_auto_follow_pattern",
              "pattern": {
                "active": true,
                "remote_cluster" : "remote_cluster",
                "leader_index_patterns" :
                [
                  "leader_index*"
                ],
                "leader_index_exclusion_patterns":
                [
                  "leader_index_001"
                ],
                "follow_index_pattern" : "{{leader_index}}-follower"
              }
            }
          ]
        }
