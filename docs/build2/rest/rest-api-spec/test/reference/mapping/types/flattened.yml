---
setup:
  - do:
      raw:
        method: PUT
        path: "bug_reports"
        body: |
          {
            "mappings": {
              "properties": {
                "title": {
                  "type": "text"
                },
                "labels": {
                  "type": "flattened"
                }
              }
            }
          }
  - do:
      raw:
        method: POST
        path: "bug_reports/_doc/1"
        body: |
          {
            "title": "Results are not sorted correctly.",
            "labels": {
              "priority": "urgent",
              "release": ["v1.2.5", "v1.3.0"],
              "timestamp": {
                "created": 1541458026,
                "closed": 1541457010
              }
            }
          }
---
"line_73":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "bug_reports/_search"
        body: |
          {
            "query": {
              "term": {"labels": "urgent"}
            }
          }
  - is_false: _shards.failures
---
"line_85":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: POST
        path: "bug_reports/_search"
        body: |
          {
            "query": {
              "term": {"labels.release": "v1.3.0"}
            }
          }
  - is_false: _shards.failures
---
"line_136":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "flattened_field": {
                  "type": "flattened"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/1"
        refresh: "true"
        body: |
          {
            "flattened_field" : {
              "subfield" : "value"
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index-000001/_search"
        body: |
          {
            "fields": ["flattened_field.subfield"],
            "_source": false
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "took": $body.took,
          "timed_out": false,
          "_shards": {
            "total": 1,
            "successful": 1,
            "skipped": 0,
            "failed": 0
          },
          "hits": {
            "total": {
              "value": 1,
              "relation": "eq"
            },
            "max_score": 1.0,
            "hits": [{
              "_index": "my-index-000001",
              "_id": "1",
              "_score": 1.0,
              "fields": {
                "flattened_field.subfield" : [ "value" ]
              }
            }]
          }
        }
---
"line_205":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "title": {
                  "type": "text"
                },
                "labels": {
                  "type": "flattened"
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: POST
        path: "my-index-000001/_bulk"
        refresh: ""
        body: |
          {"index":{}}
          {"title":"Something really urgent","labels":{"priority":"urgent","release":["v1.2.5","v1.3.0"],"timestamp":{"created":1541458026,"closed":1541457010}}}
          {"index":{}}
          {"title":"Somewhat less urgent","labels":{"priority":"high","release":["v1.3.0"],"timestamp":{"created":1541458026,"closed":1541457010}}}
          {"index":{}}
          {"title":"Not urgent","labels":{"priority":"low","release":["v1.2.0"],"timestamp":{"created":1541458026,"closed":1541457010}}}
  - is_false: _shards.failures
---
"synthetic-source-flattened-sorting-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "idx"
        body: |
          {
            "mappings": {
              "_source": { "mode": "synthetic" },
              "properties": {
                "flattened": { "type": "flattened" }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "idx/_doc/1"
        body: |
          {
            "flattened": {
              "field": [ "apple", "apple", "banana", "avocado", "10", "200", "AVOCADO", "Banana", "Tangerine" ]
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "idx/_doc/1"
        filter_path: "_source"
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "idx/_doc/1"
        filter_path: "_source"
  - is_false: _shards.failures
  - match:
      $body:
        {"_source":{
          "flattened": {
            "field": [ "10", "200", "AVOCADO", "Banana", "Tangerine", "apple", "avocado", "banana" ]
          }
        }}
---
"synthetic-source-flattened-array-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "idx"
        body: |
          {
            "mappings": {
              "_source": { "mode": "synthetic" },
              "properties": {
                "flattened": { "type": "flattened" }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "idx/_doc/1"
        body: |
          {
            "flattened": {
                "field": [
                  { "id": 1, "name": "foo" },
                  { "id": 2, "name": "bar" },
                  { "id": 3, "name": "baz" }
                ]
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "idx/_doc/1"
        filter_path: "_source"
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "idx/_doc/1"
        filter_path: "_source"
  - is_false: _shards.failures
  - match:
      $body:
        {"_source":{
            "flattened": {
              "field": {
                  "id": [ "1", "2", "3" ],
                  "name": [ "bar", "baz", "foo" ]
              }
            }
        }}
---
"synthetic-source-flattened-single-value-example":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "idx"
        body: |
          {
            "mappings": {
              "_source": { "mode": "synthetic" },
              "properties": {
                "flattened": { "type": "flattened" }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "idx/_doc/1"
        body: |
          {
            "flattened": {
              "field": [ "foo" ]
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "idx/_doc/1"
        filter_path: "_source"
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "idx/_doc/1"
        filter_path: "_source"
  - is_false: _shards.failures
  - match:
      $body:
        {"_source":{
          "flattened": {
            "field": "foo"
          }
        }}
