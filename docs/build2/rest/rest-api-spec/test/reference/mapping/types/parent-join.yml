---
"line_22":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "my_id": {
                  "type": "keyword"
                },
                "my_join_field": {
                  "type": "join",
                  "relations": {
                    "question": "answer"
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/1"
        refresh: ""
        body: |
          {
            "my_id": "1",
            "text": "This is a question",
            "my_join_field": {
              "name": "question"
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/2"
        refresh: ""
        body: |
          {
            "my_id": "2",
            "text": "This is another question",
            "my_join_field": {
              "name": "question"
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/1"
        refresh: ""
        body: |
          {
            "my_id": "1",
            "text": "This is a question",
            "my_join_field": "question"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/2"
        refresh: ""
        body: |
          {
            "my_id": "2",
            "text": "This is another question",
            "my_join_field": "question"
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/3"
        routing: "1"
        refresh: ""
        body: |
          {
            "my_id": "3",
            "text": "This is an answer",
            "my_join_field": {
              "name": "answer",
              "parent": "1"
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/4"
        routing: "1"
        refresh: ""
        body: |
          {
            "my_id": "4",
            "text": "This is another answer",
            "my_join_field": {
              "name": "answer",
              "parent": "1"
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "my-index-000001/_search"
        body: |
          {
            "query": {
              "match_all": {}
            },
            "sort": ["my_id"]
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "timed_out": false, "took": $body.took, "_shards": $body._shards,
          "hits": {
            "total": {
              "value": 4,
              "relation": "eq"
            },
            "max_score": null,
            "hits": [
              {
                "_index": "my-index-000001",
                "_id": "1",
                "_score": null,
                "_source": {
                  "my_id": "1",
                  "text": "This is a question",
                  "my_join_field": "question"
                },
                "sort": [
                  "1"
                ]
              },
              {
                "_index": "my-index-000001",
                "_id": "2",
                "_score": null,
                "_source": {
                  "my_id": "2",
                  "text": "This is another question",
                  "my_join_field": "question"
                },
                "sort": [
                  "2"
                ]
              },
              {
                "_index": "my-index-000001",
                "_id": "3",
                "_score": null,
                "_routing": "1",
                "_source": {
                  "my_id": "3",
                  "text": "This is an answer",
                  "my_join_field": {
                    "name": "answer",
                    "parent": "1"
                  }
                },
                "sort": [
                  "3"
                ]
              },
              {
                "_index": "my-index-000001",
                "_id": "4",
                "_score": null,
                "_routing": "1",
                "_source": {
                  "my_id": "4",
                  "text": "This is another answer",
                  "my_join_field": {
                    "name": "answer",
                    "parent": "1"
                  }
                },
                "sort": [
                  "4"
                ]
              }
            ]
          }
        }
  - do:
      raw:
        method: GET
        path: "my-index-000001/_search"
        filter_path: "aggregations,hits.hits"
        sort: "my_id"
        body: |
          {
            "query": {
              "parent_id": {
                "type": "answer",
                "id": "1"
              }
            },
            "aggs": {
              "parents": {
                "terms": {
                  "field": "my_join_field#question",
                  "size": 10
                }
              }
            },
            "runtime_mappings": {
              "parent": {
                "type": "long",
                "script": "\n        emit(Integer.parseInt(doc['my_join_field#question'].value))\n      "
              }
            },
            "fields": [
              { "field": "parent" }
            ]
          }
  - is_false: _shards.failures
  - match:
      $body:
        {
          "aggregations": {
            "parents": {
              "doc_count_error_upper_bound": 0,
              "sum_other_doc_count": 0,
              "buckets": [
                {
                  "key": "1",
                  "doc_count": 2
                }
              ]
            }
          },
          "hits": {
            "hits": [
              {
                "_id": "3",
                "_index": "my-index-000001",
                "_score": null,
                "_routing": "1",
                "_source": $body.hits.hits.0._source,
                "fields": {
                  "parent": [1]
                },
                "sort": ["3"]
              },
              {
                "_id": "4",
                "_index": "my-index-000001",
                "_score": null,
                "_routing": "1",
                "_source": $body.hits.hits.1._source,
                "fields": {
                  "parent": [1]
                },
                "sort": ["4"]
              }
            ]
          }
        }
---
"line_382":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "my_join_field": {
                  "type": "join",
                  "relations": {
                     "question": "answer"
                  },
                  "eager_global_ordinals": false
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "_stats/fielddata"
        human: ""
        fields: "my_join_field#question"
  - is_false: _shards.failures
  - do:
      raw:
        method: GET
        path: "_nodes/stats/indices/fielddata"
        human: ""
        fields: "my_join_field#question"
  - is_false: _shards.failures
---
"line_417":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "my_join_field": {
                  "type": "join",
                  "relations": {
                    "question": ["answer", "comment"]
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_442":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "my-index-000001"
        body: |
          {
            "mappings": {
              "properties": {
                "my_join_field": {
                  "type": "join",
                  "relations": {
                    "question": ["answer", "comment"],
                    "answer": "vote"
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
  - do:
      raw:
        method: PUT
        path: "my-index-000001/_doc/3"
        routing: "1"
        refresh: ""
        body: |
          {
            "text": "This is a vote",
            "my_join_field": {
              "name": "vote",
              "parent": "2"
            }
          }
  - is_false: _shards.failures
