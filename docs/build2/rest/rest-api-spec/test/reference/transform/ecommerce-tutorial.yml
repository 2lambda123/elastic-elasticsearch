---
"line_77":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
        - always_skip
      reason: set up sample data
  - do:
      raw:
        method: POST
        path: "_transform/_preview"
        body: |
          {
            "source": {
              "index": "kibana_sample_data_ecommerce",
              "query": {
                "bool": {
                  "filter": {
                    "term": {"currency": "EUR"}
                  }
                }
              }
            },
            "pivot": {
              "group_by": {
                "customer_id": {
                  "terms": {
                    "field": "customer_id"
                  }
                }
              },
              "aggregations": {
                "total_quantity.sum": {
                  "sum": {
                    "field": "total_quantity"
                  }
                },
                "taxless_total_price.sum": {
                  "sum": {
                    "field": "taxless_total_price"
                  }
                },
                "total_quantity.max": {
                  "max": {
                    "field": "total_quantity"
                  }
                },
                "order_id.cardinality": {
                  "cardinality": {
                    "field": "order_id"
                  }
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_165":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
        - always_skip
      reason: setup kibana sample data
  - do:
      raw:
        method: PUT
        path: "_transform/ecommerce-customer-transform"
        body: |
          {
            "source": {
              "index": [
                "kibana_sample_data_ecommerce"
              ],
              "query": {
                "bool": {
                  "filter": {
                    "term": {
                      "currency": "EUR"
                    }
                  }
                }
              }
            },
            "pivot": {
              "group_by": {
                "customer_id": {
                  "terms": {
                    "field": "customer_id"
                  }
                }
              },
              "aggregations": {
                "total_quantity.sum": {
                  "sum": {
                    "field": "total_quantity"
                  }
                },
                "taxless_total_price.sum": {
                  "sum": {
                    "field": "taxless_total_price"
                  }
                },
                "total_quantity.max": {
                  "max": {
                    "field": "total_quantity"
                  }
                },
                "order_id.cardinality": {
                  "cardinality": {
                    "field": "order_id"
                  }
                }
              }
            },
            "dest": {
              "index": "ecommerce-customers"
            },
            "retention_policy": {
              "time": {
                "field": "order_date",
                "max_age": "60d"
              }
            }
          }
  - is_false: _shards.failures
---
"line_337":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
  - do:
      raw:
        method: PUT
        path: "ecommerce-customers"
        body: |
          {
            "mappings": {
              "properties": {
                "total_quantity.sum" : {
                  "type" : "double"
                },
                "total_quantity" : {
                  "type" : "object"
                },
                "taxless_total_price" : {
                  "type" : "object"
                },
                "taxless_total_price.sum" : {
                  "type" : "double"
                },
                "order_id.cardinality" : {
                  "type" : "long"
                },
                "customer_id" : {
                  "type" : "keyword"
                },
                "total_quantity.max" : {
                  "type" : "integer"
                },
                "order_id" : {
                  "type" : "object"
                }
              }
            }
          }
  - is_false: _shards.failures
---
"line_401":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
        - always_skip
      reason: setup kibana sample data
  - do:
      raw:
        method: POST
        path: "_transform/ecommerce-customer-transform/_start"
  - is_false: _shards.failures
---
"line_439":
  - skip:
      features:
        - default_shards
        - stash_in_key
        - stash_in_path
        - stash_path_replace
        - warnings
        - always_skip
      reason: set up sample data
  - do:
      raw:
        method: POST
        path: "_transform/_preview"
        body: |
          {
            "source": {
              "index": "kibana_sample_data_ecommerce",
              "query": {
                "bool": {
                  "filter": {
                    "term": {"currency": "EUR"}
                  }
                }
              }
            },
            "latest": {
              "unique_key": ["geoip.country_iso_code", "geoip.region_name"],
              "sort": "order_date"
            }
          }
  - is_false: _shards.failures
