setup:
  - do:
      indices.create:
        index: test
        body:
          mappings:
            properties:
              city:
                type: keyword
                ignore_above: 10
              email:
                type: keyword
                ignore_above: 20
              date_of_birth:
                type: date
                format: "dd-MM-yyyy"
                ignore_malformed: true
              newsletter:
                type: boolean
                ignore_malformed: true
              ip_address:
                type: ip
                ignore_malformed: true
              products:
                type: keyword
                ignore_above: 12
              total_price:
                type: double
                ignore_malformed: true
              location:
                type: geo_point
                ignore_malformed: true
              order_datetime:
                type: date
                format: "yyyy-MM-dd HH:mm:ss"
                ignore_malformed: true

  - do:
      bulk:
        index: test
        refresh: true
        body:
          - { "index": { "_id": "001" } }
          - { "city": "Milano", email: "alice@gmail.com", date_of_birth: "12-03-1990", newsletter: true, ip_address: "130.34.45.202", products: ["it-002-4567", "it-001-6679"], total_price: "57.99", location: [45.46, 9.16], order_datetime: "2021-05-01 20:01:37" }
          - { "index": { "_id": "002" } }
          - { "city": "Roma", email: "bob@gmail.com", date_of_birth: "15-05-1991", newsletter: false, ip_address: "2001:0db8:85a3:0000:0000:8a2e:0370:7334", products: [ "it-002-112467", "it-002-5579" ], total_price: "10.99", location: [ -44.78, 19.20 ], order_datetime: "2021-05-01 20:01:37" }
          - { "index": { "_id": "003" } }
          - { "city": "Venezia", email: "alice@gmail.com", date_of_birth: "01-09-1994", newsletter: false, ip_address: "fe80::1", products: [ "it-002", "it-003-17171717" ], total_price: "-12.99", location: [ 182.22, "20.12" ], order_datetime: "2021-05-02" }
          - { "index": { "_id": "004" } }
          - { "city": "Cortina d'Ampezzo", email: "a-very-long-email-address-that-should-be-ignored@gmail.com", date_of_birth: "05-06-1989", newsletter: t, ip_address: "::1", products: [ "it101020203030", "it" ], total_price: "57", location: [ 0, 9.16 ], order_datetime: "2021-05-01-20:01:37" }
          - { "index": { "_id": "005" } }
          - { "city": "Cortina d'Ampezzo", email: "dave@gmail.com", date_of_birth: "12-03-1990 12:30:45", newsletter: t, ip_address: "130.999.36.201", products: [ "it-002-2213", "it-001-7709" ], total_price: "twentytree/12", location: [ "45.33, 8.20" ], order_datetime: "20210501 20:01:37" }
          - { "index": { "_id": "006" } }
          - { "city": "Milano", email: "eric@gmail.com", date_of_birth: "19-12-90", newsletter: f, ip_address: "130.34.45", products: [ "it-002-555", "it-001-5589990000" ], total_price: "", location: [ "45.99", "9.16" ], order_datetime: "2021-05-01 20:01:37.123" }
          - { "index": { "_id": "007" } }
          - { "city": "Venezia", email: "luke-skywalker@gmail.com", date_of_birth: "20/03/1992", newsletter: f, ip_address: "130..45.202", products: [ "it-002-1234", "it-001-1213" ], total_price: "57.99.12", location: [ 45, 20 ], order_datetime: "2021-05-03 19:38:22" }
          - { "index": { "_id": "008" } }
          - { "city": "Firenze", email: "bob@gmail.com", date_of_birth: "02311988", newsletter: "", ip_address: ":::1", products: ["", ""], total_price: "0.0", location: [ 46.22, 11.22 ], order_datetime: "2021-05-03 20:01" }
          - { "index": { "_id": "009" } }
          - { "city": "Firenze", email: "tom@gmail.com", date_of_birth: "16-11-1990", newsletter: "not_sure", ip_address: "2001:0db8::1234:5678::", products: "it-002-4567", total_price: "0,99", location: [ 18.18, 19.19 ], order_datetime: "2021-05-03 20-01-55" }
          - { "index": { "_id": "010" } }
          - { "city": "Cortina d'Ampezzo", email: "alice@gmail.com", date_of_birth: "18-12-1992", newsletter: "false", ip_address: ":::1", products: "it-002-1890994567", total_price: "14,27", location: [ 45.46-9.16 ], order_datetime: "2021-05-01 20:05:37" }
          - { "index": { "_id": "011" } }
          - { "city": "Roma", email: "paul@gmail.com", date_of_birth: "17.15.1990", newsletter: "true", ip_address: "", products: [ "it-002-1019", "it-001-5578", "it-009-9901256" ], total_price: "49.99", location: 45.22, order_datetime: "2021-05-01T20:02:00" }

---
"terms aggregation on _ignored metadata field":
  - skip:
      version: " - 8.12.99"
      reason: "_ignored metadata field aggregation support added in 8.13"
  - do:
      search:
        body:
          size: 0
          aggs:
            ignored_terms:
              terms:
                field: _ignored

  - match: { hits.total.value: 11 }
  - length: { aggregations.ignored_terms.buckets: 9 }
  - match: { aggregations.ignored_terms.buckets.0.key: "ip_address" }
  - match: { aggregations.ignored_terms.buckets.0.doc_count: 7 }
  - match: { aggregations.ignored_terms.buckets.1.key: "order_datetime" }
  - match: { aggregations.ignored_terms.buckets.1.doc_count: 7 }
  - match: { aggregations.ignored_terms.buckets.2.key: "products" }
  - match: { aggregations.ignored_terms.buckets.2.doc_count: 6 }
  - match: { aggregations.ignored_terms.buckets.3.key: "date_of_birth" }
  - match: { aggregations.ignored_terms.buckets.3.doc_count: 5 }
  - match: { aggregations.ignored_terms.buckets.4.key: "newsletter" }
  - match: { aggregations.ignored_terms.buckets.4.doc_count: 5 }
  - match: { aggregations.ignored_terms.buckets.5.key: "total_price" }
  - match: { aggregations.ignored_terms.buckets.5.doc_count: 4 }
  - match: { aggregations.ignored_terms.buckets.6.key: "city" }
  - match: { aggregations.ignored_terms.buckets.6.doc_count: 3 }
  - match: { aggregations.ignored_terms.buckets.7.key: "location" }
  - match: { aggregations.ignored_terms.buckets.7.doc_count: 3 }
  - match: { aggregations.ignored_terms.buckets.8.key: "email" }
  - match: { aggregations.ignored_terms.buckets.8.doc_count: 2 }
