---
setup:
  - do:
        indices.create:
          index: test
          body:
              mappings:
                properties:
                  "@timestamp":
                    type: date
                  lines:
                    type: nested
                    properties:
                      "@timestamp":
                        type: date
                      value:
                        type: integer
                      name:
                        type: keyword

  - do:
      index:
        index: test
        id:    "1"
        body: {
          "@timestamp": "2022-09-01",
          "lines": [
            {
              "@timestamp": "2022-09-01",
              "name": "foo",
              "value": "1.2"
            },
            {
              "@timestamp": "2022-09-01",
              "name": "foo",
              "value": "1.2"
            },
            {
              "@timestamp": "2022-09-01",
              "name": "bar",
              "value": "2.3"
            }
          ]
        }

  - do:
      indices.refresh:
        index: [test]

---
"Query, Composite, Scripted Metric":
  - do:
      catch: /Nested aggregation is incompatible with sub aggregations requiring scores/
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          size: 0
          query:
            bool:
              filter:
                -
                  range:
                    "@timestamp":
                      from: "2022-09-01"
                      to: "2022-09-30"
                      include_lower: true
                      include_upper: true
                      time_zone: "Europe/Paris"
                      boost: 1
              adjust_pure_negative: true
              boost: 1
          _source: true
          track_total_hits: -1
          aggregations:
            data:
              nested:
                path: "lines"
              aggregations:
                my_buckets:
                  composite:
                    size: 20
                    sources:
                      -
                        prod_name:
                          terms:
                            field: "lines.name"
                  aggregations:
                    catalog_price:
                      scripted_metric:
                        init_script:
                          source: "state.transactions = []"
                        map_script:
                          source: "state.transactions.add(doc['lines.value'].value)"
                        combine_script:
                          source: "double sum = 0; for (t in state.transactions) { sum += t } return sum"
                        reduce_script:
                          source: "double sum = 0; for (a in states) { if (a != null) { sum += a } } return sum"
---
"Query, Composite, Scripted Metric (scores disabled)":
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          size: 0
          query:
            bool:
              filter:
                -
                  range:
                    "@timestamp":
                      from: "2022-09-01"
                      to: "2022-09-30"
                      include_lower: true
                      include_upper: true
                      time_zone: "Europe/Paris"
                      boost: 1
              adjust_pure_negative: true
              boost: 1
          _source: true
          track_total_hits: -1
          aggregations:
            data:
              nested:
                path: "lines"
              aggregations:
                my_buckets:
                  composite:
                    size: 20
                    sources:
                      -
                        prod_name:
                          terms:
                            field: "lines.name"
                  aggregations:
                    catalog_price:
                      scripted_metric:
                        init_script:
                          source: "state.transactions = []"
                        map_script:
                          source: "state.transactions.add(doc['lines.value'].value)"
                        combine_script:
                          source: "double sum = 0; for (t in state.transactions) { sum += t } return sum"
                        reduce_script:
                          source: "double sum = 0; for (a in states) { if (a != null) { sum += a } } return sum"

  - match: {hits.total: 1}
  - match: {aggregations.my_buckets.doc_count: 3}
  - length: { aggregations.my_buckets.buckets: 2 }
  - match: { aggregations.my_buckets.buckets.0.key: "bar" }
  - match: { aggregations.courses.names.buckets.0.doc_count: 1}
  - match: { aggregations.courses.names.buckets.0.catalog_price.value: 2.3}
  - match: { aggregations.my_buckets.buckets.1.key: "foo" }
  - match: { aggregations.courses.names.buckets.1.doc_count: 2}
  - match: { aggregations.courses.names.buckets.1.catalog_price.value: 2.4}
