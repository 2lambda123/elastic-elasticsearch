setup:
  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_replicas: 0
          mappings:
            properties:
              int:
                type : integer
              double:
                type : double
              keyword:
                type: keyword

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"int":   1, "double":   1.0, "keyword": "foo"}'
          - '{"index": {}}'
          - '{"int":  51, "double":  51.0, "keyword": "foo"}'
          - '{"index": {}}'
          - '{"int": 101, "double": 101.0, "keyword": "foo"}'
          - '{"index": {}}'
          - '{"int": 151, "double": 151.0, "keyword": "foo"}'

---
basic:
  - skip:
      features: close_to

  - do:
      search:
        body:
          size: 0
          aggs:
            percentile_ranks_int:
              percentile_ranks:
                field: int
                values: [50, 100, 150, 200]
            percentile_ranks_double:
              percentile_ranks:
                field: double
                values: [50, 100, 150, 200]

  - match: { hits.total.value: 4 }
  - close_to: { aggregations.percentile_ranks_int.values.50\\.0: { value: 25.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_int.values.100\\.0: { value: 50.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_int.values.150\\.0: { value: 75.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_int.values.200\\.0: { value: 100.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_double.values.50\\.0: { value: 25.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_double.values.100\\.0: { value: 50.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_double.values.150\\.0: { value: 75.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_double.values.200\\.0: { value: 100.0, error: 0.1 } }

---
filtered:
  - skip:
      features: close_to

  - do:
      search:
        body:
          size: 0
          query:
            range:
              int:
                gte: 50
          aggs:
            percentile_ranks_int:
              percentile_ranks:
                field: int
                values: [50, 100, 150, 200]
            percentile_ranks_double:
              percentile_ranks:
                field: double
                values: [50, 100, 150, 200]

  - match: { hits.total.value: 3 }
  - close_to: { aggregations.percentile_ranks_int.values.50\\.0: { value: 0.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_int.values.100\\.0: { value: 33.3, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_int.values.150\\.0: { value: 66.6, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_int.values.200\\.0: { value: 100.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_double.values.50\\.0: { value: 0.0, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_double.values.100\\.0: { value: 33.3, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_double.values.150\\.0: { value: 66.6, error: 0.1 } }
  - close_to: { aggregations.percentile_ranks_double.values.200\\.0: { value: 100.0, error: 0.1 } }

---
missing field with missing param:
  - skip:
      features: close_to

  - do:
      search:
        body:
          size: 0
          aggs:
            percentile_ranks_missing:
              percentile_ranks:
                field: missing
                missing: 1.0
                values: [50, 99]

  - match: { hits.total.value: 4 }
  - close_to: { aggregations.percentile_ranks_missing.values.50\\.0: { value: 100.0, error: 0.1} }
  - close_to: { aggregations.percentile_ranks_missing.values.99\\.0: { value: 100.0, error: 0.1} }

---
missing field without missing param:
  - do:
      search:
        body:
          size: 0
          aggs:
            percentile_ranks_missing:
              percentile_ranks:
                field: missing
                values: [50, 99]

  - match: { hits.total.value: 4 }
  - is_false: aggregations.percentile_ranks_missing.value

---
invalid params:
  - do:
      catch: bad_request
      search:
        body:
          aggs:
            percentile_ranks_int:
              percentile_ranks:
                field: int
                values: []

  - do:
      catch: bad_request
      search:
        body:
          aggs:
            percentile_ranks_int:
              percentile_ranks:
                field: int
                values: null

  - do:
      catch: bad_request
      search:
        body:
          aggs:
            percentile_ranks_int:
              percentile_ranks:
                field: int
                values: ["foo"]

  - do:
      catch: bad_request
      search:
        body:
          aggs:
            percentile_ranks_string:
              percentile_ranks:
                field: string

---
non-keyed test:
  - skip:
      features: close_to

  - do:
      search:
        body:
          size: 0
          aggs:
            percentile_ranks_int:
              percentile_ranks:
                field: int
                values: [50, 100, 150, 200]
                keyed: false

  - match: { hits.total.value: 4 }
  - match: { aggregations.percentile_ranks_int.values.0.key: 50 }
  - close_to: { aggregations.percentile_ranks_int.values.0.value: { value: 25.0, error: 0.1 } }
  - match: { aggregations.percentile_ranks_int.values.1.key: 100 }
  - close_to: { aggregations.percentile_ranks_int.values.1.value: { value: 50.0, error: 0.1 } }
  - match: { aggregations.percentile_ranks_int.values.2.key: 150 }
  - close_to: { aggregations.percentile_ranks_int.values.2.value: { value: 75.0, error: 0.1 } }
  - match: { aggregations.percentile_ranks_int.values.3.key: 200 }
  - close_to: { aggregations.percentile_ranks_int.values.3.value: { value: 100.0, error: 0.1 } }
