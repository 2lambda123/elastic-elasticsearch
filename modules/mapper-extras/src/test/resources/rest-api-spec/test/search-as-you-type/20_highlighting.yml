setup:
  - skip:
      version: " - 7.1.0"
      reason: "added in 7.1.0"

  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_replicas: 0
          mappings:
            properties:
              a_field:
                type: search_as_you_type
                analyzer: simple
                max_shingle_size: 4
              text_field:
                type: text
                analyzer: simple

  - do:
      index:
        index: test
        type: _doc
        id: 1
        body:
          a_field: "quick red fox lazy brown dog"
          text_field: "quick red fox lazy brown dog"

  - do:
      indices.refresh: {}

---
"phrase query":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "red"
          highlight:
            fields:
              a_field:
                type: unified

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0._source.text_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0.highlight.a_field.0: "quick <em>red</em> fox lazy brown dog" }

---
"bool prefix query":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "red fo"
          highlight:
            fields:
              a_field:
                type: unified

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0._source.text_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0.highlight.a_field.0: "quick <em>red</em> fox lazy brown dog" }

---
"multi match bool prefix query 1 complete term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            multi_match:
              query: "red fo"
              type: "bool_prefix"
              fields: [ "a_field", "a_field._2gram", "a_field._3gram", "a_field._4gram" ]
          highlight:
            fields:
              a_field:
                type: unified
              a_field._2gram:
                type: unified
              a_field._3gram:
                type: unified
              a_field._4gram:
                type: unified

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0._source.text_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0.highlight.a_field: ["quick <em>red</em> fox lazy brown dog"] }
  - match: { hits.hits.0.highlight.a_field\._2gram: null }
  - match: { hits.hits.0.highlight.a_field\._3gram: null }
  - match: { hits.hits.0.highlight.a_field\._4gram: null }

---
"multi match bool prefix query 2 complete term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            multi_match:
              query: "red fox la"
              type: "bool_prefix"
              fields: [ "a_field", "a_field._2gram", "a_field._3gram", "a_field._4gram" ]
          highlight:
            fields:
              a_field:
                type: unified
              a_field._2gram:
                type: unified
              a_field._3gram:
                type: unified
              a_field._4gram:
                type: unified

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0._source.text_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0.highlight.a_field: ["quick <em>red</em> <em>fox</em> lazy brown dog"] }
  - match: { hits.hits.0.highlight.a_field\._2gram: ["quick <em>red fox</em> lazy brown dog"] }
  - match: { hits.hits.0.highlight.a_field\._3gram: null }
  - match: { hits.hits.0.highlight.a_field\._4gram: null }

---
"multi match bool prefix query 3 complete term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            multi_match:
              query: "red fox lazy br"
              type: "bool_prefix"
              fields: [ "a_field", "a_field._2gram", "a_field._3gram", "a_field._4gram" ]
          highlight:
            fields:
              a_field:
                type: unified
              a_field._2gram:
                type: unified
              a_field._3gram:
                type: unified
              a_field._4gram:
                type: unified

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0._source.text_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0.highlight.a_field: ["quick <em>red</em> <em>fox</em> <em>lazy</em> brown dog"] }
  - match: { hits.hits.0.highlight.a_field\._2gram: ["quick <em>red fox</em><em> lazy</em> brown dog"] }
  - match: { hits.hits.0.highlight.a_field\._3gram: ["quick <em>red fox lazy</em> brown dog"] }
  - match: { hits.hits.0.highlight.a_field\._4gram: null }

---
"multi match bool prefix query 4 complete term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            multi_match:
              query: "red fox lazy brown d"
              type: "bool_prefix"
              fields: [ "a_field", "a_field._2gram", "a_field._3gram", "a_field._4gram" ]
          highlight:
            fields:
              a_field:
                type: unified
              a_field._2gram:
                type: unified
              a_field._3gram:
                type: unified
              a_field._4gram:
                type: unified

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0._source.text_field: "quick red fox lazy brown dog" }
  - match: { hits.hits.0.highlight.a_field: ["quick <em>red</em> <em>fox</em> <em>lazy</em> <em>brown</em> dog"] }
  - match: { hits.hits.0.highlight.a_field\._2gram: ["quick <em>red fox</em><em> lazy</em><em> brown</em> dog"] }
  - match: { hits.hits.0.highlight.a_field\._3gram: ["quick <em>red fox lazy</em><em> brown</em> dog"] }
  - match: { hits.hits.0.highlight.a_field\._4gram: ["quick <em>red fox lazy brown</em> dog"] }
