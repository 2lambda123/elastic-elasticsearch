setup:
  - skip:
     version: " - 6.99.99"
     reason: "search-as-you-type field type was introduced in 7.0.0"
  #- skip: todo fix this after merging master
  #    version: " - 7.0.99"
  #    reason: "search-as-you-type field type was introduced in 7.1.0"

  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_replicas: 0
          mappings:
            _doc:
              properties:
                a_field:
                  type: search_as_you_type
                  analyzer: simple
                  max_shingle_size: 4

  - do:
      index:
        index: test
        type: _doc
        id: 1
        body:
          a_field: "quick red fox lazy brown dog"

  - do:
      indices.refresh: {}

---
"get document":
  - do:
      get:
        index: test
        type: _doc
        id: 1

  - is_true: found
  - match: { _source.a_field: "quick red fox lazy brown dog" }

---
"search on root field":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field: "quick"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }


# these "search on Xgram" tests repeat the same search for each term we expect to generate
---
"search on 2gram":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "quick red"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "red fox"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "fox lazy"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "lazy brown"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "brown dog"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # make sure we're not just always returning a match
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "avoid matching"

  - match: { hits.total: 0 }

---
"search on 3gram":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "quick red fox"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "red fox lazy"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "fox lazy brown"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "lazy brown dog"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # make sure we're not just always returning a match
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "avoid matching"

  - match: { hits.total: 0 }

---
"search on 4gram":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._4gram: "quick red fox lazy"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._4gram: "red fox lazy brown"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._4gram: "fox lazy brown dog"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # make sure we're not just always returning a match
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._4gram: "avoid matching"

  - match: { hits.total: 0 }

  # we won't check all the terms that this field generates because there are many
---
"search on prefix":

  # search term as prefix
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._index_prefix: "quick re"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # search term as infix
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._index_prefix: "lazy br"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # ensure we're generating the last token as a shingle
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._index_prefix: "do"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on shingle fields":

  # prefix on root field
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # infix on root field
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # prefix on 2gram
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._2gram: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # infix on 2gram
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._2gram: "red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # prefix on 3gram
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._3gram: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # infix on 3gram
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._3gram: "red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # prefix on 4gram
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._4gram: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  # infix on 4gram
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._4gram: "red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query covers all shingle sizes with prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quick r"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quick red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quick red fox la"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query covers all shingle sizes with infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "fox laz"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "fox lazy br"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "fox lazy brown do"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }
