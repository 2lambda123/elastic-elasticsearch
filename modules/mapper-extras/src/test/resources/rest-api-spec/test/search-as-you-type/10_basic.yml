setup:
  - skip:
      version: " - 7.1.0"
      reason: "search-as-you-type field type was introduced in 7.1.0"

  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_replicas: 0
          mappings:
            properties:
              a_field:
                type: search_as_you_type
                analyzer: simple
                max_shingle_size: 4

  - do:
      index:
        index: test
        type: _doc
        id: 1
        body:
          a_field: "quick red fox lazy brown dog"

  # this document should not be matched
  - do:
      index:
        index: test
        type: _doc
        id: 2
        body:
          a_field: "xylophone xylophone xylophone"

  - do:
      indices.refresh: {}

---
"get document":
  - do:
      get:
        index: test
        type: _doc
        id: 1

  - is_true: found
  - match: { _source.a_field: "quick red fox lazy brown dog" }

---
"search on root field":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field: "quick"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }


# these "search on Xgram" tests repeat the same search for each term we expect to generate
---
"search on 2gram":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "quick red"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "red fox"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "fox lazy"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "lazy brown"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._2gram: "brown dog"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"search on 3gram":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "quick red fox"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "red fox lazy"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "fox lazy brown"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._3gram: "lazy brown dog"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"search on 4gram":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._4gram: "quick red fox lazy"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._4gram: "red fox lazy brown"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._4gram: "fox lazy brown dog"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

# we won't check all the terms that this field generates because there are many
---
"term query on prefix field with prefix term":

  # search term as prefix
  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._index_prefix: "quick re"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"term query on prefix field with infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._index_prefix: "lazy br"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"term query on prefix field with trailing term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            term:
              a_field._index_prefix: "do"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with prefix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on 2gram with prefix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._2gram: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on 2gram with infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._2gram: "red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on 3gram with prefix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._3gram: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on 3gram with infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._3gram: "red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on 4gram with prefix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._4gram: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on 4gram with infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field._4gram: "red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with 1 prefix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quic"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with 2 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quick r"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with 3 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quick red fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with 4 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "quick red fox la"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with 1 infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "fo"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with 2 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "fox laz"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with 3 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "fox lazy br"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with 4 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "fox lazy brown do"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"prefix query on root field with trailing term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            prefix:
              a_field: "do"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 1 prefix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "quick"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 2 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "quick red"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 3 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "quick red fox"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 4 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "quick red fox lazy"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 5 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "quick red fox lazy brown"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 1 infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "red"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 2 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "red fox"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 3 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "red fox lazy"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 4 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "red fox lazy brown"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with 5 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "red fox lazy brown dog"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase query on root field with trailing term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase:
              a_field: "dog"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 1 prefix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "qui"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 2 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "quick r"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 3 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "quick red f"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 4 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "quick red fox la"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 5 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "quick red fox lazy br"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 1 infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "re"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 2 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "red f"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 3 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "red fox la"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 4 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "red fox lazy br"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with 5 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "red fox lazy brown d"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"phrase prefix query on root field with trailing term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            match_phrase_prefix:
              a_field: "do"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 1 prefix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "qui"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 2 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "quick r"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 3 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "quick red f"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 4 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "quick red fox la"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 5 prefix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "quick red fox lazy br"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 1 infix term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "re"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 2 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "red f"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 3 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "red fox l"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 4 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "red fox lazy br"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with 5 infix terms":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "red fox lazy brown d"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field with trailing term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "do"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field out of order partial trailing term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "fox lazy red do"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }

---
"bool prefix query on root field out of order partial leading term":

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          query:
            bool_prefix:
              a_field: "fox lazy red qui"

  - match: { hits.total: 1 }
  - match: { hits.hits.0._source.a_field: "quick red fox lazy brown dog" }
