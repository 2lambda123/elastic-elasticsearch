---
"Response format for search failures with allow_partial_search_results=true":
  - do:
      indices.create:
        index: source
        body:
          settings:
            index.number_of_shards: 2

  - do:
      index:
        index:   source
        id:      1
        body:    { "text": "test" }
  - do:
      indices.refresh: {}

  - do:
      catch: bad_request
      reindex:
        allow_partial_search_results: true
        body:
          source:
            index:   source
            query:
              script:
                script:
                  lang: painless
                  source: throw new IllegalArgumentException("Cats!")
          dest:
            index:   dest
  - match: {created: 0}
  - match: {updated: 0}
  - match: {version_conflicts: 0}
  - match: {batches: 0}
  - match: {failures.0.shard: 0}
  - match: {failures.0.index:  source}
  - is_true: failures.0.node
  - match: {failures.0.reason.type:   script_exception}
  - match: {failures.0.reason.reason: runtime error}
  - match: {failures.0.reason.caused_by.type:   illegal_argument_exception}
  - match: {failures.0.reason.caused_by.reason: Cats!}
  - gte: { took: 0 }

---
"Response format for search failures normal":
  - do:
      indices.create:
        index: source
        body:
          settings:
            index.number_of_shards: 2

  - do:
      index:
        index:   source
        id:      1
        body:    { "text": "test" }
  - do:
      indices.refresh: {}

  - do:
      catch: bad_request
      reindex:
        body:
          source:
            index:   source
            query:
              script:
                script:
                  lang: painless
                  source: throw new IllegalArgumentException("Cats!")
          dest:
            index:   dest
  - match: {error.type: search_phase_execution_exception}
  - match: {error.reason: "Partial shards failure"}
  - match: {error.phase: query}
  - match: {error.root_cause.0.type:   script_exception}
  - match: {error.root_cause.0.reason: runtime error}
  - match: {error.failed_shards.0.shard: 0}
  - match: {error.failed_shards.0.index:  source}
  - is_true: error.failed_shards.0.node
  - match: {error.failed_shards.0.reason.type:   script_exception}
  - match: {error.failed_shards.0.reason.reason: runtime error}
  - match: {error.failed_shards.0.reason.caused_by.type:   illegal_argument_exception}
  - match: {error.failed_shards.0.reason.caused_by.reason: Cats!}
