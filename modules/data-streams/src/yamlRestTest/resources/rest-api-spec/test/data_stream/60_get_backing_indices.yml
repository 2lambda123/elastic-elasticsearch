---
"Get backing indices for data stream":
  - skip:
      version: " - 7.8.99"
      reason: "data streams only supported in 7.9+"
      features: allowed_warnings

  - do:
      allowed_warnings:
        - "index template [my-template] has index patterns [data-*] matching patterns from existing older templates [global] with patterns (global => [*]); this template [my-template] will take precedence during new index creation"
      indices.put_index_template:
        name: my-template
        body:
          index_patterns: [data-*]
          data_stream: {}

  - do:
      indices.create_data_stream:
        name: data-stream1
  - is_true: acknowledged

  # save the backing index names for later use
  - do:
      indices.get_data_stream:
        name: data-stream1
  - set: { data_streams.0.indices.0.index_name: idx0name }

  - do:
      indices.create:
        index: test_index
        body:
          settings:
            number_of_shards:   1
            number_of_replicas: 1

  - do:
      indices.get:
        index: ['.ds-data-stream1-*000001', 'test_index']

  - is_true: .$idx0name.settings
  - is_true: .$idx0name.data_stream
  - match: { .$idx0name.data_stream: data-stream1 }
  - is_true: test_index.settings
  - is_false: test_index.data_stream

  - do:
      indices.delete_data_stream:
        name: data-stream1
  - is_true: acknowledged

---
"Get data stream with failure store":
  - skip:
      version: " - 8.12.99"
      reason: "data stream failure stores can be retrieved via the GET index API in 8.13+"
      features: allowed_warnings

  - do:
      allowed_warnings:
        - "index template [my-template1] has index patterns [failure-data-stream1, failure-data-stream2] matching patterns from existing older templates [global] with patterns (global => [*]); this template [my-template1] will take precedence during new index creation"
      indices.put_index_template:
        name: my-template1
        body:
          index_patterns: [ failure-data-stream]
          data_stream:
            failure_store: true

  - do:
      indices.create_data_stream:
        name: failure-data-stream
  - is_true: acknowledged

  - do:
      cluster.health:
        wait_for_status: green

  # save the backing & failure store index names for later use
  - do:
      indices.get_data_stream:
        name: failure-data-stream
  - set: { data_streams.0.indices.0.index_name: idx0name }
  - set: { data_streams.0.failure_indices.0.index_name: failure0name }

  - do:
      indices.get:
        index: "failure-data-stream"
        failure_store: "only"
  - is_false: .$idx0name
  - is_true: .$failure0name

  - do:
      indices.get:
        index: "failure-data-stream"
        failure_store: "include"
  - is_true: .$idx0name
  - is_true: .$failure0name
