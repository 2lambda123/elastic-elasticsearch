setup:
  - do:
      cluster.health:
        wait_for_status: green
        wait_for_nodes: 3
        # wait for long enough that we give delayed unassigned shards to stop being delayed
        timeout: 70s
---
"Test put batch data frame transforms on new cluster":
  - do:
      indices.create:
        index: new-dataframe-transform-airline-data
        body:
          mappings:
            properties:
              time:
                type: date
              airline:
                type: keyword
              responsetime:
                type: float
              event_rate:
                type: integer
  - do:
      cluster.health:
        index: "new-dataframe-transform-airline-data"
        wait_for_status: green
  - do:
      data_frame.put_data_frame_transform:
        transform_id: "new-simple-transform"
        body: >
          {
            "source": { "index": "new-dataframe-transform-airline-data" },
            "dest": { "index": "new-simple-transform-idx" },
            "pivot": {
              "group_by": { "airline": {"terms": {"field": "airline"}}},
              "aggs": {"avg_response": {"avg": {"field": "responsetime"}}}
            }
          }
  - match: { acknowledged: true }

  - do:
      data_frame.start_data_frame_transform:
        transform_id: "new-simple-transform"
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "new-simple-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "new-simple-transform" }
  - match: { transforms.0.state.task_state: "/started|stopped/" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "new-simple-transform"
        wait_for_completion: true
  - match: { acknowledged: true }

  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "new-simple-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "new-simple-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }

  - do:
      data_frame.put_data_frame_transform:
        transform_id: "new-complex-transform"
        body: >
          {
            "source": {
              "index": "new-dataframe-transform-airline-data",
              "query": {
                "bool": {
                  "filter": {"term": {"airline": "ElasticAir"}}
                }
              }
            },
            "dest": {
              "index": "new-complex-transform-idx",
              "pipeline": "data_frame_simple_pipeline"
            },
            "pivot": {
              "group_by": {
                "airline": {"terms": {"field": "airline"}},
                "day": {"date_histogram": {"field": "timestamp", "calendar_interval": "1d"}},
                "every_50": {"histogram": {"field": "responsetime", "interval": 50}}
              },
              "aggs": {"avg_response": {"avg": {"field": "responsetime"}}}
            }
          }
  - match: { acknowledged: true }

  - do:
      data_frame.get_data_frame_transform:
        transform_id: "new-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "new-complex-transform" }
  - is_true: transforms.0.version
  - is_true: transforms.0.create_time

  - do:
      data_frame.start_data_frame_transform:
        transform_id: "new-complex-transform"
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "new-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "new-complex-transform" }
  - match: { transforms.0.state.task_state: "/started|stopped/" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "new-complex-transform"
        wait_for_completion: true
  - match: { acknowledged: true }

  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "new-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "new-complex-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }

  - do:
      data_frame.delete_data_frame_transform:
        transform_id: "new-complex-transform"

  - do:
      data_frame.delete_data_frame_transform:
        transform_id: "new-simple-transform"
---
"Test put continuous data frame transform on new cluster":
  - do:
      indices.create:
        index: new-dataframe-transform-airline-data-cont
        body:
          mappings:
            properties:
              time:
                type: date
              airline:
                type: keyword
              responsetime:
                type: float
              event_rate:
                type: integer
  - do:
      cluster.health:
        index: "new-dataframe-transform-airline-data-cont"
        wait_for_status: green

  - do:
      data_frame.put_data_frame_transform:
        transform_id: "new-simple-continuous-transform"
        body: >
          {
            "source": { "index": "new-dataframe-transform-airline-data-cont" },
            "dest": { "index": "new-simple-continuous-transform-idx" },
            "pivot": {
              "group_by": { "airline": {"terms": {"field": "airline"}}},
              "aggs": {"avg_response": {"avg": {"field": "responsetime"}}}
            },
            "sync": {
              "time": {
                "field": "time",
                "delay": "90m"
              }
            }
          }
  - match: { acknowledged: true }

  - do:
      data_frame.get_data_frame_transform:
        transform_id: "new-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "new-simple-continuous-transform" }
  - match: { transforms.0.sync.time.field: "time" }
  - match: { transforms.0.sync.time.delay: "90m" }
  - is_true: transforms.0.version
  - is_true: transforms.0.create_time

  - do:
      data_frame.start_data_frame_transform:
        transform_id: "new-simple-continuous-transform"
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "new-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "new-simple-continuous-transform" }
  - match: { transforms.0.state.task_state: "started" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "new-simple-continuous-transform"
        wait_for_completion: true
  - match: { acknowledged: true }

  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "new-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "new-simple-continuous-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }

  - do:
      data_frame.delete_data_frame_transform:
        transform_id: "new-simple-continuous-transform"
---
"Get start, stop, and delete old and mixed cluster batch data frame transforms":
  # Simple and complex OLD transforms
  - do:
      data_frame.get_data_frame_transform:
        transform_id: "old-simple-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-simple-transform" }
  - match: { transforms.0.source.index.0: "old-dataframe-transform-airline-data" }
  - match: { transforms.0.dest.index: "old-simple-transform-idx" }
  - match: { transforms.0.pivot.group_by.airline.terms.field: "airline" }
  - match: { transforms.0.pivot.aggregations.avg_response.avg.field: "responsetime" }

  - do:
      data_frame.start_data_frame_transform:
        transform_id: "old-simple-transform"
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "old-simple-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-simple-transform" }
  - match: { transforms.0.state.task_state: "/started|stopped/" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "old-simple-transform"
        wait_for_completion: true
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "old-simple-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-simple-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }
  - do:
      data_frame.get_data_frame_transform:
        transform_id: "old-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-complex-transform" }
  - match: { transforms.0.source.index.0: "old-dataframe-transform-airline-data" }
  - match: { transforms.0.dest.index: "old-complex-transform-idx" }
  - match: { transforms.0.dest.pipeline: "data_frame_simple_pipeline" }
  - match: { transforms.0.pivot.group_by.airline.terms.field: "airline" }
  - match: { transforms.0.pivot.group_by.day.date_histogram.field: "timestamp" }
  - match: { transforms.0.pivot.group_by.every_50.histogram.field: "responsetime" }
  - match: { transforms.0.pivot.aggregations.avg_response.avg.field: "responsetime" }

  - do:
      data_frame.start_data_frame_transform:
        transform_id: "old-complex-transform"
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "old-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-complex-transform" }
  - match: { transforms.0.state.task_state: "/started|stopped/" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "old-complex-transform"
        wait_for_completion: true
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "old-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-complex-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }

  # Simple and complex Mixed cluster transforms
  - do:
      data_frame.get_data_frame_transform:
        transform_id: "mixed-simple-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-simple-transform" }
  - match: { transforms.0.source.index.0: "mixed-dataframe-transform-airline-data" }
  - match: { transforms.0.dest.index: "mixed-simple-transform-idx" }
  - match: { transforms.0.pivot.group_by.airline.terms.field: "airline" }
  - match: { transforms.0.pivot.aggregations.avg_response.avg.field: "responsetime" }

  - do:
      data_frame.start_data_frame_transform:
        transform_id: "mixed-simple-transform"
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "mixed-simple-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-simple-transform" }
  - match: { transforms.0.state.task_state: "/started|stopped/" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "mixed-simple-transform"
        wait_for_completion: true
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "mixed-simple-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-simple-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }

  - do:
      data_frame.get_data_frame_transform:
        transform_id: "mixed-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-complex-transform" }
  - match: { transforms.0.source.index.0: "mixed-dataframe-transform-airline-data" }
  - match: { transforms.0.dest.index: "mixed-complex-transform-idx" }
  - match: { transforms.0.dest.pipeline: "data_frame_simple_pipeline" }
  - match: { transforms.0.pivot.group_by.airline.terms.field: "airline" }
  - match: { transforms.0.pivot.group_by.day.date_histogram.field: "timestamp" }
  - match: { transforms.0.pivot.group_by.every_50.histogram.field: "responsetime" }
  - match: { transforms.0.pivot.aggregations.avg_response.avg.field: "responsetime" }

  - do:
      data_frame.start_data_frame_transform:
        transform_id: "mixed-complex-transform"
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "mixed-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-complex-transform" }
  - match: { transforms.0.state.task_state: "/started|stopped/" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "mixed-complex-transform"
        wait_for_completion: true
  - match: { acknowledged: true }
  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "mixed-complex-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-complex-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }

# Delete all old and mixed transforms
  - do:
      data_frame.delete_data_frame_transform:
        transform_id: "old-simple-transform"

  - do:
      data_frame.delete_data_frame_transform:
        transform_id: "mixed-simple-transform"

  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "old-simple-transform,mixed-simple-transform"
  - match: { count: 0 }

---
"Test GET, stop, delete, old and mixed continuous transforms":
  - do:
      data_frame.get_data_frame_transform:
        transform_id: "old-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-simple-continuous-transform" }
  - match: { transforms.0.sync.time.field: "time" }
  - match: { transforms.0.sync.time.delay: "90m" }
  - is_true: transforms.0.version
  - is_true: transforms.0.create_time

  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "old-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-simple-continuous-transform" }
  - match: { transforms.0.state.task_state: "started" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "old-simple-continuous-transform"
        wait_for_completion: true
  - match: { acknowledged: true }

  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "old-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "old-simple-continuous-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }

  - do:
      data_frame.delete_data_frame_transform:
        transform_id: "old-simple-continuous-transform"

  - do:
      data_frame.get_data_frame_transform:
        transform_id: "mixed-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-simple-continuous-transform" }
  - match: { transforms.0.sync.time.field: "time" }
  - match: { transforms.0.sync.time.delay: "90m" }
  - is_true: transforms.0.version
  - is_true: transforms.0.create_time

  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "mixed-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-simple-continuous-transform" }
  - match: { transforms.0.state.task_state: "started" }

  - do:
      data_frame.stop_data_frame_transform:
        transform_id: "mixed-simple-continuous-transform"
        wait_for_completion: true
  - match: { acknowledged: true }

  - do:
      data_frame.get_data_frame_transform_stats:
        transform_id: "mixed-simple-continuous-transform"
  - match: { count: 1 }
  - match: { transforms.0.id: "mixed-simple-continuous-transform" }
  - match: { transforms.0.state.indexer_state: "stopped" }
  - match: { transforms.0.state.task_state: "stopped" }

  - do:
      data_frame.delete_data_frame_transform:
        transform_id: "mixed-simple-continuous-transform"
