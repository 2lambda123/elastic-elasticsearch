---
"Test old cluster datafeed":
  - do:
      xpack.ml.get_datafeeds:
        datafeed_id: old-cluster-datafeed
  - match: { datafeeds.0.datafeed_id: "old-cluster-datafeed"}
  - length: { datafeeds.0.indices: 1 }
  - length: { datafeeds.0.types: 1 }
  - gte: { datafeeds.0.scroll_size: 2000 }
  - match: { datafeeds.0.aggregations.buckets.date_histogram.field: time }
  - match: { datafeeds.0.aggregations.buckets.aggregations.time.max.field: time }

  - do:
      xpack.ml.get_datafeed_stats:
        datafeed_id: old-cluster-datafeed
  - match: { datafeeds.0.state: "stopped"}
  - is_false: datafeeds.0.node

---
"Put job and datafeed in mixed cluster":

  - do:
      xpack.ml.put_job:
        job_id: mixed-cluster-datafeed-job
        body:  >
          {
            "description":"Cluster upgrade",
            "analysis_config" : {
                "bucket_span": "60s",
                "summary_count_field_name": "doc_count",
                "detectors" :[{"function":"count"}]
            },
            "analysis_limits" : {
                "model_memory_limit": "50mb"
            },
            "data_description" : {
                "format":"xcontent",
                "time_field":"time"
            }
          }

  - do:
      xpack.ml.put_datafeed:
        datafeed_id: mixed-cluster-datafeed
        body:  >
          {
            "job_id":"mixed-cluster-datafeed-job",
            "indices":["airline-data"],
            "types":["response"],
            "scroll_size": 2000,
            "aggregations": {
              "buckets": {
                "date_histogram": {
                  "field": "time",
                  "interval": "30s",
                  "time_zone": "UTC"
                },
                "aggregations": {
                  "time": {
                    "max": {"field": "time"}
                  },
                  "airline": {
                    "terms": {
                      "field": "airline",
                      "size": 100
                    },
                    "aggregations": {
                      "responsetime": {
                        "avg": {
                          "field": "responsetime"
                        }
                      }
                    }
                  }
                }
              }
            }
          }

  - do:
      xpack.ml.get_datafeed_stats:
        datafeed_id: mixed-cluster-datafeed
  - match: { datafeeds.0.state: stopped}
  - is_false: datafeeds.0.node
