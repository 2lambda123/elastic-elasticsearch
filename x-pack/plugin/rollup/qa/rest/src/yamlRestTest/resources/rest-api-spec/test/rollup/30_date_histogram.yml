setup:
  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
            index:
              mode: time_series
              routing_path: [ uid ]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              uid:
                type: keyword
                time_series_dimension: true
              total_memory_used:
                type: aggregate_metric_double
                metrics: [ min, max ]
                default_metric: min
  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{ "index": {} }'
          - '{ "@timestamp": "2021-04-28T18:50:00Z", "uid": "001", "total_memory_used": { "min": 99198, "max": 106780 } }'
          - '{ "index": {} }'
          - '{ "@timestamp": "2021-04-28T18:55:00Z", "uid": "002", "total_memory_used": { "min": 102334, "max": 110450 } }'
          - '{ "index": {} }'
          - '{ "@timestamp": "2021-04-28T18:50:00Z", "uid": "003", "total_memory_used": { "min": 98012, "max": 109009 } }'
          - '{ "index": {} }'
          - '{ "@timestamp": "2021-04-28T18:55:00Z", "uid": "004", "total_memory_used": { "min": 101990, "max": 120770 } }'

---
"Date aggregation with calendar_interval":
  - do:
      catch: bad_request
      search:
        index: test
        body:
          size: 0
          aggs:
            date_histogram:
              date_histogram:
                field: "@timestamp"
                calendar_interval: hour

  - match: { status: 400 }
  - match: { error.root_cause.0.type: unsupported_aggregation_on_downsampled_field }
  - match: { error.root_cause.0.reason: "Field [@timestamp] of type [date] is not supported for aggregation [date_histogram] with interval type [calendar_interval]" }

---
"Date aggregation with fixed_interval":
  - do:
      search:
        index: test
        body:
          size: 0
          aggs:
            date_histogram:
              date_histogram:
                field: "@timestamp"
                fixed_interval: 1m
                min_doc_count: 1

  - match: { hits.total.value: 4 }
  - match: { hits.total.relation: "eq" }
  - length: { aggregations.date_histogram.buckets: 2 }
  - match: { aggregations.date_histogram.buckets.0.key_as_string: "2021-04-28T18:50:00.000Z" }
  - match: { aggregations.date_histogram.buckets.0.key: 1619635800000 }
  - match: { aggregations.date_histogram.buckets.0.doc_count: 2 }
  - match: { aggregations.date_histogram.buckets.1.key_as_string: "2021-04-28T18:55:00.000Z" }
  - match: { aggregations.date_histogram.buckets.1.key: 1619636100000 }
  - match: { aggregations.date_histogram.buckets.1.doc_count: 2 }
