---
"Async search":
  - do:
      indices.create:
        index: test-1

  - do:
      indices.create:
        index: test-2

  - do:
      indices.create:
        index: test-3

  - do:
      index:
        index:  test-2
        body:   { max: 2 }

  - do:
      index:
        index:  test-1
        body:   { max: 1 }

  - do:
      index:
        index:  test-3
        body:   { max: 3 }

  - do:
      indices.refresh: {}

  - do:
      async_search.submit:
        index: test-*
        batched_reduce_size: 2
        body:
          query:
            match_all: {}
          aggs:
            1:
              max:
                field: max
          sort: max

  - set: { id: id }

  - do:
      async_search.get:
        id: "$id"
        wait_for_completion: 10s

  - set: { version: version }
  - match: { version:   4 }
  - is_false: partial_response
  - length: { response.hits.hits:        3 }
  - match: { response.hits.hits.0._source.max: 1 }
  - match: { response.aggregations.1.value:  3.0 }

  - do:
      catch: not_modified
      async_search.get:
        id: "$id"
        last_version: "$version"

  - is_false: partial_response
  - is_false: response

  - do:
      async_search.delete:
        id: "$id"

  - match: { acknowledged: true }

  - do:
      catch: missing
      async_search.delete:
        id: "$id"
