setup:
  - do:
      indices.create:
        index: test-index1
        body:
          settings:
            index:
              number_of_shards: 1
              number_of_replicas: 0
          mappings:
            properties:
              conflict_field:
                type: integer
              non_conflict_field:
                type: text
              other_field:
                type: keyword

  - do:
      indices.create:
        index: test-index2
        body:
          settings:
            index:
              number_of_shards: 1
              number_of_replicas: 0
          mappings:
            properties:
              conflict_field:
                type: text
              non_conflict_field:
                type: text
              other_field:
                type: keyword

---
teardown:
  - do:
      search_application.delete:
        name: test-search-application-1
        ignore: 404

  - do:
      indices.delete:
        index: test-index1
        ignore: 404

  - do:
      indices.delete:
        index: test-index2
        ignore: 404

---
"xpack usage includes Enterprise Search":
  - do:
      xpack.usage: {}

  - match: {
    enterprise_search: {
      enabled: true,
      available: true,
      search_applications: {
        count: 0,
        search_applications: []
      }
    }
  }

  - do:
      search_application.put:
        name: test-search-application-1
        body:
          indices: [ "test-index1", "test-index2" ]

  - do:
      xpack.usage: {}

  - match: {
    enterprise_search: {
      enabled: true,
      available: true,
      search_applications: {
        count: 1,
        search_applications: [
          {
            name: "test-search-application-1",
            schema_field_count: 16,
            schema_field_conflict_count: 1
          }
        ]
      }
    }
  }
