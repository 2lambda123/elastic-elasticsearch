---
setup:
- do:
    indices.create:
      index: test_k
      body:
        settings:
          index:
            number_of_shards:   1
            number_of_replicas: 0
        mappings:
          properties:
            foo:
              type : keyword
            timestamp:
              type : date
- do:
    indices.create:
      index: test_ck
      body:
        settings:
          index:
            number_of_shards:   1
            number_of_replicas: 0
        mappings:
          properties:
            foo:
              type : constant_keyword
              value: bar_ck
            other:
              type : text
            timestamp:
              type : date
- do:
    indices.create:
      index: test_f
      body:
        settings:
          index:
            number_of_shards:   1
            number_of_replicas: 0
        mappings:
          properties:
            foo:
              type : flattened
            timestamp:
              type : date

---
"Test basic term enumeration":
  - do:
      index:
          index:  test_k
          id:     1
          body:   { foo: "bar_k", "timestamp":"2021-01-01T01:01:01.000Z" }

  - do:
      index:
          index:  test_ck
          id:     2
          body:   { other: "foo", "timestamp":"2020-01-01T01:01:01.000Z"  }

  - do:
      index:
          index:  test_f
          id:     3
          body:   { foo: { bar: "bar_f" }, "timestamp":"2019-01-01T01:01:01.000Z" }

  - do:
      indices.refresh: {}

  - do:
      cluster.health:
           index: test_f
           wait_for_status: green

  - do:
      termsenum:
        index:  test_*
        body:  {"field": "foo", "string":"b"}
  - length: {terms: 2}


  - do:
      termsenum:
        index:  test_*
        body:  {"field": "foo.bar", "string":"b"}
  - length: {terms: 1}

  - do:
      termsenum:
        index:  test_*
        body:  {"field": "foo", "string":"b", "index_filter":{"range":{"timestamp":{"gte":"2021-01-01T01:01:01.000Z"}}}}
  - length: {terms: 1}
