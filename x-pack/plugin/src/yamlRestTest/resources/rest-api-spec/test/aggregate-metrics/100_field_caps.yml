setup:
  - skip:
      version: " - 8.3.99"
      reason: metric types as family type support introduced in 8.4.0

  - do:
      indices.create:
        index: test_rollup
        body:
          settings:
            index:
              number_of_replicas: 0
              number_of_shards: 2
              mode: time_series
              routing_path: [metricset, k8s.pod.uid]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              metric:
                type: aggregate_metric_double
                metrics: [min, max, sum, value_count]
                default_metric: max
                time_series_metric: gauge

  - do:
      indices.create:
        index: test_time_series
        body:
          settings:
            index:
              number_of_replicas: 0
              number_of_shards: 2
              mode: time_series
              routing_path: [metricset, k8s.pod.uid]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              metric:
                type: long
                time_series_metric: gauge

---
field caps on rollup indices:
  - skip:
      version: " - 8.3.99"
      reason: metric types as family type support introduced in 8.4.0

  - do:
      field_caps:
        index: test_rollup
        fields: [metric]

  - match: {fields.metric.gauge.searchable:     true}
  - match: {fields.metric.gauge.aggregatable:   true}
  - match: {fields.metric.gauge.time_series_metric:   gauge}
  - is_false: fields.metric.gauge.indices
  - is_false: fields.metric.gauge.non_searchable_indices
  - is_false: fields.metric.gauge.non_aggregatable_indices


---
field caps on time series indices:
  - skip:
      version: " - 8.3.99"
      reason: metric types as family type support introduced in 8.4.0

  - do:
      field_caps:
        index: [test_time_series, test_rollup]
        fields: [metric]

  - match: {fields.metric.gauge.searchable:     true}
  - match: {fields.metric.gauge.aggregatable:   true}
  - match: {fields.metric.gauge.time_series_metric:   gauge}
  - is_false: fields.metric.gauge.indices
  - is_false: fields.metric.gauge.non_searchable_indices
  - is_false: fields.metric.gauge.non_aggregatable_indices
  - is_false: fields.metric.long
  - is_false: fields.metric.aggregate_metric_double
