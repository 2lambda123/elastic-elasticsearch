---
"Access to values of dense_vector in script":
  - do:
      indices.create:
        index: test-index
        body:
          mappings:
            properties:
              v:
                type: dense_vector
                dims: 3

  - do:
      bulk:
        index: test-index
        refresh: true
        body:
          - '{"index": {"_id": "1"}}'
          - '{"v": [1, 1, 1]}'
          - '{"index": {"_id": "2"}}'
          - '{"v": [1, 1, 2]}'
          - '{"index": {"_id": "3"}}'
          - '{"v": [1, 1, 3]}'
          - '{"index": {"_id": "missing_vector"}}'
          - '{}'

  # vector functions in loop – return the index of the closest parameter vector based on cosine similarity
  - do:
      search:
        body:
          query:
            script_score:
              query: { "exists": { "field": "v" } }
              script:
                source: |
                  float[] v = doc['v'].vectorValue;
                  float vm = doc['v'].magnitude;

                  int closestPv = 0;
                  float maxCosSim = -1;
                  for (int i = 0; i < params.pvs.length; i++) {
                    float dotProduct = 0;
                    for (int j = 0; j < v.length; j++) {
                      dotProduct += v[j] * params.pvs[i][j];
                    }
                    float cosSim = dotProduct / (vm * (float) params.pvs_magnts[i]);
                    if (maxCosSim < cosSim) {
                      maxCosSim = cosSim;
                      closestPv = i;
                    }
                  }
                  closestPv;
                params:
                  pvs: [ [ 1, 1, 1 ], [ 1, 1, 2 ], [ 1, 1, 3 ] ]
                  pvs_magnts: [1.7320, 2.4495, 3.3166]

  - match: { hits.hits.0._id: "3" }
  - match: { hits.hits.0._score: 2 }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1._score: 1 }
  - match: { hits.hits.2._id: "1" }
  - match: { hits.hits.2._score: 0 }

---
"Access to values of indexed dense_vector in script":
  - skip:
      version: " - 7.12.99"
      reason: "Access to values of dense_vector in script was added in 7.13"
  - do:
      indices.create:
        index: test-index
        body:
          mappings:
            properties:
              v:
                type: dense_vector
                dims: 3
                index: true
                similarity: cosine

  - do:
      bulk:
        index: test-index
        refresh: true
        body:
          - '{"index": {"_id": "1"}}'
          - '{"v": [1, 1, 1]}'
          - '{"index": {"_id": "2"}}'
          - '{"v": [1, 1, 2]}'
          - '{"index": {"_id": "3"}}'
          - '{"v": [1, 1, 3]}'
          - '{"index": {"_id": "missing_vector"}}'
          - '{}'

  # vector functions in loop – return the index of the closest parameter vector based on cosine similarity
  - do:
      search:
        body:
          query:
            script_score:
              query: { "exists": { "field": "v" } }
              script:
                source: |
                  float[] v = doc['v'].vectorValue;
                  float vm = doc['v'].magnitude;

                  int closestPv = 0;
                  float maxCosSim = -1;
                  for (int i = 0; i < params.pvs.length; i++) {
                    float dotProduct = 0;
                    for (int j = 0; j < v.length; j++) {
                      dotProduct += v[j] * params.pvs[i][j];
                    }
                    float cosSim = dotProduct / (vm * (float) params.pvs_magnts[i]);
                    if (maxCosSim < cosSim) {
                      maxCosSim = cosSim;
                      closestPv = i;
                    }
                  }
                  closestPv;
                params:
                  pvs: [ [ 1, 1, 1 ], [ 1, 1, 2 ], [ 1, 1, 3 ] ]
                  pvs_magnts: [1.7320, 2.4495, 3.3166]

  - match: { hits.hits.0._id: "3" }
  - match: { hits.hits.0._score: 2 }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1._score: 1 }
  - match: { hits.hits.2._id: "1" }
  - match: { hits.hits.2._score: 0 }

---
"dense vector fields api":
  - skip:
      version: " - 8.0.99"
      reason: "Fields API for dense vector added in 8.2"

  - do:
      indices.create:
        index: test-index
        body:
          mappings:
            properties:
              v:
                type: dense_vector
                dims: 3
  - do:
      bulk:
        index: test-index
        refresh: true
        body:
          - '{"index": {"_id": "1"}}'
          - '{"v": [1, 1, 1]}'
          - '{"index": {"_id": "2"}}'
          - '{"v": [1, 1, 2]}'
          - '{"index": {"_id": "3"}}'
          - '{"v": [1, 1, 3]}'
          - '{"index": {"_id": "missing_vector"}}'
          - '{}'

  - do:
      search:
        body:
          query:
            script_score:
              query: { match_all: {} }
              script:
                source: |
                  def dv = field('v').get();
                  if (dv.isEmpty()) {
                    return dv.size();
                  }
                  return dv.vector[2] * dv.size()

  - match: { hits.hits.0._id: "3" }
  - match: { hits.hits.0._score: 3 }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1._score: 2 }
  - match: { hits.hits.2._id: "1" }
  - match: { hits.hits.2._score: 1 }
  - match: { hits.hits.3._id: "missing_vector" }
  - match: { hits.hits.3._score: 0 }

  - do:
      search:
        body:
          query:
            script_score:
              query: { match_all: {} }
              script:
                source: |
                  DenseVector dv = field('v').get(null);
                  if (dv == null) {
                    return 1;
                  }
                  return dv.vector[2];

  - match: { hits.hits.0._id: "3" }
  - match: { hits.hits.0._score: 3 }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1._score: 2 }
  - match: { hits.hits.2._id: "1" }
  - match: { hits.hits.2._score: 1 }
  - match: { hits.hits.3._id: "missing_vector" }
  - match: { hits.hits.3._score: 1 }

  - do:
      catch: bad_request
      search:
        body:
          query:
            script_score:
              query: { "bool": { "must_not": { "exists": { "field": "v" } } } }
              script:
                source: |
                  field('v').get().vector[2]

  - match: { error.failed_shards.0.reason.caused_by.type: "illegal_argument_exception" }
  - match: { error.failed_shards.0.reason.caused_by.reason: "Dense vector value missing for a field, use isEmpty() to check for a missing vector value" }

  - do:
      search:
        body:
          query:
            script_score:
              query: { "bool": { "must_not": { "exists": { "field": "v" } } } }
              script:
                source: |
                  float[] q = new float[1];
                  q[0] = 3;
                  DenseVector dv = field('v').get();
                  float score = 0;
                  try { score += dv.magnitude } catch (IllegalArgumentException e) { score += 10; }
                  try { score += dv.dotProduct(q) } catch (IllegalArgumentException e) { score += 200; }
                  try { score += dv.l1Norm(q) } catch (IllegalArgumentException e) { score += 3000; }
                  try { score += dv.l2Norm(q) } catch (IllegalArgumentException e) { score += 40000; }
                  try { score += dv.vector[0] } catch (IllegalArgumentException e) { score += 500000; }
                  try { score += dv.dims } catch (IllegalArgumentException e) { score += 6000000; }
                  return score;
  - match: { hits.hits.0._id: "missing_vector" }
  - match: { hits.hits.0._score: 6543210 }

  - do:
      search:
        body:
          query:
            script_score:
              query: { "exists": { "field": "v" } }
              script:
                source: |
                  field('v').get().dotProduct(params.query)
                params:
                  query: [4, 5, 6]

  - match: { hits.hits.0._id: "3" }
  - match: { hits.hits.0._score: 27 }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.1._score: 21 }
  - match: { hits.hits.2._id: "1" }
  - match: { hits.hits.2._score: 15 }

  - do:
      search:
        body:
          query:
            script_score:
              query: { "exists": { "field": "v" } }
              script:
                source: |
                  field('v').get().l1Norm(params.query)
                params:
                  query: [4, 5, 6]

  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.0._score: 12 }

  - do:
      search:
        body:
          query:
            script_score:
              query: { "exists": { "field": "v" } }
              script:
                source: |
                  (int) field('v').get().l2Norm(params.query)
                params:
                  query: [4, 5, 6]

  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.0._score: 7 }
