---
"Test basic query rule lifecycle":

  - do:
      query_rules.put:
        ruleset_id: my-rules-id
        body:
          mappings:
            user: string
          rules: [{ "condition" : {}, "action" : {}}]

  - match: { acknowledged: true }

  - do:
      query_rules.get:
        ruleset_id: my-rules-id

  - match: { ruleset_id: my-rules-id }
  - match: { found: true }
  - match: { _source.mappings.user: string }
  - is_true: _source.rules.0.condition
  - is_true: _source.rules.0.action

  - do:
      query_rules.get:
        ruleset_id: some-other-id

  - match: { ruleset_id : some-other-id }
  - match: { found : false }

  - do:
      query_rules.delete:
        ruleset_id: my-rules-id

  - do:
      query_rules.get:
        ruleset_id: my-rules-id

  - match: { ruleset_id: my-rules-id }
  - match: { found: false }

---
"Test query rules list ids":

  - do:
      query_rules.put:
        ruleset_id: my-rules-id
        body:
          mappings:
            user: string
          rules: [{ "condition" : {}, "action" : {}}]

  - do:
      query_rules.put:
        ruleset_id: my-other-rules-id
        body:
          mappings:
            user: string
          rules: [{ "condition" : {}, "action" : {}}]

  - do:
      query_rules.list: {}

  - match : { ruleset_ids : [ my-rules-id, my-other-rules-id] }

  - do:
      query_rules.list:
        body:
          size: 1

  - match : { ruleset_ids : [ my-rules-id ] }

  - do:
      query_rules.list:
        body:
          size: 1
          from: 1

  - match : { ruleset_ids : [ my-other-rules-id ] }
---
"Test put query rules validation":

  - do:
      catch: "/rules are missing/"
      query_rules.put:
        ruleset_id: my-rules-id
        body:
          mappings:
            user: string

  - do:
      catch: "/rules definition should be an array/"
      query_rules.put:
        ruleset_id: my-rules-id
        body:
          mappings:
            user: string
          rules: my-rules

  - do:
      catch: "/mappings are missing/"
      query_rules.put:
        ruleset_id: my-rules-id
        body:
          rules: [{ "condition" : {}, "action" : {}}]

  - do:
      catch: "/mappings definition should be an object/"
      query_rules.put:
        ruleset_id: my-rules-id
        body:
          mappings:
            [ { user: "string" } ]
          rules: [{ "condition" : {}, "action" : {}}]
