setup:
  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      xpack.ml.put_job:
        job_id: delete-forecast-job
        body:  >
          {
            "description":"A forecast job",
            "analysis_config" : {
                "detectors" :[{"function":"metric","field_name":"responsetime","by_field_name":"airline"}],
                "bucket_span" : "1s"
            },
            "data_description" : {
                "format":"xcontent"
            }
          }

  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      xpack.ml.open_job:
        job_id: delete-forecast-job

  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      xpack.ml.post_data:
        job_id: delete-forecast-job
        body:
        - airline: AAL
          responsetime: 132.2046
          sourcetype: post-data-job
          time: 1403481600
        - airline: JZA
          responsetime: 990.4628
          sourcetype: post-data-job
          time: 1403481700
        - airline: JZA
          responsetime: 990.4628
          sourcetype: post-data-job
          time: 1403481800
        - airline: JZA
          responsetime: 990.4628
          sourcetype: post-data-job
          time: 1403481900
        - airline: JZA
          responsetime: 990.4628
          sourcetype: post-data-job
          time: 1403482000
        - airline: JZA
          responsetime: 990.4628
          sourcetype: post-data-job
          time: 1403482100
        - airline: JZA
          responsetime: 990.4628
          sourcetype: post-data-job
          time: 1403482200
        - airline: JZA
          responsetime: 990.4628
          sourcetype: post-data-job
          time: 1403482300
        - airline: JZA
          responsetime: 990.4628
          sourcetype: post-data-job
          time: 1403482400
  - do:
      headers:
        Authorization: "Basic eF9wYWNrX3Jlc3RfdXNlcjp4LXBhY2stdGVzdC1wYXNzd29yZA==" # run as x_pack_rest_user, i.e. the test setup superuser
      xpack.ml.flush_job:
        job_id: delete-forecast-job

---
"Test delete forecast on missing forecast":
  - do:
      catch: /resource_not_found_exception/
      xpack.ml.delete_forecast:
        job_id: delete-forecast-job
        forecast_id: this-is-a-bad-forecast

---
"Test delete forecast":
  - do:
      xpack.ml.forecast:
        job_id: delete-forecast-job
  - set: { forecast_id: forecast }
  - do:
      xpack.ml.delete_forecast:
        job_id: delete-forecast-job
        forecast_id: $forecast
  - match: { acknowledged: true }

---
"Test delete on _all forecasts not allow no forecasts":
  - do:
      catch: /resource_not_found_exception/
      xpack.ml.delete_forecast:
        job_id: delete-forecast-job-other
        forecast_id: _all
        allow_no_forecasts: false

---
"Test delete on _all forecasts":
  - do:
      xpack.ml.delete_forecast:
        job_id: delete-forecast-job-other
        forecast_id: _all
        allow_no_forecasts: true
  - match: { acknowledged: true }
