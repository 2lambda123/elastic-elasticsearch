---
setup:
  - do:
      indices.create:
        index: sensor
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
          mappings:
            properties:
              timestamp:
                type: date
              temperature:
                type: long
              voltage:
                type: double
              node:
                type: keyword
              tight_loop:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['tight_loop'].value)
              loose_loop:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['lla'].value)
              lla:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['llb'].value)
              llb:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['llc'].value)
              llc:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['lld'].value)
              lld:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['lle'].value)
              lle:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['llf'].value)
              llf:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['llg'].value)
              llg:
                type: runtime_script
                runtime_type: keyword
                script: value(doc['loose_loop'].value)

  - do:
      bulk:
        index: sensor
        refresh: true
        body: |
          {"index":{}}
          {"timestamp": 1516729294000, "temperature": 200, "voltage": 5.2, "node": "a"}

---
"tight loop":
  - do:
      catch: '/loop in field definitions: \[tight_loop, tight_loop\]/'
      search:
        index: sensor
        body:
          sort: timestamp
          docvalue_fields: [tight_loop]

---
"loose loop":
  - do:
      catch: '/loop in field definitions: \[loose_loop, lla, llb, llc, lld, lle, llf, llg, loose_loop\]/'
      search:
        index: sensor
        body:
          sort: timestamp
          docvalue_fields: [loose_loop]

  - do:
      catch: '/loop in field definitions: \[lld, lle, llf, llg, loose_loop, lla, llb, llc, lld\]/'
      search:
        index: sensor
        body:
          sort: timestamp
          docvalue_fields: [lld]
