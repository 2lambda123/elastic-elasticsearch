setup:

  - skip:
      version: " - 7.99.99"
      reason: "unsigned_long was added in 8.0"

  - do:
      indices.create:
        index:  test1
        body:
          mappings:
            properties:
              ul:
                type: unsigned_long

  - do:
      bulk:
        index: test1
        refresh: true
        body: |
          { "index": {"_id" : "1"} }
          { "ul": 0 }
          { "index": {"_id" : "2"} }
          { "ul": 9223372036854775807 }
          { "index": {"_id" : "3"} }
          { "ul": 9223372036854775808 }
          { "index": {"_id" : "4"} }
          { "ul": 18446744073709551614 }
          { "index": {"_id" : "5"} }
          { "ul": 18446744073709551615 }

---
"Exist query":

  - do:
      search:
        index: test1
        body:
          size: 0
          query:
            exists:
              field: ul

  - match: { "hits.total.value": 5 }


---
"Term query":

  - do:
      search:
        index: test1
        body:
          query:
            term:
              ul: 0
  - match: { "hits.total.value": 1 }
  - match: {hits.hits.0._id: "1" }

  - do:
      search:
        index: test1
        body:
          query:
            term:
              ul: 18446744073709551615
  - match: { "hits.total.value": 1 }
  - match: {hits.hits.0._id: "5" }

  - do:
      search:
        index: test1
        body:
          query:
            term:
              ul: 18446744073709551616
  - match: { "hits.total.value": 0 }

---
"Terms query":

  - do:
      search:
        index: test1
        body:
          size: 0
          query:
            terms:
              ul: [0, 9223372036854775808, 18446744073709551615]

  - match: { "hits.total.value": 3 }

---
"Range query":

  - do:
      search:
        index: test1
        body:
          size: 0
          query:
            range:
              ul:
                gte: 0
  - match: { "hits.total.value": 5 }

  - do:
      search:
        index: test1
        body:
          size: 0
          query:
            range:
              ul:
                gte: 0.5
  - match: { "hits.total.value": 4 }

  - do:
      search:
        index: test1
        body:
          size: 0
          query:
            range:
              ul:
                lte: 18446744073709551615
  - match: { "hits.total.value": 5 }

  - do:
      search:
        index: test1
        body:
          query:
            range:
              ul:
                lte: "18446744073709551614.5" # this must be string, as number gets converted to double with loss of precision
  - match: { "hits.total.value": 4 }

---
"Sort":

  - do:
      search:
        index: test1
        body:
          sort: [ { ul: asc } ]

  - match: { "hits.total.value": 5 }
  - match: {hits.hits.0._id: "1" }
  - match: {hits.hits.0.sort: [0.0] }
  # as sort is based on double representation, there is some loss of precision during converting longs to doubles
  # thus both 9223372036854775807 and 9223372036854775808 are converted to 9.223372036854776E18
  # both 18446744073709551614 and 18446744073709551615 are converted to 1.8446744073709552E19
  # hence, we can't assert ids for the following sort results:
  - match: {hits.hits.1.sort: [9.223372036854776E18] } # could be docs with _id 2 or 3
  - match: {hits.hits.2.sort: [9.223372036854776E18] } # could be docs with _id 2 or 3
  - match: {hits.hits.3.sort: [1.8446744073709552E19] } # could be docs with _id 4 or 5
  - match: {hits.hits.4.sort: [1.8446744073709552E19] } # could be docs with _id 4 or 5

---
"Aggs":

  - do:
      search:
        index: test1
        body:
          size: 0
          aggs:
            ul_terms:
              terms:
                field: ul
  - length: { aggregations.ul_terms.buckets: 3 }
  - match: { aggregations.ul_terms.buckets.0.key: 9.223372036854776E18 }
  - match: { aggregations.ul_terms.buckets.1.key: 1.8446744073709552E19 }
  - match: { aggregations.ul_terms.buckets.2.key: 0.0 }

  - do:
      search:
        index: test1
        body:
          size: 0
          aggs:
            ul_histogram:
              histogram:
                field: ul
                interval: 9223372036854775808
  - length: { aggregations.ul_histogram.buckets: 3 }
  - match: { aggregations.ul_histogram.buckets.0.key: 0.0 }
  - match: { aggregations.ul_histogram.buckets.1.key: 9.223372036854776E18 }
  - match: { aggregations.ul_histogram.buckets.2.key: 1.8446744073709552E19 }

  - do:
      search:
        index: test1
        body:
          size: 0
          aggs:
            ul_range:
              range:
                field: ul
                ranges: [
                { "to": 9223372036854775807 },
                { "from": 9223372036854775807}
                ]
  - length: { aggregations.ul_range.buckets: 2 }
  - match: { aggregations.ul_range.buckets.0.doc_count: 1 }
  - match: { aggregations.ul_range.buckets.1.doc_count: 4 }
