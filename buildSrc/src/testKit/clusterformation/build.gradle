plugins {
    id 'elasticsearch.clusterformation'
}

elasticsearchNodes {
    myTestCluster {
        distribution = 'ZIP'
        version = '6.3.0'
    }
}

repositories {
    maven {
        url "https://artifacts.elastic.co/maven"
    }
    maven {
        url "https://snapshots.elastic.co/maven"
    }
}


task user1 {
    clusterFormation.use elasticsearchNodes.myTestCluster
    doLast {
        println "Cluster running @ ${elasticsearchNodes.myTestCluster.httpSocketURI}"
    }
}

task user2 {
    clusterFormation.use elasticsearchNodes.myTestCluster
    doLast {
        println "Cluster running @ ${elasticsearchNodes.myTestCluster.httpSocketURI}"
    }
}

task upToDate1 {
    clusterFormation.use elasticsearchNodes.myTestCluster
}

task upToDate2 {
    clusterFormation.use elasticsearchNodes.myTestCluster
}

task skipped1 {
    enabled = false
    clusterFormation.use elasticsearchNodes.myTestCluster
    doLast {
        println "Cluster running @ ${elasticsearchNodes.myTestCluster.httpSocketURI}"
    }
}

task skipped2 {
    enabled = false
    clusterFormation.use elasticsearchNodes.myTestCluster
    doLast {
        println "Cluster running @ ${elasticsearchNodes.myTestCluster.httpSocketURI}"
    }
}

task itAlwaysFails {
    doFirst {
        println "Cluster running @ ${elasticsearchNodes.myTestCluster.httpSocketURI}"
    }
    doLast {
        throw new GradleException("Task 1 failed!")
    }
    clusterFormation.use elasticsearchNodes.myTestCluster
}

task dependsOnFailed {
    dependsOn itAlwaysFails
    clusterFormation.use elasticsearchNodes.myTestCluster
}
