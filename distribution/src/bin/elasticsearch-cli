#!/bin/bash

set -e -o pipefail

source "`dirname "$0"`"/elasticsearch-env

@source.path.env@
if [ -z "$ES_PATH_CONF" ]; then
  echo "ES_PATH_CONF must be set to the configuration path"
  exit 1
fi

ES_DISTRIBUTION_FLAVOR=@es.distribution.flavor@
ES_DISTRIBUTION_TYPE=@es.distribution.type@
ES_BUNDLED_JDK=@es.bundled_jdk@
LAUNCHER_CLASSPATH=$ES_HOME/lib/*:$ES_HOME/lib/launcher/*

# use a small heap size for the CLI tools, and thus the serial collector to
# avoid stealing many CPU cycles; a user can override by setting LAUNCHER_JAVA_OPTS
LAUNCHER_JAVA_OPTS="-Xms4m -Xmx64m -XX:+UseSerialGC ${LAUNCHER_JAVA_OPTS}"

# TODO: move this to launcher
if [[ "$ES_BUNDLED_JDK" == "false" ]]; then
  echo "warning: no-jdk distributions that do not bundle a JDK are deprecated and will be removed in a future release" >&2
fi

if [[ -z "$LAUNCHER_TOOLNAME" ]]; then
  SCRIPTNAME=$(basename "$0")
  # temporary hack to force these into the launcher, but do we want to pollute env?
  LAUNCHER_TOOLNAME=${SCRIPTNAME#"elasticsearch-"}
fi
export LAUNCHER_TOOLNAME
export LAUNCHER_LIBS

# TODO: move this to launcher
if [[ "$ES_DISTRIBUTION_TYPE" == "docker" ]]; then


  # The virtual file /proc/self/cgroup should list the current cgroup
  # membership. For each hierarchy, you can follow the cgroup path from
  # this file to the cgroup filesystem (usually /sys/fs/cgroup/) and
  # introspect the statistics for the cgroup for the given
  # hierarchy. Alas, Docker breaks this by mounting the container
  # statistics at the root while leaving the cgroup paths as the actual
  # paths. Therefore, Elasticsearch provides a mechanism to override
  # reading the cgroup path from /proc/self/cgroup and instead uses the
  # cgroup path defined the JVM system property
  # es.cgroups.hierarchy.override. Therefore, we set this value here so
  # that cgroup statistics are available for the container this process
  # will run in.
  export ES_JAVA_OPTS="-Des.cgroups.hierarchy.override=/ $ES_JAVA_OPTS"
fi

exec \
    "$JAVA" \
    $LAUNCHER_JAVA_OPTS \
    -Dcli.toolname="$LAUNCHER_TOOLNAME" \
    -Des.path.home="$ES_HOME" \
    -Des.path.conf="$ES_PATH_CONF" \
    -Des.distribution.flavor="$ES_DISTRIBUTION_FLAVOR" \
    -Des.distribution.type="$ES_DISTRIBUTION_TYPE" \
    -Des.bundled_jdk="$ES_BUNDLED_JDK" \
    -cp "$LAUNCHER_CLASSPATH" \
    org.elasticsearch.launcher.Launcher \
    "$@"
