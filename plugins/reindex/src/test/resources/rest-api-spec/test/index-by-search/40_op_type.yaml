# This test relies on setting verion: 2, version_type: external on the source
# of the copy and then uses op_type to control whether or not the operation
# overwrites. IndexBySearchOpTypeTests is a more thorough, java based version
# of these tests.

---
"op_type defaults to refresh when copying to a new index":
  - do:
      index:
        index:        src
        type:         test
        id:           1
        body:         { "company": "cat" }
        version:      2
        version_type: external
  - do:
      index:
        index:        src
        type:         test
        id:           2
        body:         { "company": "cow" }
  - do:
      index:
        index:        dest
        type:         test
        id:           1
        body:         { "company": "dog" }
  - do:
      indices.refresh: {}

  - do:
      reindex:
        body:
          src:
            index: src
          dest:
            index: dest
  - do:
      indices.refresh: {}

  - do:
      search:
        index: dest
        q:     company:cat
  - match: { hits.total: 1 }
  - do:
      search:
        index: dest
        q:     company:cow
  - match: { hits.total: 1 }

---
"op_type can be set to create":
  - do:
      index:
        index:        src
        type:         test
        id:           1
        body:         { "company": "cat" }
        version:      2
        version_type: external
  - do:
      index:
        index:        src
        type:         test
        id:           2
        body:         { "company": "cow" }
  - do:
      index:
        index:        dest
        type:         test
        id:           1
        body:         { "company": "dog" }
  - do:
      indices.refresh: {}

  - do:
      reindex:
        body:
          op_type: create
          src:
            index:   src
          dest:
            index:   dest
  - do:
      indices.refresh: {}

  - do:
      search:
        index: dest
        q:     company:dog
  - match: { hits.total: 1 }
  - do:
      search:
        index: dest
        q:     company:cow
  - match: { hits.total: 1 }

---
"op_type can be set to refresh":
  - do:
      index:
        index:        src
        type:         test
        id:           1
        body:         { "company": "cat" }
        version:      2
        version_type: external
  - do:
      index:
        index:        src
        type:         test
        id:           2
        body:         { "company": "cow" }
  - do:
      index:
        index:        dest
        type:         test
        id:           1
        body:         { "company": "dog" }
  - do:
      indices.refresh: {}

  - do:
      reindex:
        body:
          op_type: refresh
          src:
            index:   src
          dest:
            index:   dest
  - do:
      indices.refresh: {}

  - do:
      search:
        index: dest
        q:     company:cat
  - match: { hits.total: 1 }
  - do:
      search:
        index: dest
        q:     company:cow
  - match: { hits.total: 1 }

---
"op_type can be set to overwrite":
  - do:
      index:
        index:        src
        type:         test
        id:           1
        body:         { "company": "cat" }
  - do:
      index:
        index:        src
        type:         test
        id:           2
        body:         { "company": "cow" }
  - do:
      index:
        index:        dest
        type:         test
        id:           1
        body:         { "company": "dog" }
  - do:
      indices.refresh: {}

  - do:
      reindex:
        body:
          op_type: overwrite
          src:
            index:   src
          dest:
            index:   dest
  - do:
      indices.refresh: {}

  - do:
      search:
        index: dest
        q:     company:cat
  - match: { hits.total: 1 }
  - do:
      search:
        index: dest
        q:     company:cow
  - match: { hits.total: 1 }
