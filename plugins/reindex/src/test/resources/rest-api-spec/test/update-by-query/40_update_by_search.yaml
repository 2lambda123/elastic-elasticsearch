---
"Update a document using update-by-query":
  - do:
      index:
        index:  twitter
        type:   tweet
        id:     1
        body:   { "user": "kimchy" }
  - do:
      indices.refresh: {}

  - do:
      update-by-query:
        index: twitter
        body:
          script:
            inline: ctx._source.user = "not" + ctx._source.user
  - match: {updated: 1}
  - match: {noops: 0}
  - do:
      indices.refresh: {}

  - do:
      search:
        index: twitter
        body:
          query:
            match:
              user: notkimchy
  - match: { hits.total: 1 }

---
"Noop one doc":
  - do:
      index:
        index:  twitter
        type:   tweet
        id:     1
        body:   { "user": "kimchy" }
  - do:
      index:
        index:  twitter
        type:   tweet
        id:     2
        body:   { "user": "foo" }
  - do:
      indices.refresh: {}

  - do:
      update-by-query:
        index: twitter
        body:
          script:
            inline: if (ctx._source.user == "kimchy") {ctx._source.user = "not" + ctx._source.user} else {ctx.op = "noop"}
  - match: {updated: 1}
  - match: {noops: 1}
  - do:
      indices.refresh: {}

  - do:
      search:
        index: twitter
        body:
          query:
            match:
              user: notkimchy
  - match: { hits.total: 1 }

  - do:
      search:
        index: twitter
        body:
          query:
            match:
              user: notfoo
  - match: { hits.total: 0 }

---
"Noop all docs":
  - do:
      index:
        index:  twitter
        type:   tweet
        id:     1
        body:   { "user": "kimchy" }
  - do:
      index:
        index:  twitter
        type:   tweet
        id:     2
        body:   { "user": "foo" }
  - do:
      indices.refresh: {}

  - do:
      update-by-query:
        index: twitter
        body:
          script:
            inline: ctx.op = "noop"
  - match: {updated: 0}
  - match: {noops: 2}
  - match: {batches: 1}
  - do:
      indices.refresh: {}
