---
"Test Create and update dense vector mapping":
  - do:
      indices.create:
        index: test_index

  - do:
      indices.put_mapping:
        index: test_index
        body:
          properties:
            embedding:
              type: dense_vector
              dims: 4
              index: true
              index_options:
                type: flat

  - do:
      indices.get_mapping:
        index: test_index

  - match: { test_index.mappings.properties.embedding.type: dense_vector }
  - match: { test_index.mappings.properties.embedding.index_options.type: flat }

  - do:
      bulk:
        refresh: true
        index: test_index
        body:
          - '{"index": {"_id": "1"}}'
          - '{"embedding": [1, 1, 1, 1]}'
          - '{"index": {"_id": "2"}}'
          - '{"embedding": [1, 1, 1, 2]}'
          - '{"index": {"_id": "3"}}'
          - '{"embedding": [1, 1, 1, 3]}'
          - '{"index": {"_id": "4"}}'
          - '{"embedding": [1, 1, 1, 4]}'
          - '{"index": {"_id": "5"}}'
          - '{"embedding": [1, 1, 1, 5]}'
          - '{"index": {"_id": "6"}}'
          - '{"embedding": [1, 1, 1, 6]}'
          - '{"index": {"_id": "7"}}'
          - '{"embedding": [1, 1, 1, 7]}'
          - '{"index": {"_id": "8"}}'
          - '{"embedding": [1, 1, 1, 8]}'
          - '{"index": {"_id": "9"}}'
          - '{"embedding": [1, 1, 1, 9]}'
          - '{"index": {"_id": "10"}}'
          - '{"embedding": [1, 1, 1, 10]}'

  - do:
      search:
        index: test_index
        body:
          size: 3
          query:
            knn:
              field: embedding
              query_vector: [1, 1, 1, 1]
              num_candidates: 10

  - match: { hits.total.value: 10 }
  - length: {hits.hits: 3}
  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.2._id: "3" }

  - do:
      indices.put_mapping:
        index: test_index
        body:
          properties:
            embedding:
              type: dense_vector
              dims: 4
              index: true
              index_options:
                type: int8_flat

  - do:
      indices.get_mapping:
        index: test_index

  - match: { test_index.mappings.properties.embedding.type: dense_vector }
  - match: { test_index.mappings.properties.embedding.index_options.type: int8_flat }

  - do:
      bulk:
        refresh: true
        index: test_index
        body:
          - '{"index": {"_id": "11"}}'
          - '{"embedding": [2, 1, 1, 1]}'
          - '{"index": {"_id": "12"}}'
          - '{"embedding": [3, 1, 1, 2]}'
          - '{"index": {"_id": "13"}}'
          - '{"embedding": [4, 1, 1, 3]}'
          - '{"index": {"_id": "14"}}'
          - '{"embedding": [5, 1, 1, 4]}'
          - '{"index": {"_id": "15"}}'
          - '{"embedding": [6, 1, 1, 5]}'
          - '{"index": {"_id": "16"}}'
          - '{"embedding": [7, 1, 1, 6]}'
          - '{"index": {"_id": "17"}}'
          - '{"embedding": [8, 1, 1, 7]}'
          - '{"index": {"_id": "18"}}'
          - '{"embedding": [9, 1, 1, 8]}'
          - '{"index": {"_id": "19"}}'
          - '{"embedding": [10, 1, 1, 9]}'
          - '{"index": {"_id": "20"}}'
          - '{"embedding": [1, 11, 1, 10]}'
  - do:
      search:
        index: test_index
        body:
          size: 3
          query:
            knn:
              field: embedding
              query_vector: [ 1, 1, 1, 1 ]
              num_candidates: 20

  - match: { hits.total.value: 20 }
  - length: { hits.hits: 3 }
  - match: { hits.hits.0._id: "1" }
  - match: { hits.hits.1._id: "2" }
  - match: { hits.hits.2._id: "11" }
