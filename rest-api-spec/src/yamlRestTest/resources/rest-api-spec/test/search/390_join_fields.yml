setup:
  - do:
      index:
        index: ip_locations
        id: 192.168.1.1
        body: { country: 'Canada', city: 'Montreal' }

  - do:
      index:
        index: ip_locations
        id: 192.168.1.3
        body: { country: 'Canada', city: 'Toronto' }

  - do:
      index:
        index: logs
        body: { ip: '192.168.1.1', msg: 'The first message', ord: 1}
  - do:
      index:
        index: logs
        body: { ip: '192.168.1.2', msg: 'The second message', ord: 2}

  - do:
      indices.refresh:
        index: "logs"

---
"Look up join fields":
  - skip:
      version: " - 8.0.99"
      reason: "Join fields are introduced in 8.1"
  - do:
      search:
        index: logs
        body:
          sort: ord
          fields:
            - msg
            - name: location
              type: lookup
              index: ip_locations
              key: ip

  - match: { hits.hits.0.fields.ip: ['192.168.1.1'] }
  - match: { hits.hits.0.fields.msg: ['The first message'] }
  - match: { hits.hits.0.fields.location: [{ "_id": ['192.168.1.1'], country: ['Canada'], city: ['Montreal']}]}

  - match: { hits.hits.1.fields.ip: ['192.168.1.2']}
  - match: { hits.hits.1.fields.msg: ['The second message']}
  - match: { hits.hits.1.fields.location: [{ "_id": ['192.168.1.2'], "_failure": ["id [192.168.1.2] on index [ip_locations] doesn't exist"]}]}

  - do:
     search:
       index: logs
       body:
         sort: ord
         fields:
           - msg
           - name: location
             type: lookup
             index: other_ip_tables
             key: ip

  - match: { hits.hits.0.fields.ip: [ '192.168.1.1' ] }
  - match: { hits.hits.0.fields.msg: [ 'The first message' ]}
  - match: { hits.hits.0.fields.location: [{ "_id": [ '192.168.1.1'], "_failure": ['no such index [other_ip_tables]']}]}

  - match: { hits.hits.1.fields.ip: ['192.168.1.2'] }
  - match: { hits.hits.1.fields.msg: ['The second message']}
  - match: { hits.hits.1.fields.location: [{ "_id": ['192.168.1.2'], "_failure": ['no such index [other_ip_tables]'] } ]}
