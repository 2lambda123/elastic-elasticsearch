setup:
  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_replicas: 0
          mappings:
            properties:
              date:
                type: date_nanos

  - do:
      bulk:
        index: test
        refresh: true
        body:
          - { "index": {} }
          - { "date": "2015-01-01" }
          - { "index": {} }
          - { "date": "2015-01-01T12:10:30.123456789Z" }
          - { "index": {} }
          - { "date": 1420070400 }
          - { "index": {} }

---
"date_histogram on date_nanos without timezone fixed interval":
  - skip:
      version: " - 8.1.99"
      reason: bug fixed in 8.2.0
  - do:
      search:
        body:
          size: 0
          aggregations:
            date_histogram:
              date_histogram:
                field: date
                fixed_interval: 30s
                min_doc_count: 1

  - match: { hits.total.value: 3 }
  - match: { hits.total.relation: "eq" }
  - length: { aggregations.date_histogram.buckets: 3 }
  - match: { aggregations.date_histogram.buckets.0.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.0.key_as_string: "1970-01-17T10:27:30.000Z" }
  - match: { aggregations.date_histogram.buckets.0.key: 1420050000 }
  - match: { aggregations.date_histogram.buckets.1.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.1.key_as_string: "2015-01-01T00:00:00.000Z" }
  - match: { aggregations.date_histogram.buckets.1.key: 1420070400000 }
  - match: { aggregations.date_histogram.buckets.2.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.2.key_as_string: "2015-01-01T12:10:30.000Z" }
  - match: { aggregations.date_histogram.buckets.2.key: 1420114230000 }

---
"date_histogram on date_nanos with timezone fixed interval":
  - skip:
      version: " - 8.1.99"
      reason: bug fixed in 8.2.0
  - do:
      search:
        body:
          size: 0
          aggregations:
            date_histogram:
              date_histogram:
                field: date
                fixed_interval: 30s
                time_zone: Europe/Berlin
                min_doc_count: 1

  - match: { hits.total.value: 3 }
  - match: { hits.total.relation: "eq" }
  - match: { aggregations.date_histogram.buckets.0.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.0.key_as_string: "1970-01-17T11:27:30.000+01:00" }
  - match: { aggregations.date_histogram.buckets.0.key: 1420050000 }
  - match: { aggregations.date_histogram.buckets.1.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.1.key_as_string: "2015-01-01T01:00:00.000+01:00" }
  - match: { aggregations.date_histogram.buckets.1.key: 1420070400000 }
  - match: { aggregations.date_histogram.buckets.2.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.2.key_as_string: "2015-01-01T13:10:30.000+01:00" }
  - match: { aggregations.date_histogram.buckets.2.key: 1420114230000 }

---
"date_histogram on date_nanos without timezone calendar interval":
  - skip:
      version: " - 8.1.99"
      reason: bug fixed in 8.2.0
  - do:
      search:
        body:
          size: 0
          aggregations:
            date_histogram:
              date_histogram:
                field: date
                calendar_interval: minute
                min_doc_count: 1

  - match: { hits.total.value: 3 }
  - match: { hits.total.relation: "eq" }
  - length: { aggregations.date_histogram.buckets: 3 }
  - match: { aggregations.date_histogram.buckets.0.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.0.key_as_string: "1970-01-17T10:27:00.000Z" }
  - match: { aggregations.date_histogram.buckets.0.key: 1420020000 }
  - match: { aggregations.date_histogram.buckets.1.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.1.key_as_string: "2015-01-01T00:00:00.000Z" }
  - match: { aggregations.date_histogram.buckets.1.key: 1420070400000 }
  - match: { aggregations.date_histogram.buckets.2.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.2.key_as_string: "2015-01-01T12:10:00.000Z" }
  - match: { aggregations.date_histogram.buckets.2.key: 1420114200000 }

---
"date_histogram on date_nanos with timezone calendar interval":
  - skip:
      version: " - 8.1.99"
      reason: bug fixed in 8.2.0
  - do:
      search:
        body:
          size: 0
          aggregations:
            date_histogram:
              date_histogram:
                field: date
                calendar_interval: minute
                time_zone: Europe/Berlin
                min_doc_count: 1

  - match: { hits.total.value: 3 }
  - match: { hits.total.relation: "eq" }
  - match: { aggregations.date_histogram.buckets.0.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.0.key_as_string: "1970-01-17T11:27:00.000+01:00" }
  - match: { aggregations.date_histogram.buckets.0.key: 1420020000 }
  - match: { aggregations.date_histogram.buckets.1.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.1.key_as_string: "2015-01-01T01:00:00.000+01:00" }
  - match: { aggregations.date_histogram.buckets.1.key: 1420070400000 }
  - match: { aggregations.date_histogram.buckets.2.doc_count: 1 }
  - match: { aggregations.date_histogram.buckets.2.key_as_string: "2015-01-01T13:10:00.000+01:00" }
  - match: { aggregations.date_histogram.buckets.2.key: 1420114200000 }
