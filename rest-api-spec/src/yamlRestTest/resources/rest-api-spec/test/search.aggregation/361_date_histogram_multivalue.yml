setup:
  - do:
      indices.create:
          index: test
          body:
            settings:
              number_of_replicas: 0
            mappings:
              properties:
                date:
                  type: date
  - do:
      cluster.health:
        wait_for_status: green

  - do:
      bulk:
        index: test
        refresh: true
        body:
          - '{"index": {}}'
          - '{ "date":["2021-05-01","2021-04-01","2021-04-22"] }'
---
 teardown:

  - do:
      cluster.put_settings:
        body:
          persistent:
            search.aggs.rewrite_to_filter_by_filter: null

---
"Multi-value date histogram":
  - do:
      search:
        body:
          query:
            match:
              date: "2021-04-01"
          aggs:
            datehisto:
              date_histogram:
                field: "date"
                calendar_interval: "1M"

  - match: { hits.total.value: 1 }
  - length: { aggregations.datehisto.buckets: 2 }
---
"Multi-value without filter by filter":
  - do:
      cluster.put_settings:
        body:
          persistent:
            search.aggs.rewrite_to_filter_by_filter: false
  - do:
      search:
        body:
          query:
            match:
              date: "2021-04-01"
          aggs:
            datehisto:
              date_histogram:
                field: "date"
                calendar_interval: "1M"

  - match: { hits.total.value: 1 }
  - length: { aggregations.datehisto.buckets: 2 }
