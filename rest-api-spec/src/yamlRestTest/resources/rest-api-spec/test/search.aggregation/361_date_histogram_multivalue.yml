setup:
  - do:
      indices.create:
          index: test
          body:
            settings:
              number_of_replicas: 0
            mappings:
              properties:
                date:
                  type: date
                date_not_indexed:
                  type: date
                  index: false
  - do:
      cluster.health:
        wait_for_status: green

  - do:
      bulk:
        index: test
        refresh: true
        body:
          - '{"index": {}}'
          - '{ "date":["2021-05-01","2021-04-01","2021-04-22"], "date_not_indexed":["2021-05-01","2021-04-01","2021-03-22"]}'
---
 teardown:

  - do:
      cluster.put_settings:
        body:
          persistent:
            search.aggs.rewrite_to_filter_by_filter: null

---
"Multi-value date histogram":
  - skip:
      version: " - 8.1.99"
      reason:  Bug fixed in 8.2.0

  - do:
      search:
        body:
          query:
            match:
              date: "2021-04-01"
          aggs:
            datehisto:
              date_histogram:
                field: "date"
                calendar_interval: "1M"

  - match: { hits.total.value: 1 }
  - length: { aggregations.datehisto.buckets: 2 }

---
"Multi-value date histogram docvalues only":
  - skip:
      version: " - 8.1.99"
      reason:  Bug fixed in 8.2.0

  - do:
      search:
        body:
          profile: true
          query:
            match:
              date_not_indexed: "2021-04-01"
          aggs:
            datehisto:
              date_histogram:
                field: "date_not_indexed"
                calendar_interval: "1M"

  - match: { hits.total.value: 1 }
  - length: { aggregations.datehisto.buckets: 3 }
---
"Multi-value without filter by filter":
  - skip:
      version: " - 8.1.99"
      reason:  Bug fixed in 8.2.0

  - do:
      cluster.put_settings:
        body:
          persistent:
            search.aggs.rewrite_to_filter_by_filter: false
  - do:
      search:
        body:
          query:
            match:
              date: "2021-04-01"
          aggs:
            datehisto:
              date_histogram:
                field: "date"
                calendar_interval: "1M"

  - match: { hits.total.value: 1 }
  - length: { aggregations.datehisto.buckets: 2 }
