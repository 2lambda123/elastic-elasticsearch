keyword dimension:
  - skip:
      features: close_to
      version: " - 8.10.99"
      reason: _tsid hasing introduced in 8.11


  - do:
      indices.create:
          index: test
          body:
            settings:
              index:
                mode: time_series
                routing_path: [uid]
                time_series:
                  start_time: 2021-04-28T00:00:00Z
                  end_time: 2021-04-29T00:00:00Z
            mappings:
              properties:
                "@timestamp":
                  type: date
                uid:
                  type: keyword
                  time_series_dimension: true

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.2}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.6}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.1}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.3}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 3.2}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 3.6}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 3.1}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 3.3}'
  - is_false: errors

  - do:
      search:
        index: test
        body:
          size: 0
          aggs:
            tsids:
              terms:
                field: _tsid
                order:
                  _key: asc
              aggs:
                voltage:
                  avg:
                    field: voltage

  - match: {hits.total.value: 8}
  - match: {aggregations.tsids.buckets.0.key: {_tsid: "_pW31QsQDh_r6QMn0c6jJhFGYOwd6P6Vt9ULEAAAAAAAAAAAAAAAAAAAAAA5ihHD_pW31QsQmAXfxM3_zbMMRzVn-ZChwA"}}
  - match: {aggregations.tsids.buckets.0.doc_count: 4}
  - close_to: {aggregations.tsids.buckets.0.voltage.value: { value: 3.3, error: 0.01 }}
  - match: {aggregations.tsids.buckets.1.key: {_tsid: "_pW31QsQDh_r6QMn0c6jJhFGYOwd6P6Vt9ULEAAAAAAAAAAAAAAAAAAAAAB12oDh_pW31QsQVMfWLO-N2j8tEM_EPwLCbQ"}}
  - match: {aggregations.tsids.buckets.1.doc_count: 4}
  - close_to: {aggregations.tsids.buckets.1.voltage.value: { value: 7.3, error: 0.01 }}

---
flattened dimension:
  - skip:
      features: close_to
      version: " - 8.10.99"
      reason: _tsid hasing introduced in 8.11


  - do:
      indices.create:
        index: test
        body:
          settings:
            index:
              mode: time_series
              routing_path: [uid]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              uid:
                type: keyword
                time_series_dimension: true
              deployment:
                type: flattened
                time_series_dimensions: [ "build.tag", "version.major", "version.minor", "version.patch" ]

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.2, "deployment": { "build": { "tag": "1516op6778", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.0, "deployment": { "build": { "tag": "1516op6778", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.4, "deployment": { "build": { "tag": "1516op6885", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.3, "deployment": { "build": { "tag": "1516op6885", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.6, "deployment": { "build": { "tag": "16w3xaca09", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.7, "deployment": { "build": { "tag": "16w3xaca09", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.7, "deployment": { "build": { "tag": "16w3xacq34", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.8, "deployment": { "build": { "tag": "16w3xacq34", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'

  - is_false: errors
  - do:
      search:
        index: test
        body:
          size: 0
          aggs:
            tsids:
              terms:
                field: _tsid
                order:
                  _key: asc
              aggs:
                voltage:
                  avg:
                    field: voltage

  - match: { hits.total.value: 8}
  - length: { aggregations.tsids.buckets: 4}

  - match: { aggregations.tsids.buckets.0.key._tsid: "_pW31QsQP5PJzRH8-Gbp6mqjByZOmv6Vt9ULEAAAAAAAAAAAAAAAAAAAAAAoaZ29eRDHR3kQx0fjCuTKddqA4f6Vt9ULEAfDLRt1ZH3XxmzpI4VE1d8" }
  - match: { aggregations.tsids.buckets.0.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.0.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.0.key.deployment\.version\.minor: null }
  - match: { aggregations.tsids.buckets.0.key.deployment\.version\.patch: null }
  - match: { aggregations.tsids.buckets.0.doc_count: 2 }
  - close_to: { aggregations.tsids.buckets.0.voltage.value: { value: 7.35, error: 0.01 }}

  - match: { aggregations.tsids.buckets.1.key._tsid: "_pW31QsQP5PJzRH8-Gbp6mqjByZOmv6Vt9ULEAAAAAAAAAAAAAAAAAAAAACrnf7qeRDHR3kQx0eLDvTuOYoRw_6Vt9ULEBX9MyeUknhbUqQelj0fVGI" }
  - match: { aggregations.tsids.buckets.1.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.1.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.1.key.deployment\.version\.minor: null }
  - match: { aggregations.tsids.buckets.1.key.deployment\.version\.patch: null }
  - match: { aggregations.tsids.buckets.1.doc_count: 2 }
  - close_to: { aggregations.tsids.buckets.1.voltage.value: { value: 6.75, error: 0.01 }}

  - match: { aggregations.tsids.buckets.2.key._tsid: "_pW31QsQP5PJzRH8-Gbp6mqjByZOmv6Vt9ULEAAAAAAAAAAAAAAAAAAAAADP1l1UeRDHR3kQx0fjCuTKddqA4f6Vt9ULEJbbw13wErAIwoyRvfPwBO0" }
  - match: { aggregations.tsids.buckets.2.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.2.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.2.key.deployment\.version\.minor: null }
  - match: { aggregations.tsids.buckets.2.key.deployment\.version\.patch: null }
  - match: { aggregations.tsids.buckets.2.doc_count: 2 }
  - close_to: { aggregations.tsids.buckets.2.voltage.value: { value: 7.10, error: 0.01 }}

  - match: { aggregations.tsids.buckets.3.key._tsid: "_pW31QsQP5PJzRH8-Gbp6mqjByZOmv6Vt9ULEAAAAAAAAAAAAAAAAAAAAADgKelzeRDHR3kQx0eLDvTuOYoRw_6Vt9ULECy-cFCrvRwidF9_OFLsEgY" }
  - match: { aggregations.tsids.buckets.3.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.3.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.3.key.deployment\.version\.minor: null }
  - match: { aggregations.tsids.buckets.3.key.deployment\.version\.patch: null }
  - match: { aggregations.tsids.buckets.3.doc_count: 2 }
  - close_to: { aggregations.tsids.buckets.3.voltage.value: { value: 6.65, error: 0.01 }}

---
flattened empty dimension:
  - skip:
      features: close_to
      version: " - 8.10.99"
      reason: _tsid hasing introduced in 8.11


  - do:
      indices.create:
        index: test
        body:
          settings:
            index:
              mode: time_series
              routing_path: [uid]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              uid:
                type: keyword
                time_series_dimension: true
              deployment:
                type: flattened
                time_series_dimensions: []

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.2, "deployment": { "build": { "tag": "1516op6778", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.0, "deployment": { "build": { "tag": "1516op6778", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.4, "deployment": { "build": { "tag": "1516op6885", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.3, "deployment": { "build": { "tag": "1516op6885", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.6, "deployment": { "build": { "tag": "16w3xaca09", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.7, "deployment": { "build": { "tag": "16w3xaca09", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.7, "deployment": { "build": { "tag": "16w3xacq34", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.8, "deployment": { "build": { "tag": "16w3xacq34", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'

  - is_false: errors
  - do:
      search:
        index: test
        body:
          size: 0
          aggs:
            tsids:
              terms:
                field: _tsid
                order:
                  _key: asc
              aggs:
                voltage:
                  avg:
                    field: voltage

  - match: { hits.total.value: 8 }
  - length: { aggregations.tsids.buckets: 2 }

  - match: { aggregations.tsids.buckets.0.key._tsid: "_pW31QsQDh_r6QMn0c6jJhFGYOwd6P6Vt9ULEAAAAAAAAAAAAAAAAAAAAAA5ihHD_pW31QsQmAXfxM3_zbMMRzVn-ZChwA" }
  - match: { aggregations.tsids.buckets.0.doc_count: 4 }
  - close_to: { aggregations.tsids.buckets.0.voltage.value: { value: 6.69, error: 0.01 }}

  - match: { aggregations.tsids.buckets.1.key._tsid: "_pW31QsQDh_r6QMn0c6jJhFGYOwd6P6Vt9ULEAAAAAAAAAAAAAAAAAAAAAB12oDh_pW31QsQVMfWLO-N2j8tEM_EPwLCbQ" }
  - match: { aggregations.tsids.buckets.1.doc_count: 4 }
  - close_to: { aggregations.tsids.buckets.1.voltage.value: { value: 7.22, error: 0.01 }}


---
flattened field missing routing path field:
  - skip:
      features: close_to
      version: " - 8.10.99"
      reason: _tsid hasing introduced in 8.11

  - do:
      indices.create:
        index: test
        body:
          settings:
            index:
              mode: time_series
              routing_path: [uid, deployment.build.tag]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              uid:
                type: keyword
                time_series_dimension: true
              deployment:
                type: flattened
                time_series_dimensions: [ build.branch, build.tag, version.major ]

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.2, "deployment": { "build": { "tag": "1516op6778", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.0, "deployment": { "build": { "tag": "1516op6778", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.4, "deployment": { "build": { "tag": "1516op6885", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.3, "deployment": { "build": { "sha": "1516op6885", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.6, "deployment": { "build": { "tag": "16w3xaca09", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.7, "deployment": { "build": { "sha": "16w3xaca09", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.7, "deployment": { "build": { "tag": "16w3xacq34", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.8, "deployment": { "build": { "tag": "16w3xacq34", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'

  - is_false: errors
  - do:
      search:
        index: test
        body:
          size: 0
          aggs:
            tsids:
              terms:
                field: _tsid
                order:
                  _key: asc
              aggs:
                voltage:
                  avg:
                    field: voltage

  - match: { hits.total.value: 8 }
  - length: { aggregations.tsids.buckets: 6 }

  - match: { aggregations.tsids.buckets.0.key._tsid: "_pW31QsQs0XCB0MdYlNxY9PEJqOWhv6Vt9ULEAAAAAAAAAAAAAAAAAAAAADxTXebeRDHRzmKEcP-lbfVCxDP-9PVa-RfUDC6eRn9DO3J" }
  - match: { aggregations.tsids.buckets.0.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.0.key.deployment\.build\.branch: null }
  - match: { aggregations.tsids.buckets.0.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.0.doc_count: 1 }
  - close_to: { aggregations.tsids.buckets.0.voltage.value: { value: 6.70, error: 0.01 }}

  - match: { aggregations.tsids.buckets.1.key._tsid: "_pW31QsQs0XCB0MdYlNxY9PEJqOWhv6Vt9ULEAAAAAAAAAAAAAAAAAAAAADxTXebeRDHR3XagOH-lbfVCxAZbEZUQPevXNiuufZwN2d1" }
  - match: { aggregations.tsids.buckets.1.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.1.key.deployment\.build\.branch: null }
  - match: { aggregations.tsids.buckets.1.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.1.doc_count: 1 }
  - close_to: { aggregations.tsids.buckets.1.voltage.value: { value: 7.30, error: 0.01 }}

  - match: { aggregations.tsids.buckets.2.key._tsid: "_pW31QsQWPttUWoKR4uM6b9jH-_EXv6Vt9ULEAAAAAAAAAAAAAAAAAAAAADxTXebKGmdvXkQx0d12oDh_pW31QsQ1FENdo5JPhSC9XstiiFMZw" }
  - match: { aggregations.tsids.buckets.2.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.2.key.deployment\.build\.branch: null }
  - match: { aggregations.tsids.buckets.2.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.2.doc_count: 1 }
  - close_to: { aggregations.tsids.buckets.2.voltage.value: { value: 7.40, error: 0.01 }}

  - match: { aggregations.tsids.buckets.3.key._tsid: "_pW31QsQWPttUWoKR4uM6b9jH-_EXv6Vt9ULEAAAAAAAAAAAAAAAAAAAAADxTXebq53-6nkQx0c5ihHD_pW31QsQi5nFHahYKUKfgq8xHVO8cA" }
  - match: { aggregations.tsids.buckets.3.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.3.key.deployment\.build\.branch: null }
  - match: { aggregations.tsids.buckets.3.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.3.doc_count: 2 }
  - close_to: { aggregations.tsids.buckets.3.voltage.value: { value: 6.75, error: 0.01 }}

  - match: { aggregations.tsids.buckets.4.key._tsid: "_pW31QsQWPttUWoKR4uM6b9jH-_EXv6Vt9ULEAAAAAAAAAAAAAAAAAAAAADxTXebz9ZdVHkQx0d12oDh_pW31QsQ-nmBYp5rUkkaiyO1h0pD9Q" }
  - match: { aggregations.tsids.buckets.4.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.4.key.deployment\.build\.branch: null }
  - match: { aggregations.tsids.buckets.4.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.4.doc_count: 2 }
  - close_to: { aggregations.tsids.buckets.4.voltage.value: { value: 7.10, error: 0.01 }}

  - match: { aggregations.tsids.buckets.5.key._tsid: "_pW31QsQWPttUWoKR4uM6b9jH-_EXv6Vt9ULEAAAAAAAAAAAAAAAAAAAAADxTXeb4Cnpc3kQx0c5ihHD_pW31QsQRLXz7VAY03chH7T4JK6g9g" }
  - match: { aggregations.tsids.buckets.5.key.deployment\.build\.tag: null }
  - match: { aggregations.tsids.buckets.5.key.deployment\.build\.branch: null }
  - match: { aggregations.tsids.buckets.5.key.deployment\.version\.major: null }
  - match: { aggregations.tsids.buckets.5.doc_count: 1 }
  - close_to: { aggregations.tsids.buckets.5.voltage.value: { value: 6.60, error: 0.01 }}

---
flattened field misspelled routing path field:
  - skip:
      features: close_to
      version: " - 8.10.99"
      reason: _tsid hasing introduced in 8.11

  - do:
      indices.create:
        index: test
        body:
          settings:
            index:
              mode: time_series
              # NOTE: 'reigion' here is misspelled on purpose
              routing_path: [deployment.reigion, deployment.build.tag]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            properties:
              "@timestamp":
                type: date
              uid:
                type: keyword
              deployment:
                type: flattened
                # NOTE: 'reigion' here is misspelled on purpose
                time_series_dimensions: [ reigion, build.tag ]

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.2, "deployment": { "build": { "tag": "1516op6778", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.0, "deployment": { "build": { "tag": "1516op6778", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.4, "deployment": { "build": { "tag": "1516op6885", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "947e4ced-1786-4e53-9e0c-5c447e959507", "voltage": 7.3, "deployment": { "build": { "sha": "1516op6885", "branch": "release-8.8" }, "region": "eu-west-1", "version": { "major": 8, "minor": 8, "patch": 0 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.6, "deployment": { "build": { "tag": "16w3xaca09", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.7, "deployment": { "build": { "sha": "16w3xaca09", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.7, "deployment": { "build": { "tag": "16w3xacq34", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "uid": "df3145b3-0563-4d3b-a0f7-897eb2876ea9", "voltage": 6.8, "deployment": { "build": { "tag": "16w3xacq34", "branch": "release-8.8" }, "region": "eu-west-2", "version": { "major": 8, "minor": 8, "patch": 1 }}}'

  - is_true: errors

  - match: { items.3.index.error.reason: "Error extracting routing: source didn't contain any routing fields" }
  - match: { items.5.index.error.reason: "Error extracting routing: source didn't contain any routing fields" }

  - do:
      search:
        index: test
        body:
          size: 0
          aggs:
            tsids:
              terms:
                field: _tsid
                order:
                  _key: asc
              aggs:
                voltage:
                  avg:
                    field: voltage

  - match: { hits.total.value: 6 }
  - length: { aggregations.tsids.buckets: 4 }

  - match: { aggregations.tsids.buckets.0.key._tsid: "_pW31QsQVpe7uQk6zUIFfFcpASZ8Y_6Vt9ULEAAAAAAAAAAAAAAAAAAAAAAoaZ29_pW31QsQ6X1JYjFYp22EdW9Qe7Fh3Q" }
  - match: { aggregations.tsids.buckets.0.doc_count: 1 }
  - close_to: { aggregations.tsids.buckets.0.voltage.value: { value: 7.40, error: 0.01 }}

  - match: { aggregations.tsids.buckets.1.key._tsid: "_pW31QsQVpe7uQk6zUIFfFcpASZ8Y_6Vt9ULEAAAAAAAAAAAAAAAAAAAAACrnf7q_pW31QsQTp_Y-T2FMaY2THS8Sv5rUQ" }
  - match: { aggregations.tsids.buckets.1.doc_count: 2 }
  - close_to: { aggregations.tsids.buckets.1.voltage.value: { value: 6.75, error: 0.01 }}

  - match: { aggregations.tsids.buckets.2.key._tsid: "_pW31QsQVpe7uQk6zUIFfFcpASZ8Y_6Vt9ULEAAAAAAAAAAAAAAAAAAAAADP1l1U_pW31QsQvSkqmNP15820DPPjhXpE7w" }
  - match: { aggregations.tsids.buckets.2.doc_count: 2 }
  - close_to: { aggregations.tsids.buckets.2.voltage.value: { value: 7.10, error: 0.01 }}

  - match: { aggregations.tsids.buckets.3.key._tsid: "_pW31QsQVpe7uQk6zUIFfFcpASZ8Y_6Vt9ULEAAAAAAAAAAAAAAAAAAAAADgKelz_pW31QsQ59jWtAPPEZOFAL6Fp-tkHA" }
  - match: { aggregations.tsids.buckets.3.doc_count: 1 }
  - close_to: { aggregations.tsids.buckets.3.voltage.value: { value: 6.60, error: 0.01 }}

---
long dimension:
  - skip:
      features: close_to
      version: " - 8.10.99"
      reason: _tsid hasing introduced in 8.11

  - do:
      indices.create:
          index: test
          body:
            settings:
              index:
                mode: time_series
                routing_path: [metricset]
                time_series:
                  start_time: 2021-04-28T00:00:00Z
                  end_time: 2021-04-29T00:00:00Z
            mappings:
              properties:
                "@timestamp":
                  type: date
                metricset:
                  type: keyword
                  time_series_dimension: true
                id:
                  type: long
                  time_series_dimension: true

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "metricset": "aa", "id": 1, "voltage": 7.2}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "metricset": "aa", "id": "1", "voltage": 7.6}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "metricset": "aa", "id": 1.0, "voltage": 7.1}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "metricset": "aa", "id": "001", "voltage": 7.3}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "metricset": "aa", "id": 2, "voltage": 3.2}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "metricset": "aa", "id": 2, "voltage": 3.6}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "metricset": "aa", "id": 2, "voltage": 3.1}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "metricset": "aa", "id": 2, "voltage": 3.3}'

  - do:
      search:
        index: test
        body:
          size: 0
          aggs:
            tsids:
              terms:
                field: _tsid
                order:
                  _key: asc
              aggs:
                voltage:
                  avg:
                    field: voltage

  - match: {hits.total.value: 8}
  - match: {aggregations.tsids.buckets.0.key: {_tsid: "_pW31QsQXNiiZwxkczx2lrb8CBwni_6Vt9ULEAAAAAAAAAAAAAAAAAAAAABDgKYd73outv6Vt9ULEBnwPdwtIAd7vn-6M1jNT1s"}}
  - match: {aggregations.tsids.buckets.0.doc_count: 4}
  - close_to: {aggregations.tsids.buckets.0.voltage.value: { value: 3.3, error: 0.01 }}
  - match: {aggregations.tsids.buckets.1.key: {_tsid: "_pW31QsQXNiiZwxkczx2lrb8CBwni_6Vt9ULEAAAAAAAAAAAAAAAAAAAAACtm41v73outv6Vt9ULELmJNwhM2k9uEB39QGAP8PY"}}
  - match: {aggregations.tsids.buckets.1.doc_count: 4}
  - close_to: {aggregations.tsids.buckets.1.voltage.value: { value: 7.3, error: 0.01 }}

---
ip dimension:
  - skip:
      features: close_to
      version: " - 8.10.99"
      reason: _tsid hasing introduced in 8.11

  - do:
      indices.create:
          index: test
          body:
            settings:
              index:
                mode: time_series
                routing_path: [metricset]
                time_series:
                  start_time: 2021-04-28T00:00:00Z
                  end_time: 2021-04-29T00:00:00Z
            mappings:
              properties:
                "@timestamp":
                  type: date
                metricset:
                  type: keyword
                  time_series_dimension: true
                ip:
                  type: ip
                  time_series_dimension: true

  - do:
      bulk:
        refresh: true
        index: test
        body:
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "metricset": "aa", "ip": "10.10.1.1", "voltage": 7.2}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "metricset": "aa", "ip": "10.10.1.1", "voltage": 7.6}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "metricset": "aa", "ip": "10.10.1.1", "voltage": 7.1}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "metricset": "aa", "ip": "::ffff:10.10.1.1", "voltage": 7.3}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:24.467Z", "metricset": "aa", "ip": "2001:0db8:85a3:0000:0000:8a2e:0370:7334", "voltage": 3.2}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:34.467Z", "metricset": "aa", "ip": "2001:0db8:85a3:0:0:8a2e:0370:7334", "voltage": 3.6}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:44.467Z", "metricset": "aa", "ip": "2001:0db8:85a3::8a2e:0370:7334", "voltage": 3.1}'
          - '{"index": {}}'
          - '{"@timestamp": "2021-04-28T18:35:54.467Z", "metricset": "aa", "ip": "2001:0db8:85a3::8a2e:0370:7334", "voltage": 3.3}'

  - do:
      search:
        index: test
        body:
          size: 0
          aggs:
            tsids:
              terms:
                field: _tsid
                order:
                  _key: asc
              aggs:
                voltage:
                  avg:
                    field: voltage

  - match: {hits.total.value: 8}
  - match: {aggregations.tsids.buckets.0.key: { _tsid: "_pW31QsQWlq2NkhwVgBD7x8-uwLcHf6Vt9ULEAAAAAAAAAAAAAAAAAAAAADYzb-v73outv6Vt9ULEBko4DlimDxhOKUBMl0caik"}}
  - match: {aggregations.tsids.buckets.0.doc_count: 4}
  - close_to: {aggregations.tsids.buckets.0.voltage.value: { value: 3.3, error: 0.01 }}
  - match: {aggregations.tsids.buckets.1.key: { _tsid: "_pW31QsQWlq2NkhwVgBD7x8-uwLcHf6Vt9ULEAAAAAAAAAAAAAAAAAAAAADaaOFK73outv6Vt9ULEJocP_SSPwvd1Uk-BTEqof0"}}
  - match: {aggregations.tsids.buckets.1.doc_count: 4}
  - close_to: {aggregations.tsids.buckets.1.voltage.value: { value: 7.3, error: 0.01 }}

---
runtime time series dimension:
  - skip:
      version: " - 8.4.99"
      reason: "downsample introduced in 8.5.0"

  - do:
      catch: '/unknown parameter \[time_series_dimension\] on runtime field \[metricset\] of type \[keyword\]/'
      indices.create:
        index: test_2
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
            index:
              mode: time_series
              routing_path: [metricset, k8s.pod.uid]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            runtime:
              metricset:
                type: keyword
                time_series_dimension: true
                script:
                  source: "emit('pod');"
            properties:
              time:
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              k8s:
                properties:
                  pod:
                    properties:
                      uid:
                        type: keyword
                        time_series_dimension: true
                      name:
                        type: keyword
                      network:
                        properties:
                          tx:
                            type: long
                            time_series_metric: gauge
                          rx:
                            type: long
                            time_series_metric: gauge
