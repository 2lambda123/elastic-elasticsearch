---
"Unable to create a time series index with @timestamp runtime field":
  - skip:
      version: " - 8.4.99"
      reason: "downsample introduced in 8.5.0"

  - do:
      catch: '/docvalues not found for index sort field:\[\@timestamp\]/'
      indices.create:
        index: test_1
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
            index:
              mode: time_series
              routing_path: [metricset, k8s.pod.uid]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            runtime:
              "@timestamp":
                type: date
                script:
                  source: "emit(doc['time']);"
            properties:
              time:
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              k8s:
                properties:
                  pod:
                    properties:
                      uid:
                        type: keyword
                        time_series_dimension: true
                      name:
                        type: keyword
                      network:
                        properties:
                          tx:
                            type: long
                            time_series_metric: gauge
                          rx:
                            type: long
                            time_series_metric: gauge

---
"Unable to create a time series index with a runtime field in the routing path":
  - skip:
      version: " - 8.4.99"
      reason: "downsample introduced in 8.5.0"

  - do:
      catch: '/All fields that match routing_path must be keywords with \[time_series_dimension\: true\] and without the \[script\] parameter\. \[pod_name\] was a runtime \[keyword\]\./'
      indices.create:
        index: test_1
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
            index:
              mode: time_series
              routing_path: [metricset, k8s.pod.uid, pod_name]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            runtime:
              pod_name:
                type: keyword
                script: |
                  emit(doc['k8s.pod.name']);
            properties:
              time:
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              k8s:
                properties:
                  pod:
                    properties:
                      uid:
                        type: keyword
                        time_series_dimension: true
                      name:
                        type: keyword
                      network:
                        properties:
                          tx:
                            type: long
                            time_series_metric: gauge
                          rx:
                            type: long
                            time_series_metric: gauge

---
"Unable to define a runtime field as a time series dimension":
  - skip:
      version: " - 8.4.99"
      reason: "downsample introduced in 8.5.0"

  - do:
      catch: '/unknown parameter \[time_series_dimension\] on runtime field \[metricset\] of type \[keyword\]/'
      indices.create:
        index: test_2
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
            index:
              mode: time_series
              routing_path: [metricset, k8s.pod.uid]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            runtime:
              metricset:
                type: keyword
                time_series_dimension: true
                script:
                  source: "emit('pod');"
            properties:
              time:
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              k8s:
                properties:
                  pod:
                    properties:
                      uid:
                        type: keyword
                        time_series_dimension: true
                      name:
                        type: keyword
                      network:
                        properties:
                          tx:
                            type: long
                            time_series_metric: gauge
                          rx:
                            type: long
                            time_series_metric: gauge

---
"Unable to define a metric type for a runtime field":
  - skip:
      version: " - 8.4.99"
      reason: "downsample introduced in 8.5.0"

  - do:
      catch: '/unknown parameter \[time_series_metric\] on runtime field \[counter\] of type \[long\]/'
      indices.create:
        index: test_3
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
            index:
              mode: time_series
              routing_path: [metricset, k8s.pod.uid]
              time_series:
                start_time: 2021-04-28T00:00:00Z
                end_time: 2021-04-29T00:00:00Z
          mappings:
            runtime:
              counter:
                type: long
                time_series_metric: counter
            properties:
              "@timestamp":
                type: date
              metricset:
                type: keyword
                time_series_dimension: true
              k8s:
                properties:
                  pod:
                    properties:
                      uid:
                        type: keyword
                        time_series_dimension: true
                      name:
                        type: keyword
                      network:
                        properties:
                          tx:
                            type: long
                            time_series_metric: gauge
                          rx:
                            type: long
                            time_series_metric: gauge
