---
"Simulate index template without new template in the body":
  - skip:
      version: " - 7.99.99"
      reason: "simulate index template API has not been backported"
      features: allowed_warnings

  - do:
      allowed_warnings:
        - "index template [test] has index patterns [te*] matching patterns from existing older templates [global] with patterns (global => [*]); this template [test] will take precedence during new index creation"
      indices.put_index_template:
        name: test
        body:
          index_patterns: te*
          template:
            settings:
              number_of_shards:   1
              number_of_replicas: 0
            mappings:
              properties:
                field:
                  type: keyword

  - do:
      indices.simulate_index_template:
        name: test

  - match: {template.settings.index.number_of_shards: "1"}
  - match: {template.settings.index.number_of_replicas: "0"}
  - match: {template.mappings._doc.properties.field.type: "keyword"}
  - match: {overlapping_v1_templates: {}}

---
"Simulate index template specifying a new template":
  - skip:
      version: " - 7.99.99"
      reason: "simulate index template API has not been backported"
      features: allowed_warnings

  - do:
      allowed_warnings:
        - "index template [test] has index patterns [te*] matching patterns from existing older templates [global] with patterns (global => [*]); this template [test] will take precedence during new index creation"
      indices.put_index_template:
        name: test
        body:
          index_patterns: te*
          priority: 10
          template:
            settings:
              number_of_shards:   1
              number_of_replicas: 0
            mappings:
              properties:
                field:
                  type: keyword

  - do:
      indices.simulate_index_template:
        name: test
        body:
          index_patterns: te*
          priority: 15
          template:
            settings:
              index.blocks.write: true

  - match: {template.settings.index.blocks.write: "true"}
  - match: {overlapping_v1_templates: {}}

---
"Simulate index template with index not matching any template":
  - skip:
      version: " - 7.99.99"
      reason: "simulate index template API has not been backported"
      features: allowed_warnings

  - do:
      allowed_warnings:
        - "index template [test] has index patterns [te*] matching patterns from existing older templates [global] with patterns (global => [*]); this template [test] will take precedence during new index creation"
      indices.put_index_template:
        name: test
        body:
          index_patterns: te*
          priority: 10
          template:
            settings:
              number_of_shards:   1
              number_of_replicas: 0
            mappings:
              properties:
                field:
                  type: keyword

  - do:
      indices.simulate_index_template:
        name: will_not_match

  - match: {body: null}

---
"Simulate index matches overlapping V1 and V2 templates":
  - skip:
      version: " - 7.99.99"
      reason: "simulate index template API has not been backported"
      features: allowed_warnings

  - do:
      indices.put_template:
        name: v1_template
        body:
          index_patterns: [t*, t1*]
          settings:
            number_of_shards:   5

  - do:
      allowed_warnings:
        - "index template [test] has index patterns [te*] matching patterns from existing older templates [v1_template] with patterns
        (v1_template => [t*, t1*]); this template [test] will take precedence during new index creation"
      indices.put_index_template:
        name: test
        body:
          index_patterns: te*
          priority: 10
          template:
            settings:
              number_of_shards:   1
              number_of_replicas: 0
            mappings:
              properties:
                field:
                  type: keyword

  - do:
      indices.simulate_index_template:
        name: test

  - match: {template.settings.index.number_of_shards: "1"}
  - match: {template.settings.index.number_of_replicas: "0"}
  - match: {template.mappings._doc.properties.field.type: "keyword"}
  - match: {overlapping_v1_templates: {v1_template: ["t*", "t1*"]}}
