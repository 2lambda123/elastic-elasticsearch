setup:
  - do:
      indices.put_template:
        name: index_template
        body:
          index_patterns: test-*
          settings:
            number_of_replicas: 0
          mappings:
            user:
              properties:
                row:
                   type: integer
                index_start_at:
                   type: integer
                integer:
                   type: integer
                float:
                   type: float
                name:
                   type: keyword
                surname:
                   type: text
                   fielddata: true
                bool:
                   type: boolean

  - do:
     bulk:
        refresh: true
        body:
          - '{"index": {"_index": "test-0", "_type": "user"}}'
          - '{"row": 1, "index_start_at": 56, "integer": 38, "float": 12.5713, "name": "Ruth", "surname": "Singleton", "bool": true}'
          - '{"index": {"_index": "test-0", "_type": "user"}}'
          - '{"row": 2, "index_start_at": 57, "integer": 42, "float": 15.3393, "name": "Jackie", "surname": "Bowling", "bool": false}'
          - '{"index": {"_index": "test-1", "_type": "user"}}'
          - '{"row": 3, "index_start_at": 58, "integer": 29, "float": 19.0517, "name": "Stephanie", "surname": "Hayes", "bool": true}'
          - '{"index": {"_index": "test-1", "_type": "user"}}'
          - '{"row": 4, "index_start_at": 59, "integer": 19, "float": 19.3717, "name": "Robert", "surname": "Hamilton", "bool": true}'
          - '{"index": {"_index": "test-2", "_type": "user"}}'
          - '{"row": 5, "index_start_at": 60, "integer": 0, "float": 17.3349, "name": "Natalie", "surname": "Marsh", "bool": false}'

---
"Multisearch test with typed_keys parameter":
  - do:
      msearch:
        typed_keys: true
        body:
          - index: test-*
          - {query: {match: {bool: true} }, aggs: {test_filter: {filter: {range:{integer: {gte: 20} } } } } }
          - index: test-1
          - {query: {match_all: {} }, aggs: {test_range: {range: {field: float, ranges: [ {to: 19.2499999}, {from: 19.25} ] } } } }
          - index: test-*
          - {query: {bool: {filter: {range: {row: {lt: 5}}} } }, aggs: {test_percentiles: {percentiles: {field: float} } } }

  - match:    { responses.0.hits.total: 3 }
  - match:    { responses.0.aggregations.filter#test_filter.doc_count : 2 }
  - match:    { responses.1.hits.total: 2 }
  - match:    { responses.1.aggregations.range#test_range.buckets.0.key : "*-19.2499999" }
  - match:    { responses.1.aggregations.range#test_range.buckets.0.doc_count : 1 }
  - match:    { responses.1.aggregations.range#test_range.buckets.1.key : "19.25-*" }
  - match:    { responses.1.aggregations.range#test_range.buckets.1.doc_count : 1 }
  - match:    { responses.2.hits.total: 4 }
  - is_true:  responses.2.aggregations.tdigest_percentiles#test_percentiles.values
