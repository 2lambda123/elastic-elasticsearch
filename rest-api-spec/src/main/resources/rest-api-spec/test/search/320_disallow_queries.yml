---
setup:
  - skip:
      version: " - 7.99.99"
      reason: "implemented in 8.0.0"

  - do:
      indices.create:
        index:  test
        body:
          mappings:
            properties:
              text:
                type: text
                analyzer: standard
              nested1:
                type: nested

  - do:
      bulk:
        refresh: true
        body:
          - '{"index": {"_index": "test", "_id": "1"}}'
          - '{"text" : "Some like it hot, some like it cold", "nested1": [{"foo": "bar1"}]}'
          - '{"index": {"_index": "test", "_id": "2"}}'
          - '{"text" : "Its cold outside, theres no kind of atmosphere", "nested1": [{"foo": "bar2"}]}'
          - '{"index": {"_index": "test", "_id": "3"}}'
          - '{"text" : "Baby its cold there outside", "nested1": [{"foo": "bar3"}]}'
          - '{"index": {"_index": "test", "_id": "4"}}'
          - '{"text" : "Outside it is cold and wet", "nested1": [{"foo": "bar4"}]}'

---
teardown:
  - skip:
      version: " - 7.99.99"
      reason: "implemented in 8.0.0"

  - do:
      cluster.put_settings:
        body:
          transient:
            search.disallow_slow_queries: null

---
"Test disallow slow queries":
  - skip:
      version: " - 7.99.99"
      reason: "implemented in 8.0.0"

  ### Check for initial setting = null -> false
  - do:
      cluster.get_settings:
        flat_settings: true

  - match: {search.disallow_slow_queries: null}

  ### Prefix
  - do:
      search:
        index: test
        body:
          query:
            prefix:
              text:
                value: out

  - match: { hits.total.value: 3 }

  ### Fuzzy
  - do:
      search:
        index: test
        body:
          query:
            fuzzy:
              text:
                value: outwide

  - match: { hits.total.value: 3 }


  ### Regexp
  - do:
      search:
        index: test
        body:
          query:
            regexp:
              text:
                value: .*ou.*id.*

  - match: { hits.total.value: 3 }

  ### Wildcard
  - do:
      search:
        index: test
        body:
          query:
            wildcard:
              text:
                value: out?ide

  - match: { hits.total.value: 3 }

  ### Nested
  - do:
      search:
        index:  test
        body:
          query:
            nested:
              path: "nested1"
              query:
                bool:
                  must: [{"match": {"nested1.foo": "bar2"}}]

  - match: { hits.total.value: 1 }

  ### Update setting to true
  - do:
      cluster.put_settings:
        body:
          transient:
            search.disallow_slow_queries: "true"
        flat_settings: true

  - match: {transient: {search.disallow_slow_queries: "true"}}

  ### Prefix
  - do:
      catch: /prefix queries cannot be executed when \'search.disallow_slow_queries\' is set to true/
      search:
        index: test
        body:
          query:
            prefix:
              text:
                value: out

  ### Fuzzy
  - do:
      catch: /fuzzy queries cannot be executed when \'search.disallow_slow_queries\' is set to true/
      search:
        index: test
        body:
          query:
            fuzzy:
              text:
                value: outwide

  ### Regexp
  - do:
      catch: /regexp queries cannot be executed when \'search.disallow_slow_queries\' is set to true/
      search:
        index: test
        body:
          query:
            regexp:
              text:
                value: .*ou.*id.*

  ### Wildcard
  - do:
      catch: /wildcard queries cannot be executed when \'search.disallow_slow_queries\' is set to true/
      search:
        index: test
        body:
          query:
            wildcard:
              text:
                value: out?ide

  ### Nested
  - do:
      catch: /joining queries cannot be executed when \'search.disallow_slow_queries\' is set to true/
      search:
        index:  test
        body:
          query:
            nested:
              path: "nested1"
              query:
                bool:
                  must: [{"match" : {"nested1.foo" : "bar2"}}]

  ### Revert setting to false
  - do:
      cluster.put_settings:
        body:
          transient:
            search.disallow_slow_queries: "false"
        flat_settings: true

  - match: {transient: {search.disallow_slow_queries: "false"}}

  ### Prefix
  - do:
      search:
        index: test
        body:
          query:
            prefix:
              text:
                value: out

  - match: { hits.total.value: 3 }

  ### Fuzzy
  - do:
      search:
        index: test
        body:
          query:
            fuzzy:
              text:
                value: outwide

  - match: { hits.total.value: 3 }

  ### Regexp
  - do:
      search:
        index: test
        body:
          query:
            regexp:
              text:
                value: .*ou.*id.*

  - match: { hits.total.value: 3 }

  ### Wildcard
  - do:
      search:
        index: test
        body:
          query:
            wildcard:
              text:
                value: out?ide

  - match: { hits.total.value: 3 }

  ### Nested
  - do:
      search:
        index:  test
        body:
          query:
            nested:
              path: "nested1"
              query:
                bool:
                  must: [{"match": {"nested1.foo": "bar2"}}]

  - match: { hits.total.value: 1 }
