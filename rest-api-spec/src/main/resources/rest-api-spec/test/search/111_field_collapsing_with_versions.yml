setup:
  - do:
      indices.create:
        index:  test
        body:
          mappings:
              properties:
                numeric_group: { type: integer }
                tag: { type: keyword }

  - do:
      index:
          index:  test
          id:     1
          version_type: external
          version: 11
          body:   { numeric_group: 1, tag: A, sort: 10 }
  - do:
      index:
          index:  test
          id:     2
          version_type: external
          version: 22
          body:   { numeric_group: 1, tag: B, sort: 6 }
  - do:
      index:
          index:  test
          id:     3
          version_type: external
          version: 33
          body:   { numeric_group: 1, tag: A, sort: 24 }
  - do:
      index:
          index:  test
          id:     4
          version_type: external
          version: 44
          body:   { numeric_group: 25, tag: B, sort: 10 }
  - do:
      index:
          index:  test
          id:     5
          version_type: external
          version: 55
          body:   { numeric_group: 25, tag: A, sort: 5 }
  - do:
      index:
          index:  test
          id:     6
          version_type: external
          version: 66
          body:   { numeric_group: 3, tag: B, sort: 36 }
  - do:
      indices.refresh:
        index: test

---
"field collapsing, inner_hits and version":

  - skip:
      version: " - 6.1.0"
      reason:  "bug fixed in 6.1.1"

  - do:
      count:
        index: test
  - match: {count: 6}

  - do:
      search:
        rest_total_hits_as_int: true
        index: test
        body:
          collapse: { field: numeric_group, inner_hits: { name: sub_hits, version: true, size: 2, sort: [{ sort: asc }] } }
          sort: [{ sort: desc }]
          version: true

  - match: { hits.total: 6 }
  - length: { hits.hits: 3 }
  - match: { hits.hits.0._index: test }
  - match: { hits.hits.0._type: _doc }
  - match: { hits.hits.0.fields.numeric_group: [3] }
  - match: { hits.hits.0.sort: [36] }
  - match: { hits.hits.0._id: "6" }
  - match: { hits.hits.0._version: 66 }
  - match: { hits.hits.0.inner_hits.sub_hits.hits.total: 1 }
  - length: { hits.hits.0.inner_hits.sub_hits.hits.hits: 1 }
  - match: { hits.hits.0.inner_hits.sub_hits.hits.hits.0._id: "6" }
  - match: { hits.hits.0.inner_hits.sub_hits.hits.hits.0._version: 66 }
  - match: { hits.hits.1._index: test }
  - match: { hits.hits.1._type: _doc }
  - match: { hits.hits.1.fields.numeric_group: [1] }
  - match: { hits.hits.1.sort: [24] }
  - match: { hits.hits.1._id: "3" }
  - match: { hits.hits.1._version: 33 }
  - match: { hits.hits.1.inner_hits.sub_hits.hits.total: 3 }
  - length: { hits.hits.1.inner_hits.sub_hits.hits.hits: 2 }
  - match: { hits.hits.1.inner_hits.sub_hits.hits.hits.0._id: "2" }
  - match: { hits.hits.1.inner_hits.sub_hits.hits.hits.0._version: 22 }
  - match: { hits.hits.1.inner_hits.sub_hits.hits.hits.1._id: "1" }
  - match: { hits.hits.1.inner_hits.sub_hits.hits.hits.1._version: 11 }
  - match: { hits.hits.2._index: test }
  - match: { hits.hits.2._type: _doc }
  - match: { hits.hits.2.fields.numeric_group: [25] }
  - match: { hits.hits.2.sort: [10] }
  - match: { hits.hits.2._id: "4" }
  - match: { hits.hits.2._version: 44 }
  - match: { hits.hits.2.inner_hits.sub_hits.hits.total: 2 }
  - length: { hits.hits.2.inner_hits.sub_hits.hits.hits: 2 }
  - match: { hits.hits.2.inner_hits.sub_hits.hits.hits.0._id: "5" }
  - match: { hits.hits.2.inner_hits.sub_hits.hits.hits.0._version: 55 }
  - match: { hits.hits.2.inner_hits.sub_hits.hits.hits.1._id: "4" }
  - match: { hits.hits.2.inner_hits.sub_hits.hits.hits.1._version: 44 }
