setup:
  - skip:
      version: " - 7.99.99"
      reason: "Doc count fields are only implemented in 8.0"
  - do:
      indices.create:
        index: test_1
        body:
          settings:
            number_of_replicas: 0
          mappings:
            properties:
              str:
                type: keyword
              number:
                type: integer
              dc:
                type: doc_count

  - do:
      bulk:
        index: test_1
        refresh: true
        body:
          - '{"index": {}}'
          - '{"dc": 10, "str": "abc", "number" : 500 }'
          - '{"index": {}}'
          - '{"dc": 5, "str": "xyz", "number" : 100 }'
          - '{"index": {}}'
          - '{"dc": 7, "str": "foo", "number" : 100 }'
          - '{"index": {}}'
          - '{"dc": 1, "str": "foo", "number" : 200 }'
          - '{"index": {}}'
          - '{"str": "abc", "number" : 500 }'

---
"Test numeric terms agg with doc_count":
  - skip:
      version: " - 7.99.99"
      reason: "Doc count fields are only implemented in 8.0"

  - do:
      search:
        rest_total_hits_as_int: true
        body: { "size" : 0, "aggs" : { "num_terms" : { "terms" : { "field" : "number" } } } }

  - match: { hits.total: 5 }
  - length: { aggregations.num_terms.buckets: 3 }
  - match: { aggregations.num_terms.buckets.0.key: 100 }
  - match: { aggregations.num_terms.buckets.0.doc_count: 12 }
  - match: { aggregations.num_terms.buckets.1.key: 500 }
  - match: { aggregations.num_terms.buckets.1.doc_count: 11 }
  - match: { aggregations.num_terms.buckets.2.key: 200 }
  - match: { aggregations.num_terms.buckets.2.doc_count: 1 }


---
"Test string terms agg with doc_count":
  - skip:
      version: " - 7.99.99"
      reason: "Doc count fields are only implemented in 8.0"
  - do:
      search:
        rest_total_hits_as_int: true
        body: { "size" : 0, "aggs" : { "str_terms" : { "terms" : { "field" : "str" } } } }

  - match: { hits.total: 5 }
  - length: { aggregations.str_terms.buckets: 3 }
  - match: { aggregations.str_terms.buckets.0.key: "abc" }
  - match: { aggregations.str_terms.buckets.0.doc_count: 11 }
  - match: { aggregations.str_terms.buckets.1.key: "foo" }
  - match: { aggregations.str_terms.buckets.1.doc_count: 8 }
  - match: { aggregations.str_terms.buckets.2.key: "xyz" }
  - match: { aggregations.str_terms.buckets.2.doc_count: 5 }


---
"Multiple doc_count fields from template":
  - skip:
      version: " - 7.99.99"
      reason: "Doc count fields are only implemented in 8.0"

  - do:
      indices.put_template:
        name: test
        body:
          index_patterns: test-*
          settings:
            number_of_shards:   1
            number_of_replicas: 0
          mappings:
            properties:
              str:
                type: keyword
              doc_count:
                type: doc_count

  - do:
      catch: /.*Only one field of type \[doc_count\] is allowed.*/
      indices.create:
        index: test-1
        body:
          mappings:
            properties:
              number:
                type: integer
              another_doc_count:
                type: doc_count
