---
setup:

  - do:
      indices.create:
        index: test
        body:
            settings: { number_of_shards: 1 }
            mappings:
                parent: {}
                child:
                    _parent: { type: parent }
  - do:
        bulk:
            index: test
            body:
                - { index: { _type: "parent", _id: "1" }}
                - { }
                - { index: { _type: "parent", _id: "2" }}
                - { }
                - { index: { _type: "parent", _id: "3" }}
                - { }
                - { index: { _type: "parent", _id: "4" }}
                - { }
                - { index: { _type: "child", _id: "10", _parent: "1" }}
                - { "foo": "one" }
                - { index: { _type: "child", _id: "11", _parent: "2" }}
                - { "foo": "one" }
                - { index: { _type: "child", _id: "12", _parent: "2" }}
                - { "foo": "one two" }
                - { index: { _type: "child", _id: "13", _parent: "3" }}
                - { "foo": "one" }
                - { index: { _type: "child", _id: "14", _parent: "3" }}
                - { "foo": "one two" }
                - { index: { _type: "child", _id: "15", _parent: "3" }}
                - { "foo": "one two three" }
                - { index: { _type: "child", _id: "16", _parent: "4" }}
                - { "foo": "one" }
                - { index: { _type: "child", _id: "17", _parent: "4" }}
                - { "foo": "one two" }
                - { index: { _type: "child", _id: "18", _parent: "4" }}
                - { "foo": "one two three" }
                - { index: { _type: "child", _id: "19", _parent: "4" }}
                - { "foo": "one two three four" }
  - do:
        indices.refresh: {}
---
"has_child_query max":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }
  - match: { hits.total: 3 }
  - match: { hits.hits.0._id: 4 }
  - match: { hits.hits.1._id: 3 }
  - match: { hits.hits.2._id: 2 }

  - match: { hits.hits.0._score: 3 }
  - match: { hits.hits.1._score: 2 }
  - match: { hits.hits.2._score: 1 }

---
"has_child_query max short_circuit":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    short_circuit_cutoff: 1
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }
  - match: { hits.total: 3 }
  - match: { hits.hits.0._id: 4 }
  - match: { hits.hits.1._id: 3 }
  - match: { hits.hits.2._id: 2 }

  - match: { hits.hits.0._score: 3 }
  - match: { hits.hits.1._score: 2 }
  - match: { hits.hits.2._score: 1 }

---
"has_child_query max minimum_children=1":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    minimum_children: 1
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }

  - match: { hits.total: 3 }
  - match: { hits.hits.0._id: 4 }
  - match: { hits.hits.1._id: 3 }
  - match: { hits.hits.2._id: 2 }

  - match: { hits.hits.0._score: 3 }
  - match: { hits.hits.1._score: 2 }
  - match: { hits.hits.2._score: 1 }

---
"has_child_query max minimum_children=2":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    minimum_children: 2
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }

  - match: { hits.total: 2 }
  - match: { hits.hits.0._id: 4 }
  - match: { hits.hits.1._id: 3 }

  - match: { hits.hits.0._score: 3 }
  - match: { hits.hits.1._score: 2 }


---
"has_child_query max minimum_children=3":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    minimum_children: 3
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }

  - match: { hits.total: 1 }
  - match: { hits.hits.0._id: 4 }

  - match: { hits.hits.0._score: 3 }


---
"has_child_query max minimum_children=4":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    minimum_children: 4
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }

  - match: { hits.total: 0 }


---
"has_child_query max short_circuit minimum_children=1":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    minimum_children: 1
                    short_circuit_cutoff: 1
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }

  - match: { hits.total: 3 }
  - match: { hits.hits.0._id: 4 }
  - match: { hits.hits.1._id: 3 }
  - match: { hits.hits.2._id: 2 }

  - match: { hits.hits.0._score: 3 }
  - match: { hits.hits.1._score: 2 }
  - match: { hits.hits.2._score: 1 }

---
"has_child_query max short_circuit minimum_children=2":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    minimum_children: 2
                    short_circuit_cutoff: 1
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }

  - match: { hits.total: 2 }
  - match: { hits.hits.0._id: 4 }
  - match: { hits.hits.1._id: 3 }

  - match: { hits.hits.0._score: 3 }
  - match: { hits.hits.1._score: 2 }


---
"has_child_query max short_circuit minimum_children=3":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    minimum_children: 3
                    short_circuit_cutoff: 1
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }

  - match: { hits.total: 1 }
  - match: { hits.hits.0._id: 4 }

  - match: { hits.hits.0._score: 3 }


---
"has_child_query max short_circuit minimum_children=4":

  - do:
      search:
        index: test
        type:  parent
        body:
            query:
                has_child:
                    type: child
                    score_mode: max
                    minimum_children: 4
                    short_circuit_cutoff: 1
                    query:
                        function_score:
                            query: { term: { foo: two }}
                            boost_mode: replace
                            score_mode: sum
                            functions:
                                - { filter: { match_all: {}}, boost_factor: 1 }
                                - { filter: { term: { foo: three }}, boost_factor: 1 }
                                - { filter: { term: { foo: four }}, boost_factor: 1 }

  - match: { hits.total: 0 }


