---
setup:

  - do:
      indices.create:
        index: test
        body:
            settings: { number_of_shards: 1 }
            mappings:
                parent:
                    _id: { index: "not_analyzed" }
                child:
                    _parent: { type: parent }
  - do:
        bulk:
            index: test
            body:
                - { index: { _type: "parent", _id: "1" }}
                - { }
                - { index: { _type: "parent", _id: "2" }}
                - { }
                - { index: { _type: "parent", _id: "3" }}
                - { }
                - { index: { _type: "parent", _id: "4" }}
                - { }
                - { index: { _type: "child", _id: "10", _parent: "1" }}
                - { "foo": "one" }
                - { index: { _type: "child", _id: "11", _parent: "2" }}
                - { "foo": "one" }
                - { index: { _type: "child", _id: "12", _parent: "2" }}
                - { "foo": "one two" }
                - { index: { _type: "child", _id: "13", _parent: "3" }}
                - { "foo": "one" }
                - { index: { _type: "child", _id: "14", _parent: "3" }}
                - { "foo": "one two" }
                - { index: { _type: "child", _id: "15", _parent: "3" }}
                - { "foo": "one two three" }
                - { index: { _type: "child", _id: "16", _parent: "4" }}
                - { "foo": "one" }
                - { index: { _type: "child", _id: "17", _parent: "4" }}
                - { "foo": "one two" }
                - { index: { _type: "child", _id: "18", _parent: "4" }}
                - { "foo": "one two three" }
                - { index: { _type: "child", _id: "19", _parent: "4" }}
                - { "foo": "one two three four" }
  - do:
        indices.refresh: {}
---
"has_child_query none":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    query:
                        term:
                            foo: two
  - match: { hits.total: 3 }
  - match: { hits.hits.0._id: 2 }
  - match: { hits.hits.1._id: 3 }
  - match: { hits.hits.2._id: 4 }

---
"has_child_query none short_circuit":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    short_circuit_cutoff: 1
                    query:
                        term:
                            foo: two

  - match: { hits.total: 3 }
  - match: { hits.hits.0._id: 2 }
  - match: { hits.hits.1._id: 3 }
  - match: { hits.hits.2._id: 4 }

---
"has_child_query none minimum_children=1":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    minimum_children: 1
                    query:
                        term:
                            foo: two

  - match: { hits.total: 3 }
  - match: { hits.hits.0._id: 2 }
  - match: { hits.hits.1._id: 3 }
  - match: { hits.hits.2._id: 4 }

---
"has_child_query none minimum_children=2":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    minimum_children: 2
                    query:
                        term:
                            foo: two

  - match: { hits.total: 2 }
  - match: { hits.hits.0._id: 3 }
  - match: { hits.hits.1._id: 4 }


---
"has_child_query none minimum_children=3":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    minimum_children: 3
                    query:
                        term:
                            foo: two

  - match: { hits.total: 1 }
  - match: { hits.hits.0._id: 4 }


---
"has_child_query none minimum_children=4":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    minimum_children: 4
                    query:
                        term:
                            foo: two

  - match: { hits.total: 0 }


---
"has_child_query none short_circuit minimum_children=1":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    minimum_children: 1
                    short_circuit_cutoff: 1
                    query:
                        term:
                            foo: two

  - match: { hits.total: 3 }
  - match: { hits.hits.0._id: 2 }
  - match: { hits.hits.1._id: 3 }
  - match: { hits.hits.2._id: 4 }

---
"has_child_query none short_circuit minimum_children=2":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    minimum_children: 2
                    short_circuit_cutoff: 1
                    query:
                        term:
                            foo: two

  - match: { hits.total: 2 }
  - match: { hits.hits.0._id: 3 }
  - match: { hits.hits.1._id: 4 }


---
"has_child_query none short_circuit minimum_children=3":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    minimum_children: 3
                    short_circuit_cutoff: 1
                    query:
                        term:
                            foo: two

  - match: { hits.total: 1 }
  - match: { hits.hits.0._id: 4 }


---
"has_child_query none short_circuit minimum_children=4":

  - do:
      search:
        index: test
        type:  parent
        sort:  _id
        body:
            query:
                has_child:
                    type: child
                    minimum_children: 4
                    short_circuit_cutoff: 1
                    query:
                        term:
                            foo: two

  - match: { hits.total: 0 }


